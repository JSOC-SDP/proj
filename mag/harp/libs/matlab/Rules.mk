# MUST FIRST MAKE UTIL LIBS, THEN MEX2C LIBS. MAKE A DEPENDENCY OF MEX2C ON UTIL. It uses mexhead.h generated by UTIL.
# Standard things                                                                                             
sp              := $(sp).x
dirstack_$(sp)  := $(d)
d               := $(dir)

# OUTDIR is the root directory that contains all make-generated binary files
# PDIR is the sub-directory of OUTDIR that is the parent 
OUTDIR		:= $(WORKINGDIR)/_$(MACH)
PSDIR		:= $(d)

# Set the MEXEXT variable used in the lower-level make files
ifeq ($(JSOC_MACHINE), linux_x86_64) 
  MEXEXT := mexa64
else
  MEXECT := mexa32
endif

# Util libraries
UTILSDIR	:= mex/src/util
CSDIRUTIL	:= $(PSDIR)/$(UTILSDIR)
LIBEXRNG	:= $(OUTDIR)/$(PSDIR)/$(UTILSDIR)/libmexrng.a
LIBMEXTOOLS	:= $(OUTDIR)/$(PSDIR)/$(UTILSDIR)/libmextoolsMW.a
METAHEADER	:= $(OUTDIR)/$(PSDIR)/$(UTILSDIR)/mexhead.h

SUTIL_$(d)		:= $(notdir $(LIBEXRNG) $(LIBMEXTOOLS) $(METAHEADER))
S1UTIL_$(d)		:= $(addprefix $(PSDIR)/$(UTILSDIR)/, $(SUTIL_$(d)))

$(LIBEXRNG) $(LIBMEXTOOLS) $(METAHEADER):
	$(MAKE) -C $(WORKINGDIR)/$(PSDIR)/$(UTILSDIR) OUTDIR=$(OUTDIR) CSDIR=$(CSDIRUTIL) MEXEXT=$(MEXEXT) $@

.PHONY:	$(SUTIL_$(d))
$(SUTIL_$(d)):	%:	$(OUTDIR)/$(PSDIR)/$(UTILSDIR)/%

.PHONY:	$(S1UTIL_$(d))
$(S1UTIL_$(d)):	%:	$(OUTDIR)/%


# mex2c libraries

# Don't even try to re-use variables in the 'recipes' - make will have problems. 
# I tried re-using CSDIR, and apparently that will cause the value of $(CSDIR) on 
# line 23 to change, even though line 23 comes before line 36. 
MEX2CSDIR	:= mex/src/mex2c
CSDIRMEX2C	:= $(PSDIR)/$(MEX2CSDIR)
LIBMEX2C	:= $(OUTDIR)/$(PSDIR)/$(MEX2CSDIR)/libmex2c_lib.a
LIBMEX2MATL	:= $(OUTDIR)/$(PSDIR)/$(MEX2CSDIR)/libmex2matl.a

SMEX2C_$(d)		:= $(notdir $(LIBMEX2C) $(LIBMEX2MATL))
S1MEX2C_$(d)		:= $(addprefix $(PSDIR)/$(MEX2CSDIR)/, $(SMEX2C_$(d)))

# Don't rely upon $(PWD) to tell you make's current working directory. It lies! Instead of trying 
# to come up with a path relative to where you think make is, just avoid relative paths altogether.
$(LIBMEX2C) $(LIBMEX2MATL):
	$(MAKE) -C $(WORKINGDIR)/$(PSDIR)/$(MEX2CSDIR) OUTDIR=$(OUTDIR) CSDIR=$(CSDIRMEX2C) MEXEXT=$(MEXEXT) $@

.PHONY:	$(SMEX2C_$(d))
$(SMEX2C_$(d)):	%:	$(OUTDIR)/$(PSDIR)/$(MEX2CSDIR)/%

.PHONY:	$(S1MEX2C_$(d))
$(S1MEX2C_$(d)):	%:	$(OUTDIR)/%

# mfile-mex dir libraries and files

MFILEMEXDIR	:= mfile-mex

# standalone libraries
CSDIRSTANDALONE	:= $(PSDIR)/$(MFILEMEXDIR)/standalone
MEXSTANDALONE	:= mexstandalone

# generate the dynamic libraries, used by matlab
SASRC 		:= $(shell egrep -l '^mexFunction' `find $(WORKINGDIR)/$(CSDIRSTANDALONE) -maxdepth 1 -name '*.c'` /dev/null;  exit 0)
SAMEXFILES	:= $(addprefix $(OUTDIR)/$(CSDIRSTANDALONE)/, $(notdir $(SASRC:%.c=%.$(MEXEXT))))

SSAMEXFILES_$(d)	:= $(notdir $(SAMEXFILES))
S1SAMEXFILES_$(d)	:= $(addprefix $(CSDIRSTANDALONE)/, $(SSAMEXFILES_$(d)))

# combine $(SAMEXFILES) with the rule for $(MEXSTANDALONE)

$(SAMEXFILES) $(MEXSTANDALONE):
	$(MAKE) -C $(WORKINGDIR)/$(CSDIRSTANDALONE) OUTDIR=$(OUTDIR) CSDIR=$(CSDIRSTANDALONE) MEXEXT=$(MEXEXT) $@


.PHONY: $(SSAMEXFILES_$(d))
$(SSAMEXFILES_$(d)):	%:	$(OUTDIR)/$(CSDIRSTANDALONE)/%

.PHONY:	$(S1SAMEXFILES_$(d))
$(S1SAMEXFILES_$(d)):	%:	$(OUTDIR)/%

# assignment libraries
CSDIRASSIGN	:= $(PSDIR)/$(MFILEMEXDIR)/assignment
MEXASSIGN	:= mexassign

ASSRC		:= $(shell egrep -l '^mexFunction' `find $(WORKINGDIR)/$(CSDIRASSIGN) -maxdepth 1 -name '*.c'` /dev/null;  exit 0)
ASMEXFILES	:= $(addprefix $(OUTDIR)/$(CSDIRASSIGN)/, $(notdir $(ASSRC:%.c=%.$(MEXEXT))))

SASMEXFILES_$(d)	:= $(notdir $(ASMEXFILES))
S1ASMEXFILES_$(d)	:= $(addprefix $(CSDIRASSIGN)/, $(SASMEXFILES_$(d)))

$(ASMEXFILES) $(MEXASSIGN):
	$(MAKE) -C $(WORKINGDIR)/$(CSDIRASSIGN) OUTDIR=$(OUTDIR) CSDIR=$(CSDIRASSIGN) MEXEXT=$(MEXEXT) $@

.PHONY:	$(SASMEXFILES_$(d))
$(SASMEXFILES_$(d)):	%:	$(OUTDIR)/$(CSDIRASSIGN)/%

.PHONY: $(S1ASMEXFILES_$(d))
$(S1ASMEXFILES_$(d)):	%:	$(OUTDIR)/%

# fits libraries
CSDIRFITS	:= $(PSDIR)/$(MFILEMEXDIR)/fits
MEXFITS		:= mexfits

FTSRC		:= $(shell egrep -l '^mexFunction' `find $(WORKINGDIR)/$(CSDIRFITS) -maxdepth 1 -name '*.c'` /dev/null;  exit 0)
FTMEXFILES	:= $(addprefix $(OUTDIR)/$(CSDIRFITS)/, $(notdir $(FTSRC:%.c=%.$(MEXEXT))))

SFTMEXFILES_$(d)	:= $(notdir $(FTMEXFILES))
S1FTMEXFILES_$(d)	:= $(addprefix $(CSDIRFITS)/, $(SFTMEXFILES_$(d)))

$(FTMEXFILES) $(MEXFITS):
	$(MAKE) -C $(WORKINGDIR)/$(CSDIRFITS) OUTDIR=$(OUTDIR) CSDIR=$(CSDIRFITS) MEXEXT=$(MEXEXT) $@

.PHONY:	$(SFTMEXFILES_$(d))
$(SFTMEXFILES_$(d)):	%:	$(OUTDIR)/$(CSDIRFITS)/%

.PHONY: $(S1FTMEXFILES_$(d))
$(S1FTMEXFILES_$(d)):	%:	$(OUTDIR)/%

# hmi-mask-path libraries
CSDIRHMIMASK	:= $(PSDIR)/$(MFILEMEXDIR)/hmi-mask-patch
MEXHMIMASK	:= mexhmimask

HMSRC		:= $(shell egrep -l '^mexFunction' `find $(WORKINGDIR)/$(CSDIRHMIMASK) -maxdepth 1 -name '*.c'` /dev/null;  exit 0)
HMMEXFILES	:= $(addprefix $(OUTDIR)/$(CSDIRHMIMASK)/, $(notdir $(HMSRC:%.c=%.$(MEXEXT))))

SHMMEXFILES_$(d)	:= $(notdir $(HMMEXFILES))
S1HMMEXFILES_$(d)	:= $(addprefix $(CSDIRHMIMASK)/, SHMMEXFILES_$(d))

$(HMMEXFILES) $(MEXHMIMASK):
	$(MAKE) -C $(WORKINGDIR)/$(CSDIRHMIMASK) OUTDIR=$(OUTDIR) CSDIR=$(CSDIRHMIMASK) MEXEXT=$(MEXEXT) $@

.PHONY: $(SHMMEXFILES_$(d))
$(SHMMEXFILES_$(d)):	%:	$(OUTDIR)/$(CSDIRHMIMASK)/%

.PHONY: $(S1HMMEXFILES_$(d))
$(S1HMMEXFILES_$(d)):	%:	$(OUTDIR)/%

TGT_LIB         := $(TGT_LIB) $(LIBMEX2MATL) $(LIBMEX2C) $(LIBEXRNG) $(LIBMEXTOOLS) $(METAHEADER) $(MEXSTANDALONE) $(MEXASSIGN) $(MEXFITS) $(MEXHMIMASK)

# Standard things                                                                
-include        $(DEP_$(d))

d               := $(dirstack_$(sp))
sp              := $(basename $(sp))
