<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; CHARSET=iso-8859-1">
<TITLE>JSOC Export Data</TITLE>
<SCRIPT TYPE="text/javascript" SRC="js/prototype-1.6.0.3.js"></SCRIPT>
<SCRIPT TYPE="text/javascript" SRC="js/cookies.js"></SCRIPT>
<SCRIPT TYPE="text/javascript" SRC="js/prototip.js"></SCRIPT>
<link rel="stylesheet" type="text/css" href="css/prototip.css" ></link>

<!-- Add functions for export processing options, section 1 of 7 -->
<SCRIPT TYPE="text/javascript" SRC="exportdata.d/processing.js"></SCRIPT>
<!-- Add functions for export protocol options, section 1 of X -->
<SCRIPT TYPE="text/javascript" SRC="exportdata.d/protocols.js"></SCRIPT>

<HEAD>

<style type="text/css">

#body { margin:0; padding:0; }
#header { position:relative; top:0; left:0; width:100%; background:#eee; }
#footer { position:fixed; bottom:0; left:0; width:100%; background:#eee; }
#ExportRecordSet { width:40em; font-size:100%; }
span.tip { background-color:blue;font-family:verdana;color:white;font-size:1em;font-weight:bold;}
.prototip { font:0.8em Arial, Helvetica, sans-serif; }
</style>

<script type="text/javascript">

// Global variables and initialize page locations

// To make a test version of exportdata.html...
// 1. Use these values for 4 global variables:
//    var SHOW_SERIES = "show_series_test";
//    var JSOC_INFO = "jsoc_info_test";
//    var JSOC_FETCH = "jsoc_fetch_test";
//    var EXPORTDATA = "exportdatatest";
// 2. In the function GetExport(), make sure that the last two lines of the exportparameters hash are:
// "protocol" : protocolparam,                                      
// "t" : 1} ); 
//
// Setting t to 1 will cause jsoc_fetch to run in "test" mode. It will set all new export request's status fields to 12,
// where a "test" mode jsoc_export_manage will find only records with status == 12. You need to run 
// jsoc_export_manage with the -t flag to make it run in test mode.

// Set CGI-BIN targets

var SHOW_SERIES = "show_series_test";
var JSOC_INFO = "jsoc_info_test";
var JSOC_FETCH = "jsoc_fetch_test";
var EXPORTDATA = "exportdatatest";

// var SHOW_SERIES = "show_series";
// var JSOC_INFO = "jsoc_info";
// var JSOC_FETCH = "jsoc_fetch";
// var EXPORTDATA = "exportdata";

// Protect page from accidental BACK button
window.onbeforeunload = function () 
  {
  return "Did you really mean to leave exportdata? Use CANCEL to stay here";
  }

var Host = location.host;
var Internal = 0;
var SeriesName;
var SeriesInfo;
var RequestID;
var RecordLimit;
var RecordCount;
var ExportRecordSetOK;
var ExportFromFileList;
var ExportProtocolOK;
var ExportCompressOK;
var ExportMethodOK;
var ExportFilenameFmtOK;
var ExportProcessingOK;
var ExportUserOK;
var ExportNotifyOK;
var ExportReadyOK;
var TipsEnabled;
var TipsCreated = 0;
var args;
var state=0;
var uploadOndoneAction = 0;
var ExportProcessingArgs = "";

// Processing options code section 2 of 7
// Processing specific control variables
var HgPatchActive = 0;
var HgSeriesList;
var HgSeriesSelected = 0;
var HgTracked = 0;
var ProtocolOptionsSet = 0;

function OnEnterKey(evt,action)
  {
  var keynum;
  var keychar;
  if(window.event) // IE
    keynum = evt.keyCode;
  else if(evt.which) // Netscape/Firefox/Opera
    keynum = evt.which;
  if(keynum == 13)
    action();
  keychar = String.fromCharCode(keynum);
  return keychar;
  }

function NotifyProcessingCode()
  {
  // called when RecordSet is changed.
  // Set flags to alert processing or method options here.
  HgSeriesSelected = 0;
  }

// End of processing options section

function initVars()
  {
  Host = location.host;
  if (Host == "jsoc2.stanford.edu")
    Internal = 1;
  else
    Internal = 0;
  SeriesName = "";
  RequestID = "";
  RecordCount = 0;
  RecordLimit = 0;
  ExportRecordSetOK = 0;
  ExportFromFileList = 0;
  ExportProtocolOK = 0;
  ExportCompressOK = 1;
  ExportMethodOK = 0;
  ExportMethodIsDirect = 0;
  ExportFilenameFmtOK = 0;
  ExportProcessingOK = 0;
  ExportUserOK = 0;
  ExportNotifyOK = 2;
  ExportReadyOK = 0;
  TipsEnabled = 1;
  uploadOndoneAction = 0;
  ExportProcessingArgs = "";

  // if (state < 2)
    {
    $("ExportRequestor").value = "";
    $("ExportProcessing").value = "no_op";
    $("ExportNotify").value = "solarmail";
    $("RequestIdPlace").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
    $("StatusLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
    $("TarFileLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
    $("ExportStatus").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
    $("StatusDataLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
    $("ExportRecordSet").value = "";
    $("ExportProtocol").value = "as-is";
    $("ExportProtocolHidden").value = "as-is";
    $("ExportCompress").value = "compress Rice";
    $("ExportProcessingHidden").value = "no_op";
    $("ExportMethod").value = "url_quick";
    $("ExportFilenameFmt").value = "{seriesname}.{recnum:%lld}.{segment}";
    $("ExportButton").value = "Submit Export Request";
    $("ExportButtonMsg").innerHTML = "Please only click once for export request.";
    $("ExportButton").style.backgroundColor = "#D8D8D8";
    $("RecordSetRow").style.display="table-row";
    $("RecordCountRow").style.display="table-row";
    $("ProcessRow").style.display="none";
    $("ProtocolRow").style.display="none";
    $("CompressRow").style.display="none";
    $("FilenameFmtRow").style.display="none";
    $("RequestorRow").style.display="none";
    $("NotifyRow").style.display="none";
    $("FileUploadCheckbox").checked = 0;
    $("ExportOpID").value = "exp_request";
    $("ReRequestID").value = "";
    $("ReExportDiv").style.display = "none";
    $("TarFileLocationRow").style.display = "none";
    $("KeywordFileLocationRow").style.display = "none";

    // Processing options code section 3 of 7
    // Init/clear display options
    ProcessingInit();
    // End of processing options section

    // Protocol options code section 3 of X
    // Init/clear display options
    ProtocolOptionsInit();
    // End of processing options section
    }
  FileUploadCleanup();
  }

function getargs()
  {
  state = Cookie.getData("state");
  $("ExportRequestor").value = Cookie.getData("user");
  if ($("ExportRequestor").value == "undefined")
    $("ExportRequestor").value = "";
  if (state == 1)
    {
    var exportargs = Cookie.data["search"];
    if (exportargs != undefined)
      {
      exportargs = decodeURIComponent(exportargs);
      exportargs = exportargs.substr(1);
      exportargs = exportargs.replace(/\?/g,"QUESTIONMARK");
      args = exportargs.toQueryParams();
      if (args.ds == undefined)
        args.ds = "";
      args.ds = args.ds.replace(/QUESTIONMARK/g, "?");
      }
    else
      {
      args = new Object;
      args.ds = "";
      }
    }
  else if (state > 1)
    {
    args = new Object;
    args.ds = "";
    args.requestid = "";
    args.limit= "none";
    }
  else
    {
    var exportargs = location.search;
    exportargs = decodeURIComponent(exportargs);
    exportargs = exportargs.substr(1);
    exportargs = exportargs.replace(/\?/g,"QUESTIONMARK");
    args = exportargs.toQueryParams();
    if (args.ds == undefined)
      args.ds = "";
    args.ds = args.ds.replace(/QUESTIONMARK/g, "?");
    state=1;
    Cookie.setData("state",state);
    Cookie.setData("search",location.search);
    Cookie.setData("user", $("ExportRequestor").value);
    }
  return args;
  }

function OnLoadInit()
  {
  var needcount = 0;
  Cookie.init({name:EXPORTDATA, expires:5});
  initVars();
  state = 0;
  Cookie.setData("state",state);
  args = getargs();
  if (args.ds)
    {
    $("ExportRecordSet").value = args.ds;
    needcount = 1;
    }
  if (args.id)
    {
    RequestID = args.id;
    }
  if (args.limit) 
    {
    $("ExportRecordLimit").value = args.limit;
    if (args.limit == "none") RecordLimit = 0;
    else RecordLimit = args.limit;
    }
  if (needcount && $("ExportRecordSet").value != "")
    {
    GetRSCount();
    GetDefaultFormat();
    }
  if (Internal)
    $("RequestorMessage").innerHTML = "Provide an identifier for you, e.g. your SolarMail name. Required for jsoc2";
  // HELP tips enable
  CreateTips();
  $("TipsOnOffButton").value = "Turn Help Off";
  window.focus();
  }

function ReInitPage()
  {
  Cookie.setData("state",0);
  OnLoadInit();
  }

function MainTips(tipstyle)
  {
  if (TipsCreated == 0)
    {
    new Tip('RecordFromFileHelp','Allows user to provide a RecordSet list in a file.  ' +
        'The file should contain recordSet specifiers in the format allowed by drms_open_records include files.  ' +
        'See http://jsoc.stanford.edu/jsocwiki/AllAboutJsocNames.',tipstyle);
    new Tip('RecordSetHelp','RecordSet to be exported. May be imported on call and/or may be entered directly here. ' +
        'May be filled in by series select in Hg_patch processing option.',tipstyle);
    new Tip('RecordLimitHelp','RecordSet record limit. Max number of records to export.  Modifies RecordSet. ' +
        'Value should be "none" or a number. Number > 0 counts from start of RecordSet.  Negative number counts ' +
        'from high end of RecordSet.  0 means no limit',tipstyle);
    new Tip('RecordCountHelp','RecordSet record count.  Update this to repeat export with new method, email, etc.  ' +
        'There is presently a limit to the memory space allocated for record queries which restricts AIA lev1 ' +
        'requests to about 15,000 records and HMI X_45s or X_720s data to about 32,000 records.  ' +
        'The limit depends on number of keywords in each record.  This limit will be eased in the future.',tipstyle);
    new Tip('ProcessingHelp','Processing to be done to the data prior to export.  Select from drop-down list for details.',tipstyle);
    new Tip('ProtocolHelp','Data storage protocol for data files to be fetched.  ' +
        '"Fits" causes the data to be converted to full fits files with header information filled from the DRMS records.  ' +
        '"As-is" leaves the data as it is used inside the JSOC DRMS routines, with the header metadata stored in the database ' +
        'rather than with the data file.  "As-is" is faster since the data does not need to be rewritten. The "jpeg" option will ' +
        ' yield  jpeg images of the data with a pre-determined scaling and colortable and the "mpg" option will ' +
        ' yield a movie in mp4 format along with the jpeg images that make up the frames in the movie.',tipstyle);
    new Tip('CompressHelp','Compression parameters to be used by the cfitsio library.  ' +
        'Provide up to one comma separated string for each segment name in your export.  ' +
        'Use "**NONE**" to indicate uncompressed FITS files desired.  If more segments are to be exported than strings are provided, ' +
        'then the last string will be used repeatedly as needed.  ' +
        'If this parameter is empty, the exported FITS file will have the same compression parameters as the original DRMS ' +
        'series segment as specified in the JSD for that series.  ' +
        'Advice: use **NONE** to ensure uncompressed.  See lookdata.html for the "cparms_sg###" keyword for the default.',tipstyle);
    new Tip('MethodHelp','Handshake method to be used in the process of doing the export and to fetch the data files. ' +
        '"url-quick" is the fastest but can only be used if the data is online and will be exported "as-is". ' +
        '"url-direct" is has the constraints of url_quick with the limit of one file per request but it will ' +
        'automatically do the postprocessing specified in the "protocol" instruction. For "url_direct" the file ' +
        'is returned directly to your browser rather than returning to the export page.  If you have the ' +
        'set to load some fits reader program when the mime-ype "fits" is encountered you will see the image promptly. ' +
        '"url" will result in a temporary directory being created and the URL to that directory be returned to you after ' +
        'a handshake process using the RequestID provided. ' +
        '"ftp" is like "url" but the returned links will be to an ftp directory. ' +
        ' A "-tar" suffix will cause a tar of all files in the request to be included with the separate files. ' +
        'NOTE: do not use "-tar" unless you really need it since that will generate an extra copy of the data.',tipstyle);
    new Tip('FilenameFmtHelp','Filename format to be used in the process of doing the export.  ' +
        'The filename format is a template used to construct a filename for each segment of each record requested.  ' +
        'The template consists of literal characters and substitution tokens enclosed in "{}".  ' +
        'The special words: seriesname, recnum, and segment are replaced with the series_name, the record number, ' +
        'or the segment name.  The element {#} will generate an increasing number, ' +
        'with optional layout e.g. default is {#:%05d}. ' +
        'Any keyword in the record may also be used.  Optional layout may be provided after a ":".' +
        'Special format options are available for type TIME keywords: A leading "A" will strip "." and ":" from the time and ' +
        'a "D" will strip the "." and ":" but will insert "@" around the date components to allow easy scripts to move the exported ' +
        'files into date structured directory trees. ' +
        'It is wise to include enough of the "prime-keys" to make a unique filename.  ' +
        'The default format template is made from series structure.',tipstyle);
    new Tip('RequestorHelp','Optional place for your name, this will be used later when we have a way of saving your ' +
        'preferred export options.',tipstyle);
    new Tip('NotifyHelp','Optional email address to be used to notify you when the export is complete and ready to be ' +
        'fetched using the RequestID.',tipstyle);
    new Tip('SendFileHelp','This action will submit the export request with the RecordSet specified in the upload file.',tipstyle);
    }
  };

// section 4 of 7 for add-on code sections.  No changes needed here but add tips to addOnTips.js
</SCRIPT>
<SCRIPT TYPE="text/javascript" SRC="exportdata.d/addOnTips.js"></SCRIPT>
<SCRIPT TYPE="text/javascript">

function CreateTips()
  {
  var tipstyle =
    {
    style:'protoblue',
    hook:{target:'topRight',tip:'bottomLeft'},
    stem:'bottomLeft',
    closeButton:false,
    hideAfter:5,
    hideOn:'click',
    showOn:'click',
    border:3,
    radius:3,
    width:300,
    };

  MainTips(tipstyle);
  AddOnTips(tipstyle, Tip);
  TipsCreated = 1;
  $$("span.tip").each(function(showspan){showspan.show();}); 
  }

function HideTips()
  {
  $$("span.tip").each(function(hidespan){hidespan.hide();}); 
  Tips.hideAll();
  }

function ToggleHelp()
  {
  if (TipsEnabled)
    {
    HideTips();
    $("TipsOnOffButton").value = "Turn Help On";
    TipsEnabled = 0;
    }
  else
    {
    CreateTips();
    $("TipsOnOffButton").value = "Turn Help Off";
    TipsEnabled = 1;
    }
  }

function FileUploadCleanup()
  {
  $("ExportRecordSet").value = "";
  ExportRecordSetOK = 0;
  ExportFromFileList = 0;
  $("FileUploadCheckbox").checked = 0;
  $("RSCountPlace").innerHTML = "";
  $("ExportButton").value = "Submit Export Request";
  $("AjaxExportRequestRow").style.display="table-row";
  $("FileUploadInfoRow").style.display="none";
  $("RecordSetRow").style.display="table-row";
  $("RecordCountRow").style.display="table-row";
  $("ExportOpID").value = "exp_request";
  }
  
function FileUploadWanted()
  {
  if (ExportFromFileList == 0)
    {
    $("ExportRecordSet").value = "*file*";
    ExportRecordSetOK = 1;
    ExportFromFileList = 1;
    $("FileUploadCheckbox").checked = 1;
    $("RecordSetRow").style.display="none";
    $("RecordCountRow").style.display="none";
    $("ExportOpID").value = "exp_request";
    $("FileUploadRow").style.display="table-row";
    $("FileUploadInfoRow").style.display="none";
    $("AjaxExportRequestRow").style.display="none";
    }
  else
    {
    $("FileUploadInfoRow").style.display="none";
    FileUploadCleanup();
    FinishFileUpload();
    }
  }

function insertOption(list,text,note)
  {
  var y=document.createElement('option');
  y.value=text;
  if (note.length)
    y.text = text + "  --- " + note;
  else
    y.text = text;
  var x = $(list);
  try
    {
    x.add(y,null); // standards compliant
    }
  catch(ex)
    {
    x.add(y); // IE only
    }
  }

function MakeFileUploadRequest()
  {
  if (CheckExportParams() == 0)
    return;
  uploadOndoneAction = 1;
// XXXX fix compression here
  $("FileUploadFormID").action = 'http://' + Host + '/cgi-bin/ajax/' + JSOC_FETCH;
  $("FileUploadFormID").submit();
  }

function uploadDone()
  { //Function will be called when iframe is loaded
  if (uploadOndoneAction == 1)
    {
    var response = window.frames[0].document.getElementsByTagName("body")[0].innerHTML;
    var status = ProcessExportResponse(response);
    var op = "exp_upload";
    uploadOndoneAction = 0;
    }
  }

function FinishFileUpload()
  {
  window.frames[0].document.getElementsByTagName("body")[0].innerHTML = "";
  $("FileUploadRow").style.display="none";
  uploadOndoneAction = 0;
  }

function GetSeriesList(filter)
  {
  var SeriesList;
  var GetSeriesObject = new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + SHOW_SERIES,
    {
    method: 'get',
    parameters: {"filter" : filter },
    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no series";
      SeriesList = response.evalJSON();
      },
    onFailure: function() { alert('Something went wrong...'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  return(SeriesList);
  }

function GetRSCount()
  {
  var posbracket = $("ExportRecordSet").value.indexOf("[");
  var posRbracket = $("ExportRecordSet").value.lastIndexOf("]");
  if (posbracket == -1)
    {
    Seriesname = $("ExportRecordSet").value;
    if (posRbracket == -1)
      {
      if (RecordLimit == 0)
        $("ExportRecordSet").value = $("ExportRecordSet").value + '[$]';
      }
    else
      {
      $("RSCountPlace").innerHTML = "ERROR - missing left bracket - [";
      return;
      }
    }
  posbracket = $("ExportRecordSet").value.indexOf("[");
  SeriesName = $("ExportRecordSet").value.substr(0,posbracket);
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  $("RSCountPlace").innerHTML = "Getting count - wait...";
  RecordCount = -1;
  var RecordSet = $("ExportRecordSet").value;
  new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_INFO,
    {
    method: 'get',
    parameters: {"ds" : RecordSet, "op" : "rs_summary", "n" : RecordLimit },

    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no response text";
      var data = response.evalJSON();
      if (data.status != 0)
        {
	RecordCount = 0;
        $("RSCountPlace").innerHTML = "No RecordSet Count Found";
        }
      else
	{ 
	RecordCount = data.count;
	$("RSCountPlace").innerHTML = data.count;
	}
      ExportReadyOK = 0;
      ExportRecordSetOK = 1;
      $("ExportButtonMsg").innerHTML = "Please only click once for export request.";
      $("ExportButton").value = "Submit Export Request";
      $("ExportButton").style.backgroundColor = "#D8D8D8";
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      var op = "rs_summary";
      },
    onFailure: function() { alert('Something went wrong...'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  }

function GetDefaultFormat()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  $("RSCountPlace").innerHTML = "Getting count - wait...";
  RecordCount = -1;
  var RecordSet = $("ExportRecordSet").value;
  new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_INFO,
    {
    method: 'get',
    parameters: {"ds" : RecordSet, "op" : "series_struct" },

    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no response text";
      SeriesInfo = response.evalJSON();
      if (SeriesInfo.status == 0)
        {
        var nprimes = SeriesInfo.primekeysinfo.length;
        var nkeys = SeriesInfo.keywords.length;
        if (nprimes == 0)
          {
          $("ExportFilenameFmt").value = SeriesName + ".{recnum:%lld}.{segment}";
          }
        else
          {
          var newfmt = SeriesName + ".";
          var i;
          for (i=0; i<nprimes; i++)
            {
            var thisprime = SeriesInfo.primekeys[i];
            var j;
            for  (j=0; j<nkeys; j++)
              {
              var thiskey = SeriesInfo.keywords[j].name;
              if (thiskey === thisprime)
                {
                if (SeriesInfo.keywords[j].type === "time")
                  newfmt = newfmt + "{" + thisprime + ":A}.";
                else
                  newfmt = newfmt + "{" + thisprime + "}.";
                break;
                }
              }
            }
	  newfmt = newfmt + "{segment}";
          $("ExportFilenameFmt").value = newfmt;
          }
	}
      else
        alert("failed to get series info for " + RecordSet + "\nEnter correct RecordSet or proceed to processing options");
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      },
    onFailure: function() { alert('Something went wrong...'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  }

var expURL;
function CreateDataTable(data, valuetable)
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  valuetable = "";
  // var count = data.count;
  var count = data.data.length;
  valuetable = "<TABLE BORDER=1>"
  valuetable = valuetable + "<TR><TD>File</TD><TD>Record</TD><TD>Filename</TD></TR>"
  for (ifile=0; ifile < count; ifile++)
    {
    valuetable = valuetable + "<TR>";
    valuetable = valuetable +  "<TD>" + (ifile + 1) + "</TD>";
    valuetable = valuetable +  "<TD>" + data.data[ifile].record + "</TD>";
    thisfile = data.data[ifile].filename;
    if (data.method.indexOf("tar") > 0)
      valuetable = valuetable +  "<TD>" + thisfile + "</TD></TR>";
    else
      {
      if (data.method.indexOf("ftp") >= 0)
        expURL = "ftp://pail.stanford.edu/export" + data.dir + "/" + thisfile;
      else
        expURL = "http://jsoc.stanford.edu" + data.dir + "/" + thisfile;
      tmp = "<A href='" + expURL + "' target='_blank'>" + thisfile + "</A>";
      valuetable = valuetable +  "<TD>" + tmp + "</TD></TR>";
      }
    }
  valuetable = valuetable + "</TABLE>";
  return valuetable;
  }

function ExportNop()
  {
  }

function ExportNewRS()
  {
  SetRecordLimit();
  GetRSCount();
  GetDefaultFormat();
  SetProcessing();
  NotifyProcessingCode();
  }

function SetRecordLimit()
  {
  var newLimit;
  newLimit = 1 * $("ExportRecordLimit").value;
  if (isNaN(newLimit))
    {  // newlimit is a non-numeric string
    newLimit = $("ExportRecordLimit").value;
    if (newLimit == "none")
      RecordLimit = 0;
    else
      {
      $("ExportRecordLimit").style.backgroundColor = "#FF8080";
      alert("RecordLimit must be a number or 'none'");
      RecordLimit = 0;
      }
    }
  else
    {
    if (newLimit == 0)
      $("ExportRecordLimit").value = "none";
    RecordLimit = newLimit;
    }
  $("ExportRecordLimit").style.backgroundColor = "#FFFFFF";
  GetRSCount();
  }

function SetExportMethod()
  {
  $("ExportMethod").value = $("ExportMethod").value.toLowerCase();
  if ($("ExportMethod").value == "url_quick" || $("ExportMethod").value == "url_direct")
    {
    ExportMethodOK = 1;
    $("ProcessRow").style.display="none";
    $("ProcessHgPatch").style.display="none";
    if ($("ExportMethod").value == "url_direct")
        {
        $("ProtocolRow").style.display="table-row";
        ExportMethodIsDirect = 1;
        }
    else
        {
        $("ProtocolRow").style.display="none";
        ExportMethodIsDirect = 0;
        }
    $("FilenameFmtRow").style.display="none";
    $("CompressRow").style.display="none";
    $("RequestorRow").style.display="none";
    $("NotifyRow").style.display="none";
    }
  else if ($("ExportMethod").value == "url" ||
           $("ExportMethod").value == 'ftp' ||
           $("ExportMethod").value == "url-tar" ||
           $("ExportMethod").value == 'ftp-tar')
    {
    ExportMethodOK = 1;
    $("ProcessRow").style.display="table-row";
    $("ProcessHgPatch").style.display="none";
    $("ProtocolRow").style.display="table-row";
    $("FilenameFmtRow").style.display="table-row";
    $("RequestorRow").style.display="table-row";
    $("NotifyRow").style.display="table-row";
    if($("ExportProtocol").value == "FITS")
       $("CompressRow").style.display="table-row";
    }
  else
    {
    alert("Please set Method to url_quick, url_direct,  url, or ftp");
    ExportMethodOK = 0;
    }
  }

function SetExportFilenameFmt()
  {
  if ($("ExportFilenameFmt").value.length != 0)
    ExportFilenameFmtOK = 1;
  else
    {
    alert("Please set non-empty name for FilenameFmt");
    ExportFilenameFmtOK = 0;
    }
  }

function SetProcessing()
  {
  ExportProcessingOK = 0;
  ExportProcessingArgs = "no_op";
  var isok = 0;
  if ($("ExportProcessing").value == "no_op")
    { // Add reset code for export options here, section 5 of 7
    if (HgPatchActive)
      HgPatchInit();
    AiaScaleInit();
    isok = 1;
    }
  else if ($("ExportProcessing").value == "hg_patch") // Export option block for HgPatch, section 6 of 7
    {
    HgPatchActive = 1;
    HgSeriesSelected = 0;
    CheckHgRecordSet(0);
    $("ProcessHgPatch").style.display="table-row";
    if (CheckHgPatch())
      isok = 1;
    AiaScaleInit();
    }
  else if ($("ExportProcessing").value == "aia_scale") // Export option block for Normalize Scale, section 6 of 7
    {
    $("ProcessAiaScale").style.display="table-row";
    ExportProcessingArgs = "aia_scale";
    isok = 1;
    }
  if (isok)
    ExportProcessingOK = 1;
  // Add recordLimit FIRST always.
  ExportProcessingArgs = "n=" + RecordLimit + "," + ExportProcessingArgs;
  $("ExportProcessingHidden").value = ExportProcessingArgs;
  }

function SetExportProtocol()
  {
  var tmp = $("ExportProtocol").value.toUpperCase();

  if (tmp == "MPEG")
    {
    $("ExportProtocol").value = "MPEG";
    ExportProtocolOK = 4;
    $("CompressRow").style.display="none";
    $("ExportProtocolHidden").value = "mpg";
    }
  else if (tmp == "MP4")
    {
    $("ExportProtocol").value = "MP4";
    ExportProtocolOK = 4;
    $("CompressRow").style.display="none";
    $("ExportProtocolHidden").value = "mp4";
    }
  else if (tmp == "JPEG")
    {
    $("ExportProtocol").value = "JPEG";
    ExportProtocolOK = 3;
    $("CompressRow").style.display="none";
    $("ExportProtocolHidden").value = "jpg";
    }
  else if (tmp == "FITS")
    {
    $("ExportProtocol").value = "FITS";
    ExportProtocolOK = 2;
    $("CompressRow").style.display="table-row";
    $("ExportProtocolHidden").value = "FITS";
    }
  else if ($("ExportProtocol").value == "as-is")
    {
    ExportProtocolOK = 1;
    $("CompressRow").style.display="none";
    $("ExportProtocolHidden").value = "as-is";
    }
  else
    {
    ExportProtocolOK = 0;
    alert('Export Protocol - must be "as-is", "FITS", "JPEG", "MP4" OR "MPG"'); 
    $("ExportProtocol").value = "";
    $("ExportProtocolHidden").value = "NOT_VALID";
    }
  if (ExportProtocolOK == 4 || ExportProtocolOK == 3)
    if (ProtocolOptionsSet)
      ProtocolSetMinMax();
    else
      ProtocolImageInit(ExportProtocolOK);
  }

function SetExportCompress()
  {
  var protocolparam = $("ExportProtocol").value;
  if ($("ExportCompress").value.length > 0 && protocolparam == "FITS")
      {
      var tmp = SeriesName.toUpperCase();
      if (tmp == "HMI.AIA" || tmp == "AIA.LEV1_EUV_12S" || tmp == "AIA.LEV1_UV_24S" || tmp == "AIA.LEV1_VIS_1H")
        protocolparam = "as-is";
      else
        for (var i=0; i < SeriesInfo.segments.length; i++)
          protocolparam = protocolparam  + "," + $("ExportCompress").value;
      $("ExportProtocolHidden").value = protocolparam;
      }
  ExportCompressOK = 1;
  }

function SetExportUser()
  {
  if ($("ExportRequestor").value.length != 0)
    {
    Cookie.setData("user", $("ExportRequestor").value);
    ExportUserOK = 1;
    }
  else
    {
    ExportUserOK = 0;
    }
  }

function SetExportNotify()
  {
  var tmp1 = $("ExportNotify").value.toUpperCase();
  if (tmp1.length == 0)
    {
    ExportNotifyOK = 0;
    $("ExportNotify").value = "NO";
    return;
    }
  if ( tmp1 ==  "SOLARMAIL" )
    {
    ExportNotifyOK = 2;
    if ($("ExportRequestor").value.length <= 0)
      {
      ExportUserOK = 0;
      ExportNotifyOK = 0;
      }
    }
  else if ( tmp1 == "NONE" || tmp1 == "NO")
    ExportNotifyOK = 3;
  else
    {
    if ($("ExportNotify").value.indexOf("@") < 0)
      { 
      ExportNotifyOK = 0;
      }
    else
      ExportNotifyOK = 1;
    }
  }

function CheckExportParams()
  {
  if (ExportRecordSetOK == 0)
    {
    $("ExportButtonMsg").innerHTML = "Retry after RecordSet updated.";
    alert("RecordSet not verified, enter RecordSet then retry export request.");
    return 0;
    }
  SetExportMethod();
  if (ExportMethodOK == 0)
    {
    $("ExportButtonMsg").innerHTML = "Retry after entering export method";
    alert("Method not given, Enter export method then retry export request.");
    return 0;
    }
  SetExportFilenameFmt();
  if (ExportFilenameFmtOK == 0)
    {
    $("ExportButtonMsg").innerHTML = "Retry after entering export method";
    alert("FilenameFmt not given, Enter FilenameFmt then retry export request.");
    return 0;
    }
  SetProcessing();
  if (ExportProcessingOK == 0)
    {
    $("ExportButtonMsg").innerHTML = "Retry after entering processing specs";
    alert("Processing details not correct, fix and retry export request.");
    return 0;
    }
  SetExportProtocol();
  if (ExportProtocolOK == 0)
    {
    $("ExportButtonMsg").innerHTML = "Retry after entering export protocol";
    alert("Protocol not given, Enter export protocol then retry export request.");
    return 0;
    }
  if ($("ExportProtocol").value == "FITS" || $("ExportProtocol").value == "as-is")
    {
    SetExportCompress();
    }
  if (Internal || ExportNotifyOK == 2)
    {
    SetExportUser();
    if (ExportUserOK == 0)
      {
      $("ExportButtonMsg").innerHTML = "Retry after entering your identification in Requestor field";
      alert("Requestor not given, Enter name you will use in Requestor field then retry export request.  This field in required if Notify is 'solarmail'");
      return 0;
      }
    }
    SetExportNotify();
    if (ExportNotifyOK == 0)
      {
      $("ExportButtonMsg").innerHTML = "Retry after entering your complete e-mail address or 'NO' or 'solarmail' in Notify field";
      alert("Notify email not given or confirmed, Enter 'solarmail' or 'no' or email address then retry export request.");
      return 0;
      }
  return 1;
  }

function GetExport()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  if (ExportReadyOK == 3)
    {
    alert("Processing request, please wait...");
    return;
    }
  if (CheckExportParams() == 0)
    return;
  if (ExportReadyOK == 0)
    {
    ExportReadyOK = 3;
    state = 2;
    Cookie.setData("state",state);
    $("ExportStatus").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
    $("ExportLocation").innerHTML = "";
    $("ExportButtonMsg").innerHTML = "Export request submitted, please wait...";
    $("ExportButton").value = "Processing ...";
    $("ExportButton").style.backgroundColor = "#FFD8D8";
    var protocolparam =  $("ExportProtocolHidden").value;
    // if ($("ExportCompress").value.length > 0 && protocolparam == "FITS")
      // protocolparam = protocolparam + "," + $("ExportCompress").value;
    var RecordSet = $("ExportRecordSet").value;
    var exportparameters = new Hash( {"op" : $("ExportOpID").value,
                 		      "ds" : RecordSet, 
                 		      "process" :  ExportProcessingArgs,
                 		      "requestor" : $("ExportRequestor").value,
                 		      "notify" : $("ExportNotify").value,
                                      "method" : $("ExportMethod").value,
                                      "filenamefmt" : $("ExportFilenameFmt").value,
			 	      "format" : "json",
                 		      "protocol" : protocolparam,                                      
                                      "t" : 1} ); 
// alert(Object.inspect(exportparameters));
    // if (nsegsselected) exportparameters = exportparameters.merge({"seg": SegList});
    }
  else if (ExportReadyOK == 1)
    {
    var requestidtmp = $("RequestIdPlace").innerHTML;
    var exportparameters = new Hash( {"op" : "exp_status","requestid":requestidtmp});
    }
  else // ExportReadyOK == 2
    {
    // $("ExportRecordSet").value = "";
    ExportRecordSetOK = 0;
    alert("Export Request Complete, Please change RecordSet to make another request");
    return;
    }

  new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_FETCH,
    {
    method: 'post',
    parameters: exportparameters.toObject(),

    onSuccess: function(transport, json)
      {
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      var response = transport.responseText || "no response text";
      var status = ProcessExportResponse(response);
      var op = $("ExportOpID").value;
      },
    onFailure: function()
      {
      $("ExportButtonMsg").innerHTML = "Export Failure, Problem at JSOC facility.";
      ExportReadyOK = 0;
      $("ExportButton").value = "FAILURE ...";
      $("ExportButton").style.backgroundColor = "#FFB0B0";
      alert('Something went wrong...');
      },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  }


function GetReExport()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  ExportReadyOK = 3;
  state = 2;
  Cookie.setData("state",state);
  $("ExportStatus").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("ExportLocation").innerHTML = "";
  $("ReExportButtonMsg").innerHTML = "Export request submitted, please wait...";
  $("ReExportButton").value = "Processing ...";
  $("ReExportButton").style.backgroundColor = "#FFD8D8";
  var exportparameters = new Hash( {"op" : "exp_repeat",
                 		    "requestid" : $("ReRequestID").value,
			 	    "format" : "json",
                 		    "notify" : $("ReExportNotify").value });

  new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_FETCH,
    {
    method: 'post',
    parameters: exportparameters.toObject(),

    onSuccess: function(transport, json)
      {
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      var response = transport.responseText || "no response text";
      var status = ProcessExportResponse(response);
      },
    onFailure: function()
      {
      $("ReExportButtonMsg").innerHTML = "Export Failure, Problem at JSOC facility.";
      ExportReadyOK = 0;
      $("ReExportButton").value = "FAILURE ...";
      $("ReExportButton").style.backgroundColor = "#FFB0B0";
      alert('Something went wrong...');
      },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  }


function ProcessExportResponse(response)
  {
  var data = response.evalJSON();
  state = 3;
  Cookie.setData("state",state);
  if (data.status == 6)
    {
    alert("RequestID not found, status=6, error=" + data.error + "<BR>Try again in a few seconds, may just be not ready to respond");
    ExportReadyOK = 0;
    $("ExportButton").value = "Retry";
    $("ExportButtonMsg").innerHTML = data.error;
    $("RequestIdPlace").innerHTML = "";
    $("ExportStatus").innerHTML = "RecordSet not found";
    $("ExportLocation").innerHTML = "";
    }
  else if (data.status == 5)
    {
    alert("Requested RequestID is too old, data no longer online, error=" + data.error) ;
    ExportReadyOK = 0;
    $("ExportButton").value = "Export timeout";
    $("ExportButtonMsg").innerHTML = data.error;
    $("RequestIdPlace").innerHTML = "";
    $("ExportStatus").innerHTML = "Export timeout";
    $("ExportLocation").innerHTML = "";
    state = 0;
    Cookie.setData("state",state);
    }
  else if (data.status == 4)
    {
    alert("Requested RecordSet not found or specification error, status=4, error=" + data.error +
      "<BR>The export program failed.<BR>" + "JSOC support see: jsoc/exports/tmp/" + data.requestid + ".runlog");
    ExportReadyOK = 0;
    $("ExportButton").value = "Bad RecordSet";
    $("ExportButtonMsg").innerHTML = data.error;
    $("RequestIdPlace").innerHTML = "";
    $("ExportStatus").innerHTML = "RecordSet not found";
    $("ExportLocation").innerHTML = "";
    state = 0;
    Cookie.setData("state",state);
    }
  else if (data.status == 3)
    {
    alert("Requested RecordSet is too large for chosen export method.  Please contact the JSOC for help.");
    $("ExportButtonMsg").innerHTML = "Export Too Large";
    ExportReadyOK = 0;
    $("ExportButton").value = "FAILURE ...";
    $("ExportButton").style.backgroundColor = "#D8D8D8";
    RequestID = data.requestid;
    $("RequestIdPlace").innerHTML = data.requestid;
    $("ExportStatus").innerHTML = "Needs Intervention, size=" + data.size + "MB, <BR>" +
      data.count + " records found, " +
      data.error + ", contact: " + data.contact;
    $("ExportLocation").innerHTML = "";
    state = 0;
    Cookie.setData("state",state);
    }
  else if (data.status == 1 || data.status == 2 || data.status == 12)
    {
    ClearStatus();
    if (data.status == 1)
      $("StatusButtonMsg").innerHTML = "Export request is being processed";
    else  // status==2
      $("StatusButtonMsg").innerHTML = "Export request waiting for processing";
    ExportReadyOK = 1;
    $("ExportButton").value = "Request Export Status";
    $("ExportButton").style.backgroundColor = "#D8D8D8";
    //  XXXX FIX $("ExportStatus").innerHTML = "Processing, size=" + data.size + "MB, estimate " + data.wait + " seconds remaining";
    $("ExportStatus").innerHTML = "Processing, size estimate = " + data.size + " MB";
    RequestID = data.requestid;
    $("RequestIdPlace").innerHTML = data.requestid;
    $("StatusRequestID").value = data.requestid;
    Cookie.setData("requestid",data.requestid);
    $("ExportLocation").innerHTML = "";
    $("FileUploadInfo").innerHTML = "File upload done, " + data.rcount + " records requested.";
    if (ExportFromFileList == 1)
      {
      FinishFileUpload();
      $("FileUploadInfoRow").style.display="table-row";
      }
    }
  else // status == 0 implies url_quick format and all online as-is
    {
    var valuetable = "";
    state = 0;
    Cookie.setData("state",state);
    Cookie.setData("requestid","");
    var count = data.count;
    $("ExportButtonMsg").innerHTML = "Fetch your data at URLs below before starting next request";
    ExportReadyOK = 2;
    $("ExportButton").value = "Submit Export Request";
    $("ExportButton").style.backgroundColor = "#D8D8D8";
    RequestID = data.requestid;
    if (RequestID.length == 0) RequestID = "N.A.";
    $("RequestIdPlace").innerHTML = RequestID;
    $("ExportStatus").innerHTML = "Data Ready, size=" + data.size + "MB";
    valuetable = CreateDataTable(data, valuetable);
    $("ExportLocation").innerHTML =  valuetable + "<BR>";
    $("FileUploadInfo").innerHTML = "File upload done, " + data.rcount + " records requested.";
    if ($("ExportMethod").value == "url_quick")
      {
      if (ExportMethodIsDirect) // was url_direct on call
        {
        if (count > 1)
            $("ExportLocation").innerHTML =  "<B>Multiple files returned, direct fetch not possible. </B><P>" +
              valuetable + "<BR>";
        else
            {
            var path = encodeURI("http://jsoc.stanford.edu" + data.dir + "/" + data.data[0].filename);
    //      doucment.write("<link type=\"application/fits\" href="+path+" />");
    //      fetch image
            }
        }
      else // url_quick on call
        $("ExportLocation").innerHTML = valuetable + "<BR>";
      }
    else
      $("ExportLocation").innerHTML =  valuetable + "<BR>";
    if (ExportFromFileList == 1)
      {
      FinishFileUpload();
      $("FileUploadRow").style.display="none";
      $("FileUploadInfoRow").style.display="table-row";
      }
    }
  return(data.status);
  }

function ClearStatus()
  {
  $("StatusButton").style.backgroundColor = "#D8D8D8";
  $("StatusStatus").innerHTML = "";
  $("StatusValue").innerHTML = "";
  $("StatusOther").innerHTML = "";
  $("StatusButtonMsg").innerHTML = "Waiting new status request...";
  $("StatusButton").value = "Submit Status Request";
  $("StatusRequestID").value = "";
  $("StatusLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("TarFileLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("KeywordFileLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("StatusDataLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  }

function GetStatus()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  if ($("StatusRequestID").value.length == 0)
    {
    alert("You must provide a RequestID");
    return;
    }
  var is_IN = ($("StatusRequestID").value.search("_IN") > 0);
  if (is_IN && Host == "jsoc.stanford.edu")
    {
    alert("RequestID ending with '_IN' belongs to jsoc2.stanford.edu, use proper RequestID or swtich to jsoc2.stanford.edu.");
    return;
    }
  if (!is_IN && Host == "jsoc2.stanford.edu")
    {
    alert("RequestID without '_IN' belongs to jsoc.stanford.edu, use proper RequestID or switch to jsoc.stanford.edu.");
    return;
    }
  $("StatusLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("TarFileLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("KeywordFileLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("StatusDataLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("StatusButton").style.backgroundColor = "#FFD8D8";
  $("StatusStatus").innerHTML = "";
  $("StatusValue").innerHTML = "";
  $("StatusOther").innerHTML = "";
  $("StatusButtonMsg").innerHTML = "Processing status request ...";
  $("StatusButton").value = "Processing ...";
  new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_FETCH,
    {
    method: 'get',
    parameters: {"op" : "exp_status", "requestid" : $("StatusRequestID").value }, 

    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no response text";
      var data = response.evalJSON();
      state = 2;
      Cookie.setData("state",state);
      if (data.status == 6)
        {
        alert("RequestID not found, status=6, error=" + data.error + "<BR>Try again in a few seconds, may just be not ready to respond");
        StatusReadyOK = 0;
        $("StatusButton").value = "Bad RecordSet";
        $("StatusButtonMsg").innerHTML = data.error + ", processing perhaps not started yet or bad RequestID";
        $("StatusValue").innerHTML = "Requested RecordSet returned error status=6";
        $("StatusOther").innerHTML = $("StatusRequestID").value + " not found,  msg=" + data.error;
        $("ReExportDiv").style.display = "none";
        state = 1;
        Cookie.setData("state",state);
        }
      else if (data.status == 5)
        {
        alert("Requested RequestID is too old, data no longer online, error=" + data.error);
        ExportReadyOK = 0;
        $("ExportButton").value = "Export timeout";
        $("ExportButtonMsg").innerHTML = data.error;
        $("RequestIdPlace").innerHTML = "";
        $("ExportStatus").innerHTML = "Export timeout";
        $("ExportLocation").innerHTML = "";
        $("ReRequestID").value = data.requestid;
        $("ReExportDiv").style.display = "block";
        }
      else if (data.status == 4)
        {
        alert("Requested RecordSet not found or specification error, status=4, error=" + data.error + "<BR>The export program failed.<BR>" +
		"JSOC support see: jsoc/exports/tmp/" + data.requestid + ".runlog");
        StatusReadyOK = 0;
        $("StatusButton").value = "Bad RecordSet";
        $("StatusButtonMsg").innerHTML = data.error;
        $("StatusValue").innerHTML = "Requested RecordSet returned error status=4";
        $("StatusOther").innerHTML = $("StatusRequestID").value + "msg=" + data.error;
        $("ReExportDiv").style.display = "none";
        }
      else if (data.status == 3)
        {
        alert("Requested RecordSet is too large for chosen export method.  Please contact the JSOC for help.");
        $("StatusButtonMsg").innerHTML = "Export Too Large";
        $("StatusButton").value = "FAILURE ...";
        $("StatusButton").style.backgroundColor = "#D8D8D8";
        $("StatusStatus").innerHTML = "Needs Intervention, size=" + data.size + "MB, contact: " + data.contact;
        $("RequestIdPlace").innerHTML = data.requestid;
        $("StatusValue").innerHTML = "Requested RecordSet returned error status=3";
        $("StatusOther").innerHTML = $("StatusRequestID").value +
           "<BR>The requested RecordSet is too large for chosen export method." +
           "<BR>" + data.count + " records found, " + data.error +
           "<BR>Please contact the JSOC for help." ;
        $("ReExportDiv").style.display = "none";
        }
      else if (data.status == 1 || data.status == 2)
	{
        if (data.status == 1)
          $("StatusButtonMsg").innerHTML = "Export request is being processed";
        else  // status==2
          $("StatusButtonMsg").innerHTML = "Export request waiting for processing";
        $("StatusButton").value = "Submit Status Request";
        $("StatusButton").style.backgroundColor = "#D8D8D8";
        // XXXXX FIX $("StatusStatus").innerHTML = "Processing, size=" + data.size + "MB, estimate " + data.wait + " seconds remaining";
        var waiting = 10 - data.wait;
        $("StatusStatus").innerHTML = "Processing, size estimate = " + data.size + " MB, " + waiting + " seconds since request";
        $("RequestIdPlace").innerHTML = data.requestid;
        $("ReExportDiv").style.display = "none";
        state = 1;
        Cookie.setData("state",state);
        }
      else // status == 0
        {
        var valuetable = "";
        $("StatusButtonMsg").innerHTML = "Please only click once for status request.";
        $("StatusButton").value = "Submit Status Request";
        $("StatusButton").style.backgroundColor = "#D8D8D8";
        $("StatusStatus").innerHTML = "Data Ready, size=" + data.size + "MB";
        $("RequestIdPlace").innerHTML = data.requestid;
        var StatusLoc;
	if (data.method.indexOf("ftp") >= 0)
          StatusLoc = "ftp://pail.stanford.edu/export" + data.dir + "/";
        else
          StatusLoc = "http://jsoc.stanford.edu" + data.dir + "/";
        $("StatusLocation").innerHTML = "<A HREF='" + StatusLoc + "' target='_blank'>" + StatusLoc + "</A>";
        if (data.method.indexOf("-tar") > 0)
          {
          $("TarFileLocation").innerHTML = "<A HREF='" + data.tarfile + "'>" + data.tarfile + "</A>";
          $("TarFileLocationRow").style.display = "table-row";
          }
        else
          $("TarFileLocationRow").style.display = "none";
        if (data.protocol.indexOf("as-is") >= 0)
          {
          $("KeywordFileLocation").innerHTML = "<A HREF='" + data.keywords + "' target='_blank'>" + data.keywords + "</A>";
          $("KeywordFileLocationRow").style.display = "table-row";
          }
        else
          $("KeywordFileLocationRow").style.display = "none";

        $("ExportStatus").innerHTML = "Data Ready, size=" + data.size + "MB";
        valuetable = CreateDataTable(data, valuetable);
        $("StatusDataLocation").innerHTML =  valuetable + "<BR>";
        $("StatusValue").innerHTML = "Success";
        $("StatusOther").innerHTML = "List formats are index.html, index.json, and index.txt<BR>" +
             "export script file is " + $("StatusRequestID").value +".drmsrun" ;
        if (ExportFromFileList  == 1)
          FinishFileUpload();
        $("ReExportDiv").style.display = "none";
        state = 1;
        Cookie.setData("state",state);
        }
      },
    onFailure: function()
      {
      $("StatusButtonMsg").innerHTML = "Export Failure, Problem at JSOC facility.";
      $("StatusButton").value = "FAILURE ...";
      $("StatusButton").style.backgroundColor = "#FFB0B0";
      alert('Something went wrong...');
      },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  }

</script>

</HEAD>
<BODY BGCOLOR="#E0F0FF" onload="OnLoadInit();" >
<DIV ID="header">
<IMG src="http://hmi.stanford.edu/images/web/JSOC_120.gif"
  style="vertical-align:middle;height:60" alt="JSOC logo">
&nbsp;&nbsp;&nbsp;
<B><big style="vertical-align:middle">&nbsp;&nbsp;JSOC Data Export</big></B>
&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;
<input type="button" value="reset page" onClick="ReInitPage();" >
&nbsp;&nbsp;&nbsp;
<input id="TipsOnOffButton" type="button" value="Turn Help Off" onClick="ToggleHelp();" >
&nbsp;&nbsp;<span id="AjaxBusy">0</span> Requests Pending
<span id='systemWorking'>, Loading...</span>
<!-- <br clear=all> -->
<HR>
</DIV> <!-- end DIV header -->
<DIV id="ExportRequestDiv">
<B>JSOC Data Export Request Generation</B>
<SPAN ID="RecordSetExample">
&nbsp; &nbsp;
<A HREF=ExportDataErrorHelp.html target="JSOC_Help">Help with Error Messages</A>
</SPAN>
<P>
If the Method is changed from "url_quick" or "url_direct" you will have additional options to specify.
"url-direct" is temporarily disabled.
<p>
After the request is submitted
for Methods of "url", "ftp", "url-tar" or "ftp-tar" you will recieve ON THIS PAGE a "Request_ID" that will be used
to access the data when it is ready.
<p>
If you enter an email address you will be notified when the data is ready.
If you do not provide an email address you must leave this page open or save the Request_ID in order to
access the data.
<p>

<form id='FileUploadFormID' name='FileUploadForm'
  action=''
  target="FileUploadFrame"
  enctype='multipart/form-data' method='post'>

<input type='hidden' id='ExportOpID' name='op'  value='exp_request' >
<input type='hidden' id="ExportProtocolHidden" name='protocol' value='as-is' >
<input type='hidden' id="ExportProcessingHidden" name='process' value='no_op' >

  <TABLE>
    <TR>
      <TD>RecordSet from file</TD><TD><SPAN ID="RecordFromFileHelp" class="tip">?</SPAN></TD>
      <TD colspan=2><input type="checkbox" name="FileUploadCheckbox" id="FileUploadCheckbox" onChange="FileUploadWanted();">
        Check box to allow upload of RecordSet list file, file will be requested after Submit button click.</TD>
    </TR>
  
    <TR ID="RecordSetRow">
      <TD style="width:10em" >RecordSet</TD><TD><SPAN ID="RecordSetHelp" class="tip">?</SPAN></TD><TD colspan=2>
        <input id="ExportRecordSet" type="text" name="ds" value="" onkeydown="return OnEnterKey(event,ExportNewRS);"> </TD>
    </TR>
  
    <TR ID="RecordLimitRow">
      <TD>Record Limit</TD><TD><SPAN ID="RecordLimitHelp" class="tip">?</SPAN></TD>
      <TD><input id="ExportRecordLimit" type="text" name="ExportReccordLimit" value="none" style="width:15em" onChange="SetRecordLimit();" ></TD>
      <TD>Optional manual limit to number of records to export.</TD>
    </TR>
  
    <TR ID="RecordCountRow">
      <TD>Record Count</TD><TD><SPAN ID="RecordCountHelp" class="tip">?</SPAN></TD>
      <TD><span id="RSCountPlace" style="width:10em;background-color:#FFF8DC"></span></TD>
      <TD><input id="CountButton" type="button" value="Recount" onClick="ExportNewRS();" >&nbsp;
          Limit for AIA to about 15,000 and for HMI about 30,000 in each request.</TD>
    </TR>
  
    <TR ID="MethodRow">
      <TD>Method</TD>
      <TD><SPAN ID="MethodHelp" class="tip">?</SPAN></TD>
      <TD><select id="ExportMethod" type="text" name="method" style="width:15em" onChange="SetExportMethod();" >
        <option value="url_direct">url_direct
        <option value="url_quick">url_quick
        <option value="url">url
        <option value="ftp">ftp
        <option value="url-tar">url-tar
        <option value="ftp-tar">ftp-tar
        </select> </TD>
      <TD>Choose method, url_quick or url for now. url_quick implies protocol of "as-is"</TD>
    </TR>
  
    <TR ID="FilenameFmtRow">
      <TD>Filename Format</TD>
      <TD><SPAN ID="FilenameFmtHelp" class="tip">?</SPAN></TD>
      <TD colspan=2><input id="ExportFilenameFmt" type="text" name="filenamefmt" value="no_op" style="width:30em" onChange="SetFilenameFmt();" > File name template.</TD>
    </TR>
  
    <!-- Processing selection detail rows go here. section 7 of 7 -->
    <!--#include virtual="exportdata.d/processing.html" -->
  
    <TR ID="ProtocolRow">
      <TD>Protocol</TD>
      <TD><SPAN ID="ProtocolHelp" class="tip">?</SPAN></TD>
      <TD><select id="ExportProtocol" name="rawprotocol" style="width:15em"  onChange="SetExportProtocol();">
            <option value="as-is">as-is
            <option value="FITS">FITS
            <option value="JPEG">JPEG
            <option value="MPEG">MPEG
            <option value="MP4">MP4
          </select> </TD>
      <TD>Choose protocol, "FITS", "JPEG", "MPG", "MP4", or "as-is". Note AIA lev1 FITS,compressed is same as "as-is".</TD>
    </TR>

    <!-- Protocol selection detail rows go here. section 1 of X -->
    <!--#include virtual="exportdata.d/protocols.html" -->
  
    <TR ID="CompressRow">
      <TD>Compression</TD>
      <TD><SPAN ID="CompressHelp" class="tip">?</SPAN></TD>
      <TD><select id="ExportCompress" name="compress" style="width:15em"  onChange="SetExportCompress();">
        <option value="compress Rice" selected="selected" >compress Rice
        <option value="**NONE**">**NONE** </select> </TD>
      <TD>Choose compression parameters for each segment., **NONE** for no compression.</TD>
    </TR>
  
    <TR ID="RequestorRow">
      <TD>Requestor</TD>
      <TD><SPAN ID="RequestorHelp" class="tip">?</SPAN></TD>
      <TD><input id="ExportRequestor" type="text" name="requestor" value="" onChange="ExportNop();" ></TD>
      <TD><SPAN ID="RequestorMessage">Provide an identifier for you, e.g. your SolarMail name. May be omitted for online delivery.</SPAN></TD>
    </TR>
  
    <TR ID="NotifyRow">
      <TD>Notify</TD>
      <TD><SPAN ID="NotifyHelp" class="tip">?</SPAN></TD>
      <TD><input id="ExportNotify" type="text" name="notify" value="" onChange="ExportNop();" ></TD>
      <TD>Provide your email address for notification.  May be omitted for online delivery.</TD>
    </TR>
  
    <TR ID="AjaxExportRequestRow">
      <TD colspan=4>
        <input id="ExportButton" type="button" value="Submit Export Request" style="background-color:#D8D8D8" onClick="GetExport();" >
      <span id="ExportButtonMsg">Please only click once for export request.</span >
      </TD>
    </TR>
  
    <TR id="FileUploadRow" style="display:none;">
      <TD >Select File</TD>
      <TD><SPAN ID="SendFileHelp" class="tip">?</SPAN></TD>
      <TD colspan=2>
      <input type='file' id='newFile' name='file' >
      <input type='button' value='Submit Export Request' class='button' onClick="MakeFileUploadRequest();">
      </TD>
    </TR>

    <TR id="FileUploadInfoRow" style="display:none;">
      <TD>Uploaded File:</TD>
      <TD>&nbsp;</TD>
      <TD><span id="FileUploadInfo"></span></TD>
      <TD></TD>
    </TR>
  </TABLE>
</form>

<DIV ID=iframeHideDiv style="display:none;">
  <iframe id="FileUploadFrame" onload="uploadDone();" name="FileUploadFrame" src="" style="height:0px;width:0px;border:0px solid #fff;"></iframe>
</DIV>


<DIV ID=SubmitResponseDiv>
<TABLE>
  <TR>
    <TD>RequestID</TD>
    <TD colspan=2><span id="RequestIdPlace" style="width:12em;background-color:#FFF8DC;">&nbsp;</span></TD>
    <TD>This is the ID tag for your export request.  Use the Status Request button below to retrieve the links to the data.</TD>
  </TR>

  <TR>
    <TD>Status</TD>
    <TD colspan=3> <span id="ExportStatus" style="background-color:#FFF8DC;"> </span ></TD>
  </TR>

  <TR>
    <TD>Data Location</TD>
    <TD colspan=3><span id="ExportLocation" style="background-color:#FFF8DC;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span ></TD>
  </TR>

</TABLE>
</DIV>
<HR>
<DIV ExportDataDiv  style="background-color:#C0E0FF;">
<B>JSOC Data Export Status and Retrieval</B>
<p>
<TABLE>
  <TR>
    <TD style="width:10em" >RequestID</TD>
    <TD><input type="text" id="StatusRequestID" name="StatusRequestID" style="width:12em;background-color:#FFF8DC;" value="" onChange="GetStatus();"></TD>
    <TD>This is the ID tag for your export request.</TD>
    <TD><span id="StatusValue">&nbsp;</TD>
  </TR>

  <TR>
    <TD colspan=2 align="center" >
      <input id="StatusButton" type="button" value="Submit Status Request" style="background-color:#D8D8D8" onClick="GetStatus();" ></TD>
    <TD><span id="StatusButtonMsg">Please only click once for status request.</span ></TD>
    <TD rowspan=3><span id="StatusOther">&nbsp;</TD>
  </TR>

  <TR>
    <TD colspan=2 align="center" >
      <input id="ClearButton" type="button" value="Clear Request" style="background-color:#D8D8D8" onClick="ClearStatus();" ></TD>
    <TD>Clear old status RequestID</TD>
  </TR>

  <TR>
    <TD>Status</TD>
    <TD colspan=2> <span id="StatusStatus" :tyle="background-color:#FFF8DC;"> </span ></TD>
  </TR>

  <TR>
    <TD>Data Location</TD>
    <TD colspan=3><span id="StatusLocation" style="background-color:#FFF8DC;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span ></TD>
  </TR>

  <TR ID="TarFileLocationRow" style="display:none;">
    <TD>Tar File Location</TD>
    <TD colspan=3><span id="TarFileLocation"  style="background-color:#FFF8DC;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span ></TD>
  </TR>

  <TR ID="KeywordFileLocationRow" style="display:none;">
    <TD>Keyword File Location</TD>
    <TD colspan=3><span id="KeywordFileLocation"  style="background-color:#FFF8DC;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span ></TD>
  </TR>

  <TR>
  <TD colspan=4><span id="StatusDataLocation" style="background-color:#FFF8DC;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span ></TD>
  </TR>

</TABLE>
</DIV> <!-- id="ExportRequestDiv" -->

<DIV ID="ReExportDiv" style="display:none">
<HR>
Use this section to request a renewal/repeat of a prior export for which the data online-retention time has expired.
<TABLE>

  <TR>
    <TD style="width:10em" >RequestID</TD>
    <TD><input type="text" id="ReRequestID" name="ReRequestID" style="background-color:#FFF8DC;" value="" onChange="ExportNop();"></TD>
    <TD>Enter RequestID for repeat or prior export</TD>
    <TD><span id="ReStatusValue">&nbsp;</TD>
  </TR>

  <TR ID="ReNotifyRow">
    <TD>Notify</TD>
    <TD><input id="ReExportNotify" type="text" name="Renotify" value="" onChange="ExportNop();" ></TD>
    <TD colspan=2>Provide your email address for notification.  May be omitted for online delivery.</TD>
  </TR>
  
  <TR ID="AjaxReExportRequestRow">
    <TD colspan=4>
      re-<input id="ReExportButton" type="button" value="Submit Export Request" style="background-color:#D8D8D8" onClick="GetReExport();" >
    <span id="ReExportButtonMsg">Please only click once for re-export request.</span >
    </TD>
  </TR>
  
</TABLE>
</DIV> <!-- id="ReExportDiv" -->

<HR>
<P style="height:1px">
<DIV id="footer" style="vertical-align:bottom;text-align:center;">
<I>Home page for:</I>
<A HREF = "http://jsoc.stanford.edu/"><B>SDO-JSOC</B></A>
</DIV>
</BODY>
</HTML>
