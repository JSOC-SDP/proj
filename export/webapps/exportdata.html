<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta HTTP-EQUIV="Content-Type" content="text/html; charset=iso-8859-1">
<title>JSOC Export Data</title>

<script type="text/javascript" src="js/prototype-1.6.0.3.js"></script>
<script type="text/javascript" src="js/cookies.js"></script>
<script type="text/javascript" src="js/prototip.js"></script>
<link rel="stylesheet" type="text/css" href="css/prototip.css" >

<script type="text/javascript">
// Global variables and initialize page locations
var exportdata = location.pathname.sub(".html",""); 
</script>
<script type="text/javascript">
document.write('<base id="basepath" href="'+exportdata+'/"><\/base>');
</script>

<script type="text/javascript">

// Set CGI-BIN and include targets

// var SHOW_SERIES = "show_series_test";
// var JSOC_INFO = "jsoc_info_test";
// var JSOC_FETCH = "jsoc_fetch_test";

var SHOW_SERIES = "show_series";
var JSOC_INFO = "jsoc_info";
var JSOC_FETCH = "jsoc_fetch";
</script>

<!-- Add functions for export processing and protocol options  -->
<script type="text/javascript" src="exportdata.d/processing.js"></script>
<script type="text/javascript" src="exportdata.d/protocols.js"></script>

<style type="text/css">

#body { margin:0; padding:0; }
#header { position:relative; top:0; left:0; width:100%; background:#eee; }
#footer { position:fixed; bottom:0; left:0; width:100%; background:#eee; }
#ExportRecordSet { width:40em; font-size:100%; }
span.tip { background-color:blue;font-family:verdana;color:white;font-size:1em;font-weight:bold;}
.prototip { font:0.8em Arial, Helvetica, sans-serif; }
</style>

<script type="text/javascript">

// Protect page from accidental BACK button
window.onbeforeunload = function () 
  {
  return "Did you really mean to leave exportdata? Use CANCEL to stay here";
  }

var Host = location.host;
var Internal = 0;
var SeriesName;
var SeriesInfo;
var RequestID;
var RecordLimit;
var RecordCount;
var RecordCountNeeded;
var ExportRecordSetOK;
var ExportFromFileList;
var ExportProtocolOK;
var ExportCompressOK;
var ExportMethodOK;
var ExportFilenameFmtOK;
var ExportProcessingOK;
var ExportProcessingOptions;
var ExportUserOK;
var ExportNotifyOK;
var ExportReadyOK;
var TipsEnabled;
var TipsCreated = 0;
var args;
var state=0;
var uploadOndoneAction = 0;
var ExportProcessingArgs = "";
var ExportMethodValue = "url_quick";
var ExportCompressValue = "compress Rice";
var ExportProtocolValue = "FITS";
var firstTimePrime;

var colorNeutral = "#D4D0C8";
var colorPreset = "D8D8D8";
var colorOptionSet = "#FFCC66";
var colorPink = "#FFD8D8";
var colorRed = "#D88080";
var colorDarkRed = "#FF8080";
var colorWhite = "#FFFFFF";
var colorGreen = "#80FF80";
var colorYellow = "#FFF8DC";


// Processing options code section 2 of 7
//    these quantities moved or will be moved to code in exportdata.d/
var ProtocolOptionsSet = 0;

function OnEnterKey(evt,action)
  {
  var keynum;
  var keychar;
  if(window.event) // IE
    keynum = evt.keyCode;
  else if(evt.which) // Netscape/Firefox/Opera
    keynum = evt.which;
  if(keynum == 13)
    action();
  keychar = String.fromCharCode(keynum);
  return keychar;
  }

var previousSeries = "";
function NotifyProcessingCode()
  {
  // called when RecordSet is changed.
  // Set flags to alert processing or method options here.
  // variables here will usually be defined in exportdata.d/processing.js

  if (SeriesName === previousSeries)
{
// alert("Notify, same seriesname");
    SetProcessing(-1);
}
  else
{
// alert("Notify, new seriesname");
    SetProcessing(-2);
}
  previousSeries = SeriesName;
  }

// End of processing options section

function initVars()
  {
  Host = location.host;
  if (Host == "jsoc2.stanford.edu")
    Internal = 1;
  else
    Internal = 0;
  SeriesName = "";
  RequestID = "";
  RecordCount = 0;
  RecordCountNeeded = 1;
  RecordLimit = 0;
  ExportRecordSetOK = 1;
  ExportFromFileList = 0;
  ExportProtocolOK = 1;
  ExportCompressOK = 1;
  ExportMethodOK = 1;
  ExportMethodIsDirect = 0;
  ExportFilenameFmtOK = 1;
  ExportProcessingOK = 1;
  ExportUserOK = 1;
  ExportNotifyOK = 2;
  ExportReadyOK = 0;
  TipsEnabled = 1;
  uploadOndoneAction = 0;
  ExportProcessingArgs = "";
  firstTimePrime = "";

  ProcessingInit();
  ProtocolOptionsInit();

  // if (state < 2)
    {
    $("ExportRequestor").value = "";
    $("ExportNotify").value = "solarmail";
    $("RequestIdPlace").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
    $("StatusLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
    $("TarFileLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
    $("ExportStatus").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
    $("StatusDataLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
    $("ExportRecordSet").value = "";
    $("ExportProtocol").selectedIndex = 1;
    $("ExportProtocolHidden").value = "FITS";
    $("ExportCompress").value = 0;
    $("ExportProcessingHidden").value = "no_op";
    $("ProcessingCheckbox").checked = 0;
    $("ExportMethod").selectedIndex = 1;
    $("ExportFilenameFmt").value = "{seriesname}.{recnum:%lld}.{segment}";
    $("ExportButton").value = "Submit Export Request";
    $("ExportButtonMsg").innerHTML = "Please only click once for export request.";
    $("ExportButton").style.backgroundColor = colorRed;
    $("RecordSetRow").style.display="table-row";
    $("RecordCountRow").style.display="table-row";
    $("ProcessRow").style.display="none";
    $("ProtocolRow").style.display="none";
    $("CompressRow").style.display="none";
    $("FilenameFmtRow").style.display="none";
    $("RequestorRow").style.display="none";
    $("NotifyRow").style.display="none";
    $("FileUploadCheckbox").checked = 0;
    $("ExportOpID").value = "exp_request";
    $("ReRequestID").value = "";
    $("ReExportDiv").style.display = "none";
    $("TarFileLocationRow").style.display = "none";
    $("KeywordFileLocationRow").style.display = "none";
    }
  FileUploadCleanup();
  }

function getargs()
  {
  state = Cookie.getData("state");
  $("ExportRequestor").value = Cookie.getData("user");
  if ($("ExportRequestor").value == "undefined")
    $("ExportRequestor").value = "";
  if (state == 1)
    {
    var exportargs = Cookie.data["search"];
    if (exportargs != undefined)
      {
      exportargs = decodeURIComponent(exportargs);
      exportargs = exportargs.substr(1);
      exportargs = exportargs.replace(/\?/g,"QUESTIONMARK");
      args = exportargs.toQueryParams();
      if (args.ds == undefined)
        args.ds = "";
      args.ds = args.ds.replace(/QUESTIONMARK/g, "?");
      }
    else
      {
      args = new Object;
      args.ds = "";
      }
    }
  else if (state > 1)
    {
    args = new Object;
    args.ds = "";
    args.requestid = "";
    args.limit= "none";
    }
  else
    {
    var exportargs = location.search;
    exportargs = decodeURIComponent(exportargs);
    exportargs = exportargs.substr(1);
    exportargs = exportargs.replace(/\?/g,"QUESTIONMARK");
    args = exportargs.toQueryParams();
    if (args.ds == undefined)
      args.ds = "";
    args.ds = args.ds.replace(/QUESTIONMARK/g, "?");
    state=1;
    Cookie.setData("state",state);
    Cookie.setData("search",location.search);
    Cookie.setData("user", $("ExportRequestor").value);
    }
  return args;
  }

function OnLoadInit()
  {
  var needcount = 0;
  Cookie.init({name:exportdata, expires:5});
  initVars();
  state = 0;
  Cookie.setData("state",state);
  args = getargs();
  if (args.ds)
    {
    $("ExportRecordSet").value = args.ds;
    needcount = 1;
    }
  if (args.id)
    {
    RequestID = args.id;
    }
  if (args.limit) 
    {
    $("ExportRecordLimit").value = args.limit;
    if (args.limit == "none") RecordLimit = 0;
    else RecordLimit = args.limit;
    }
  if (needcount && $("ExportRecordSet").value != "")
    {
    GetRSCount();
    GetDefaultFormat();
    }
  if (Internal)
    $("RequestorMessage").innerHTML = "Provide an identifier for you, e.g. your SolarMail name. Required for jsoc2";
  // HELP tips enable
  ProcessingEnabled();
  CreateTips();
  $("TipsOnOffButton").value = "Turn Help Off";
  window.focus();
  }

function ReInitPage()
  {
  Cookie.setData("state",0);
  OnLoadInit();
  }

function MainTips(tipstyle)
  {
  if (TipsCreated == 0)
    {
    new Tip('RecordFromFileHelp','Allows user to provide a RecordSet list in a file.  ' +
        'The file should contain recordSet specifiers in the format allowed by drms_open_records include files.  ' +
        'See http://jsoc.stanford.edu/jsocwiki/AllAboutJsocNames.',tipstyle);
    new Tip('RecordSetHelp','RecordSet to be exported. May be imported on call and/or may be entered directly here. ' +
        'May be filled in by series select in Im_patch processing option.',tipstyle);
    new Tip('RecordLimitHelp','RecordSet record limit. Max number of records to export.  Modifies RecordSet. ' +
        'Value should be "none" or a number. Number > 0 counts from start of RecordSet.  Negative number counts ' +
        'from high end of RecordSet.  0 means no limit',tipstyle);
    new Tip('RecordCountHelp','RecordSet record count.  Update this to repeat export with new method, email, etc.  ' +
        'There is presently a limit to the memory space allocated for record queries which restricts AIA lev1 ' +
        'requests to about 15,000 records and HMI X_45s or X_720s data to about 32,000 records.  ' +
        'The limit depends on number of keywords in each record.  This limit will be eased in the future.',tipstyle);
    new Tip('ProcessingHelp','Processing to be done to the data prior to export.  Select from drop-down list for details.',tipstyle);
    new Tip('ProtocolHelp','Data storage protocol for data files to be fetched.  ' +
        '<br>"Fits" causes the data to be converted to full fits files with header information filled from the DRMS records.  ' +
        '<br>"As-is" leaves the data as it is used inside the JSOC DRMS routines, with the header metadata stored in the database ' +
        'rather than with the data file.  "As-is" is faster since the data does not need to be rewritten.  In as-is mode the header data is ' +
        'provided in a tab-delimited file named {RequestID}.keywords.txt. <br> The "jpeg" option will ' +
        ' yield  jpeg images of the data with a pre-determined scaling and colortable and the <br>"mpg" option will ' +
        ' yield a movie in mp4 format along with the jpeg images that make up the frames in the movie.',tipstyle);
    new Tip('CompressHelp','Compression parameters to be used by the cfitsio library.  ' +
        'Provide up to one comma separated string for each segment name in your export.  ' +
        'Use "**NONE**" to indicate uncompressed FITS files desired.  If more segments are to be exported than strings are provided, ' +
        'then the last string will be used repeatedly as needed.  ' +
        'If this parameter is empty, the exported FITS file will have the same compression parameters as the original DRMS ' +
        'series segment as specified in the JSD for that series.  ' +
        'Advice: use **NONE** to ensure uncompressed.  See lookdata.html for the "cparms_sg###" keyword for the default.',tipstyle);
    new Tip('MethodHelp','Handshake method to be used in the process of doing the export and to fetch the data files. ' +
        '"url-quick" is the fastest but can only be used if the data is online and will be exported "as-is". ' +
        '"url-direct" is has the constraints of url_quick with the limit of one file per request but it will ' +
        'automatically do the postprocessing specified in the "protocol" instruction. For "url_direct" the file ' +
        'is returned directly to your browser rather than returning to the export page.  If you have the ' +
        'set to load some fits reader program when the mime-ype "fits" is encountered you will see the image promptly. ' +
        '"url" will result in a temporary directory being created and the URL to that directory be returned to you after ' +
        'a handshake process using the RequestID provided. ' +
        '"ftp" is like "url" but the returned links will be to an ftp directory. ' +
        ' A "-tar" suffix will cause a tar of all files in the request to be included with the separate files. ' +
        'NOTE: do not use "-tar" unless you really need it since that will generate an extra copy of the data.',tipstyle);
    new Tip('FilenameFmtHelp','Filename format to be used in the process of doing the export.  ' +
        'The filename format is a template used to construct a filename for each segment of each record requested.  ' +
        'The template consists of literal characters and substitution tokens enclosed in "{}".  ' +
        'The special words: seriesname, recnum, and segment are replaced with the series_name, the record number, ' +
        'or the segment name.  The element {#} will generate an increasing number, ' +
        'with optional layout e.g. default is {#:%05d}. ' +
        'Any keyword in the record may also be used.  Optional layout may be provided after a ":".' +
        'Special format options are available for type TIME keywords: A leading "A" will strip "." and ":" from the time and ' +
        'a "D" will strip the "." and ":" but will insert "@" around the date components to allow easy scripts to move the exported ' +
        'files into date structured directory trees. ' +
        'It is wise to include enough of the "prime-keys" to make a unique filename.  ' +
        'The default format template is made from series structure.',tipstyle);
    new Tip('RequestorHelp','Optional place for your name, this will be used later when we have a way of saving your ' +
        'preferred export options.',tipstyle);
    new Tip('NotifyHelp','Optional email address to be used to notify you when the export is complete and ready to be ' +
        'fetched using the RequestID.',tipstyle);
    new Tip('SendFileHelp','This action will submit the export request with the RecordSet specified in the upload file.',tipstyle);
    }
  };

</script>
<script type="text/javascript" src="exportdata.d/addOnTips.js"></script>
<script type="text/javascript">

function CreateTips()
  {
  var tipstyle =
    {
    style:'protoblue',
    hook:{target:'topRight',tip:'bottomLeft'},
    stem:'bottomLeft',
    closeButton:false,
    hideAfter:5,
    hideOn:'click',
    showOn:'click',
    border:3,
    radius:3,
    width:300,
    };

  MainTips(tipstyle);
  AddOnTips(tipstyle, Tip);
  TipsCreated = 1;
  $$("span.tip").each(function(showspan){showspan.show();}); 
  }

function HideTips()
  {
  $$("span.tip").each(function(hidespan){hidespan.hide();}); 
  Tips.hideAll();
  }

function ToggleHelp()
  {
  if (TipsEnabled)
    {
    HideTips();
    $("TipsOnOffButton").value = "Turn Help On";
    TipsEnabled = 0;
    }
  else
    {
    CreateTips();
    $("TipsOnOffButton").value = "Turn Help Off";
    TipsEnabled = 1;
    }
  }

function FileUploadCleanup()
  {
  $("ExportRecordSet").value = "";
  ExportRecordSetOK = 0;
  ExportFromFileList = 0;
  $("FileUploadCheckbox").checked = 0;
  $("RSCountPlace").innerHTML = "";
  $("ExportButton").value = "Submit Export Request";
  $("AjaxExportRequestRow").style.display="table-row";
  $("FileUploadInfoRow").style.display="none";
  $("RecordSetRow").style.display="table-row";
  $("RecordCountRow").style.display="table-row";
  $("ExportOpID").value = "exp_request";
  }
  
function FileUploadWanted()
  {
  if (ExportFromFileList == 0)
    {
    $("ExportRecordSet").value = "*file*";
    ExportRecordSetOK = 1;
    ExportFromFileList = 1;
    $("FileUploadCheckbox").checked = 1;
    $("RecordSetRow").style.display="none";
    $("RecordCountRow").style.display="none";
    $("ExportOpID").value = "exp_request";
    $("FileUploadRow").style.display="table-row";
    $("FileUploadInfoRow").style.display="none";
    $("AjaxExportRequestRow").style.display="none";
    }
  else
    {
    $("FileUploadInfoRow").style.display="none";
    FileUploadCleanup();
    FinishFileUpload();
    }
  }

function insertOption(list,text,note)
  {
  var y=document.createElement('option');
  y.value=text;
  if (note.length)
    y.text = text + "  --- " + note;
  else
    y.text = text;
  var x = $(list);
  try
    {
    x.add(y,null); // standards compliant
    }
  catch(ex)
    {
    x.add(y); // IE only
    }
  }

function MakeFileUploadRequest()
  {
  if (CheckExportParams() == 0)
    return;
  uploadOndoneAction = 1;
// XXXX fix compression here
  $("FileUploadFormID").action = 'http://' + Host + '/cgi-bin/ajax/' + JSOC_FETCH;
  $("FileUploadFormID").submit();
  }

function uploadDone()
  { //Function will be called when iframe is loaded
  if (uploadOndoneAction == 1)
    {
    var response = window.frames[0].document.getElementsByTagName("body")[0].innerHTML;
    var status = ProcessExportResponse(response);
    var op = "exp_upload";
    uploadOndoneAction = 0;
    }
  }

function FinishFileUpload()
  {
  window.frames[0].document.getElementsByTagName("body")[0].innerHTML = "";
  $("FileUploadRow").style.display="none";
  uploadOndoneAction = 0;
  }

function GetSeriesList(filter)
  {
  var SeriesList;
  var GetSeriesObject = new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + SHOW_SERIES,
    {
    method: 'get',
    parameters: {"filter" : filter },
    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no series";
      SeriesList = response.evalJSON();
      },
    onFailure: function() { alert('Something went wrong...'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  return(SeriesList);
  }

function GetRSCount()
  {
  var recset = $("ExportRecordSet").value;
  var recfilt, segfilt;
  var posbracket = recset.indexOf("[");
  var posRbracket = recset.lastIndexOf("]");
  var posCurlbracket = recset.indexOf("{");
  var posCurlRbracket = recset.lastIndexOf("}");
  if ((posbracket>=0 && posRbracket < posbracket) || 
      (posRbracket>=0 && posbracket < 0) ||
      (posCurlbracket>=0 && (posCurlRbracket < posCurlbracket || posCurlbracket < posbracket || posCurlbracket < posRbracket)) ||
      (posCurlRbracket>=0 && posCurlbracket < 0))
       {
       $("RSCountPlace").innerHTML = "ERROR - missing or wrong bracket or seglist precedes record filter";
       return(1);
       }
  var firstbracket = posbracket>=0 ? posbracket : posCurlbracket;
  SeriesName = (firstbracket == -1 ? recset : recset.substring(0,firstbracket));
  recfilt = (posbracket >=0 ? recset.substring(posbracket,posRbracket+1) : "[$]");
  segfilt = (posCurlbracket >=0 ? recset.substring(posCurlbracket,posCurlRbracket+1) : "");
  $("ExportRecordSet").value = SeriesName + recfilt + segfilt;
  
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  $("RSCountPlace").innerHTML = "Getting count - wait...";
  RecordCount = -1;
  var RecordSet = $("ExportRecordSet").value;
  new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_INFO,
    {
    method: 'get',
    parameters: {"ds" : RecordSet, "op" : "rs_summary", "n" : RecordLimit },

    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no response text";
      var data = response.evalJSON();
      if (data.status != 0)
        {
	RecordCount = 0;
        $("RSCountPlace").innerHTML = "No RecordSet Count Found";
        }
      else
	{ 
	RecordCount = data.count;
	$("RSCountPlace").innerHTML = data.count;
	}
      ExportReadyOK = 0;
      ExportRecordSetOK = 1;
      $("ExportButtonMsg").innerHTML = "Please only click once for export request.";
      $("ExportButton").value = "Submit Export Request";
      $("ExportButton").style.backgroundColor = colorRed;
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      var op = "rs_summary";
      },
    onFailure: function() { alert('Something went wrong...'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  CheckRediness();
  return(0);
  }

function GetDefaultFormat()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  $("RSCountPlace").innerHTML = "Getting count - wait...";
  RecordCount = -1;
  var RecordSet = $("ExportRecordSet").value;
  new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_INFO,
    {
    method: 'get',
    parameters: {"ds" : RecordSet, "op" : "series_struct" },

    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no response text";
      SeriesInfo = response.evalJSON();
      if (SeriesInfo.status == 0)
        {
        var nprimes = SeriesInfo.primekeysinfo.length;
        var nkeys = SeriesInfo.keywords.length;
        if (nprimes == 0)
          {
          $("ExportFilenameFmt").value = SeriesName + ".{recnum:%lld}.{segment}";
          }
        else
          {
          var newfmt = SeriesName + ".";
          var i;
          for (i=0; i<nprimes; i++)
            {
            var thisprime = SeriesInfo.primekeys[i];
            var j;
            for  (j=0; j<nkeys; j++)
              {
              var thiskey = SeriesInfo.keywords[j].name;
              if (thiskey === thisprime)
                {
                if (SeriesInfo.keywords[j].type === "time")
                  {
                  newfmt = newfmt + "{" + thisprime + ":A}.";
                  if (firstTimePrime ==="") firstTimePrime = thisprime;
                  }
                else
                  newfmt = newfmt + "{" + thisprime + "}.";
                break;
                }
              }
            }
	  newfmt = newfmt + "{segment}";
          $("ExportFilenameFmt").value = newfmt;
          }
	}
      else
        alert("failed to get series info for " + RecordSet + "\nEnter correct RecordSet or proceed to processing options");
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      },
    onFailure: function() { alert('Something went wrong...'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  }

var expURL;
function CreateDataTable(data, valuetable)
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  valuetable = "";
  // var count = data.count;
  var count = data.data.length;
  valuetable = "<table border='1'>"
  valuetable = valuetable + "<tr><td>File</td><td>Record</td><td>Filename</td></tr>"
  for (ifile=0; ifile < count; ifile++)
    {
    valuetable = valuetable + "<tr>";
    valuetable = valuetable +  "<td>" + (ifile + 1) + "</td>";
    valuetable = valuetable +  "<td>" + data.data[ifile].record + "</td>";
    thisfile = data.data[ifile].filename;
    if (data.method.indexOf("tar") > 0)
      valuetable = valuetable +  "<td>" + thisfile + "</td></tr>";
    else
      {
      if (data.method.indexOf("ftp") >= 0)
        expURL = "ftp://pail.stanford.edu/export" + data.dir + "/" + thisfile;
      else
        expURL = "http://jsoc.stanford.edu" + data.dir + "/" + thisfile;
      tmp = "<A href='" + expURL + "' target='_blank'>" + thisfile + "</A>";
      valuetable = valuetable +  "<td>" + tmp + "</td></tr>";
      }
    }
  valuetable = valuetable + "</table>";
  return valuetable;
  }

function ExportNop()
  {
  }

function ExportRSChanged()
  {
  RecordCountNeeded = 1;
  $("CountButton").style.backgroundColor = colorYellow;
  }

function ExportNewRS()
  {
  $("CountButton").style.backgroundColor = colorNeutral;
  RecordCountNeeded = 0;
  if (SetRecordLimit()) return; // SetRecordLimit calls GetRSCount()
  GetDefaultFormat();
  NotifyProcessingCode();
  }

function SetRecordLimit()
  {
  var newLimit;
  newLimit = 1 * $("ExportRecordLimit").value;
  if (isNaN(newLimit))
    {  // newlimit is a non-numeric string
    newLimit = $("ExportRecordLimit").value;
    if (newLimit == "none")
      RecordLimit = 0;
    else
      {
      $("ExportRecordLimit").style.backgroundColor = colorRed;
      alert("RecordLimit must be a number or 'none'");
      RecordLimit = 0;
      }
    }
  else
    {
    if (newLimit == 0)
      $("ExportRecordLimit").value = "none";
    RecordLimit = newLimit;
    }
  $("ExportRecordLimit").style.backgroundColor = colorWhite;
  return(GetRSCount());
  }

function SetExportMethod()
  {
  var ExportMethodIndex = $("ExportMethod").selectedIndex;
  ExportMethodValue = $("ExportMethod").options[ExportMethodIndex].value;
  if (ExportMethodValue == "url_direct" || ExportMethodValue == "url_quick")
    {
    ExportMethodOK = 1;
    $("ProcessRow").style.display="none";
    var nProcs = ExportProcessingOptions.length;
    $(ExportProcessingOptions[0].id).checked = true;
    for (var iProc=1; iProc < nProcs; iProc++)
      { 
      var ExpOpt = ExportProcessingOptions[iProc];
      $(ExpOpt.id).checked = false;
      $(ExpOpt.rowid).style.display = "none";
      }
    if (ExportMethodValue == "url_direct")
      {
      $("ProtocolRow").style.display="table-row";
      ExportMethodIsDirect = 1;
      }
    else
      {
      $("ProtocolRow").style.display="none";
      ExportMethodIsDirect = 0;
      }
    $("FilenameFmtRow").style.display="none";
    ExportProtocolValue = "as-is";
    $("ExportProtocol").selectedIndex = 0;
    ExportCompressValue = "**NONE**";
    $("ExportCompress").selectedIndex = 1;
    $("CompressRow").style.display="none";
    $("RequestorRow").style.display="none";
    $("NotifyRow").style.display="none";
    }
  else if (ExportMethodValue == "url" ||
           ExportMethodValue == 'ftp' ||
           ExportMethodValue == "url-tar" ||
           ExportMethodValue == 'ftp-tar')
    {
    ExportMethodOK = 1;
    $("ProcessRow").style.display="table-row";
    $("ProtocolRow").style.display="table-row";
    $("FilenameFmtRow").style.display="table-row";
    $("RequestorRow").style.display="table-row";
    $("NotifyRow").style.display="table-row";
    if(ExportProtocolValue == "as-is")
      {
      ExportProtocolValue = "FITS";
      $("ExportProtocol").selectedIndex = 1;
      ExportCompressValue = "compress Rice";
      $("ExportCompress").selectedIndex = 0;
      }
    if(ExportProtocolValue == "FITS")
       $("CompressRow").style.display="table-row";
    }
  else
    {
    alert("Please set Method to url_quick, url_direct,  url, or ftp");
    ExportMethodOK = 0;
    }
  CheckRediness();
  }

function SetExportFilenameFmt()
  {
  if ($("ExportFilenameFmt").value.length != 0)
    ExportFilenameFmtOK = 1;
  else
    {
    alert("Please set non-empty name for FilenameFmt");
    ExportFilenameFmtOK = 0;
    }
  CheckRediness();
  }

function ProcessingEnabled()
  {
  if ($("ProcessingCheckboxHide").checked)
    $("ProcessingCheckbox").checked = false;
  if ($("ProcessingCheckbox").checked)
    {
    $("ProcessingCheckbox").checked = true;
    $("ProcessingCheckboxHide").checked = false;
    $("ProcessingShowCheckbox").style.display = "none";
    $("ExportProcessing").style.display = "table-row";
    }
  else
    {
    $("ProcessingCheckbox").checked = false;
    $("ProcessingCheckboxHide").checked = false;
    $(ExportProcessingOptions[0].id).checked = true;
    SetProcessing(0);
    $("ProcessingShowCheckbox").style.display = "table-row";
    $("ExportProcessing").style.display = "none";
    }
  }

function SetProcessing(ichecked)
  {
  if (ichecked > 0) $(ExportProcessingOptions[0].id).checked = false;
  ExportProcessingOK = 0;
  // Add recordLimit FIRST always.
  ExportProcessingArgs = "n=" + RecordLimit;
  var isok = 1;
  var nchecked = 0;
  var iProc = 0;
  var nProcs = ExportProcessingOptions.length;
  if ($(ExportProcessingOptions[0].id).checked) // no_op case must be first
    {
    nchecked++;
    for (iProc=1; iProc<nProcs; iProc++)
      {
      var ExpOpt = ExportProcessingOptions[iProc];
      $(ExpOpt.id).checked = false;
      $(ExpOpt.rowid).style.display = "none";
      }
    ExportProcessingArgs += "|no_op";
    }
  else
    {
    for (iProc=1; iProc<nProcs; iProc++)
      {
      var ExpOpt = ExportProcessingOptions[iProc];
      if ($(ExpOpt.id).checked)
        {
        nchecked++;
        $(ExportProcessingOptions[0].id).checked = false;
        if (ichecked == -2)
          {
          ExpOpt.Init(0);
          $(ExpOpt.rowid).style.display="table-row";
          isok = 0;
          }
        else
          {
// alert("ExpOpt.Init(1) called for iProc="+iProc);
          ExpOpt.Init(1);
          $(ExpOpt.rowid).style.display="table-row";
          var args = ExpOpt.Check();
          if (args.length > 0)
            {
            ExportProcessingArgs += "|"+args;
            }
          else
            {
            ExportProcessingArgs += "|--ERROR>>"+args+"<<";
    // alert("Error in processing parameters for "+$(ExpOpt.id).value);
            isok = 0;
            }
          }
        }
      else
        {
        $(ExpOpt.rowid).style.display="none";
        ExpOpt.Init(0);
        }
      }
    }
  if (nchecked == 0)
    {
    $(ExportProcessingOptions[0].id).checked = true;
    SetProcessing(0);
    }
        
  if (isok)
    ExportProcessingOK = 1;
  $("ExportProcessingHidden").value = ExportProcessingArgs;
// $("ProcArgsDisplay").innerHTML = ExportProcessingArgs;
  CheckRediness();
  }

function SetExportProtocol()
  {
  var ExportProtocolIndex = $("ExportProtocol").selectedIndex;
  ExportProtocolValue = $("ExportProtocol").options[ExportProtocolIndex].value;

  if (ExportProtocolValue == "MPEG")
    {
    ExportProtocolOK = 4;
    $("ImagingOptions").style.display="table-row";
    $("CompressRow").style.display="none";
    $("ExportProtocolHidden").value = "mpg";
    }
  else if (ExportProtocolValue == "MP4")
    {
    ExportProtocolOK = 4;
    $("ImagingOptions").style.display="table-row";
    $("CompressRow").style.display="none";
    $("ExportProtocolHidden").value = "mp4";
    }
  else if (ExportProtocolValue == "JPEG")
    {
    ExportProtocolOK = 3;
    $("ImagingOptions").style.display="table-row";
    $("CompressRow").style.display="none";
    $("ExportProtocolHidden").value = "jpg";
    }
  else if (ExportProtocolValue == "FITS")
    {
    ExportProtocolOK = 2;
    $("ImagingOptions").style.display="none";
    $("CompressRow").style.display="table-row";
    $("ExportProtocolHidden").value = "FITS";
    }
  else if (ExportProtocolValue == "as-is")
    {
    ExportProtocolOK = 1;
    $("ImagingOptions").style.display="none";
    $("CompressRow").style.display="none";
    $("ExportProtocolHidden").value = "as-is";
    }
  if (ExportProtocolOK == 4 || ExportProtocolOK == 3)
    if (ProtocolOptionsSet)
      ProtocolSetMinMax();
    else
      ProtocolImageInit(ExportProtocolOK);
  CheckRediness();
  }

function SetExportCompress()
  {
  var ExportCompressIndex = $("ExportCompress").selectedIndex;
  ExportCompressValue = $("ExportCompress").options[ExportCompressIndex].value;
  var protocolparam = ExportProtocolValue;
  if (ExportCompressValue == "compress Rice" &&  protocolparam == "FITS")
      {
      var tmp = SeriesName.toUpperCase();
      if ($("ExportProcessing").selectedIndex == 0 && (tmp == "AIA.LEV1" || tmp == "AIA.LEV1_EUV_12S" || tmp == "AIA.LEV1_UV_24S" || tmp == "AIA.LEV1_VIS_1H"))
        protocolparam = "as-is";
      else
        for (var i=0; i < SeriesInfo.segments.length; i++)
          {
          var segtype = SeriesInfo.segments[i].type;
          if (segtype == "float" || segtype == "double")
            protocolparam = protocolparam  + ",**NONE**";
          else
            protocolparam = protocolparam  + "," + ExportCompressValue;
          }
      $("ExportProtocolHidden").value = protocolparam;
      }
  ExportCompressOK = 1;
  CheckRediness();
  }

function SetExportUser()
  {
  if ($("ExportRequestor").value.length != 0)
    {
    Cookie.setData("user", $("ExportRequestor").value);
    ExportUserOK = 1;
    }
  else
    {
    ExportUserOK = 0;
    }
  CheckRediness();
  }

function SetExportNotify()
  {
  if (ExportMethodValue == "url_direct" || ExportMethodValue == "url_quick")
    {
    ExportNotifyOK = 1;
    return;
    }
  var tmp1 = $("ExportNotify").value.toUpperCase();
  if (tmp1.length == 0)
    {
    ExportNotifyOK = 0;
    $("ExportNotify").value = "NO";
    return;
    }
  if ( tmp1 ==  "SOLARMAIL" )
    {
    ExportNotifyOK = 2;
    if ($("ExportRequestor").value.length <= 0)
      {
      ExportUserOK = 0;
      ExportNotifyOK = 0;
      }
    }
  else if ( tmp1 == "NONE" || tmp1 == "NO")
    ExportNotifyOK = 3;
  else
    {
    if ($("ExportNotify").value.indexOf("@") < 0)
      { 
      ExportNotifyOK = 0;
      }
    else
      ExportNotifyOK = 1;
    }
  CheckRediness();
  }

function CheckRediness()
  {
  var status = ExportRecordSetOK * ExportMethodOK * ExportFilenameFmtOK * ExportProcessingOK * ExportProtocolOK;
  if ((Internal && ExportNotifyOK != 1) || ExportNotifyOK == 2)
    {
    if (ExportUserOK == 0 && ExportMethodValue != "url_quick")
      status = 0;
    }
  else
    status *= ExportNotifyOK; 
  if (status)
    $("ExportButton").style.backgroundColor = colorGreen;
  else
    $("ExportButton").style.backgroundColor = colorRed;
  }

function CheckExportParams()
  {
  if (ExportRecordSetOK == 0)
    {
    $("ExportButtonMsg").innerHTML = "Retry after RecordSet updated.";
    alert("RecordSet not verified, enter RecordSet then retry export request.");
    return 0;
    }
  SetExportMethod();
  if (ExportMethodOK == 0)
    {
    $("ExportButtonMsg").innerHTML = "Retry after entering export method";
    alert("Method not given, Enter export method then retry export request.");
    return 0;
    }
  SetExportFilenameFmt();
  if (ExportFilenameFmtOK == 0)
    {
    $("ExportButtonMsg").innerHTML = "Retry after entering export method";
    alert("FilenameFmt not given, Enter FilenameFmt then retry export request.");
    return 0;
    }
  SetProcessing(-1);
  if (ExportProcessingOK == 0)
    {
    $("ExportButtonMsg").innerHTML = "Retry after entering processing specs";
    alert("Processing details not correct, fix and retry export request.");
    return 0;
    }
  SetExportProtocol();
  if (ExportProtocolOK == 0)
    {
    $("ExportButtonMsg").innerHTML = "Retry after entering export protocol";
    alert("Protocol not given, Enter export protocol then retry export request.");
    return 0;
    }
  if ((ExportProtocolValue == "FITS" || ExportProtocolValue == "as-is") && ExportMethodValue != "url_quick")
    {
    SetExportCompress();
    }
  if ((Internal && ExportNotifyOK != 1) || ExportNotifyOK == 2)
    {
    SetExportUser();
    if (ExportUserOK == 0 && ExportMethodValue != "url_quick")
      {
      $("ExportButtonMsg").innerHTML = "Retry after entering your identification in Requestor field";
      alert("Requestor not given, Enter name you will use in Requestor field then retry export request.  This field in required if Notify is 'solarmail'");
      return 0;
      }
    }
    SetExportNotify();
    if (ExportNotifyOK == 0)
      {
      $("ExportButtonMsg").innerHTML = "Retry after entering your complete e-mail address or 'NO' or 'solarmail' in Notify field";
      alert("Notify email not given or confirmed, Enter 'solarmail' or 'no' or email address then retry export request.");
      return 0;
      }
  $("ExportButton").style.backgroundColor = colorGreen;
  return 1;
  }

// This is the code executed when the user clicks on the "Submit Export Request" button.
function GetExport()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  if (ExportReadyOK == 3)
    {
    alert("Processing request, please wait...");
    return;
    }
  if (CheckExportParams() == 0)
    return;
  if (ExportReadyOK == 0)
    {
    ExportReadyOK = 3;
    state = 2;
    Cookie.setData("state",state);
    $("ExportStatus").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
    $("ExportLocation").innerHTML = "";
    $("ExportButtonMsg").innerHTML = "Export request submitted, please wait...";
    $("ExportButton").value = "Processing ...";
    $("ExportButton").style.backgroundColor = colorDarkRed;
    var protocolparam = $("ExportProtocolHidden").value;
    var RecordSet = $("ExportRecordSet").value;
    var exportparameters = new Hash( {"op" : $("ExportOpID").value,
                 		      "ds" : RecordSet, 
                 		      "process" :  ExportProcessingArgs,
                 		      "requestor" : $("ExportRequestor").value,
                 		      "notify" : $("ExportNotify").value,
                                      "method" : ExportMethodValue,
                                      "filenamefmt" : $("ExportFilenameFmt").value,
			 	      "format" : "json",
                 		      "protocol" : protocolparam });
// alert(Object.inspect(exportparameters));
    // if (nsegsselected) exportparameters = exportparameters.merge({"seg": SegList});
    }
  else if (ExportReadyOK == 1)
    {
    var requestidtmp = $("RequestIdPlace").innerHTML;
    var exportparameters = new Hash( {"op" : "exp_status","requestid":requestidtmp});
    }
  else // ExportReadyOK == 2
    {
    // $("ExportRecordSet").value = "";
    ExportRecordSetOK = 0;
    alert("Export Request Complete, Please change RecordSet to make another request");
    return;
    }

  new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_FETCH,
    {
    method: 'post',
    parameters: exportparameters.toObject(),

    onSuccess: function(transport, json)
      {
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      var response = transport.responseText || "no response text";
      var status = ProcessExportResponse(response);
      var op = $("ExportOpID").value;
      },
    onFailure: function()
      {
      $("ExportButtonMsg").innerHTML = "Export Failure, Problem at JSOC facility.";
      ExportReadyOK = 0;
      $("ExportButton").value = "FAILURE ...";
      $("ExportButton").style.backgroundColor = "#FFB0B0";
      alert('Something went wrong...');
      },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  }


function GetReExport()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  ExportReadyOK = 3;
  state = 2;
  Cookie.setData("state",state);
  $("ExportStatus").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("ExportLocation").innerHTML = "";
  $("ReExportButtonMsg").innerHTML = "Export request submitted, please wait...";
  $("ReExportButton").value = "Processing ...";
  $("ReExportButton").style.backgroundColor = colorPink;
  var exportparameters = new Hash( {"op" : "exp_repeat",
                 		    "requestid" : $("ReRequestID").value,
			 	    "format" : "json",
                 		    "notify" : $("ReExportNotify").value });

  new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_FETCH,
    {
    method: 'post',
    parameters: exportparameters.toObject(),

    onSuccess: function(transport, json)
      {
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      var response = transport.responseText || "no response text";
      var status = ProcessExportResponse(response);
      },
    onFailure: function()
      {
      $("ReExportButtonMsg").innerHTML = "Export Failure, Problem at JSOC facility.";
      ExportReadyOK = 0;
      $("ReExportButton").value = "FAILURE ...";
      $("ReExportButton").style.backgroundColor = "#FFB0B0";
      alert('Something went wrong...');
      },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  }


function ProcessExportResponse(response)
  {
  var data = response.evalJSON();
  state = 3;
  Cookie.setData("state",state);
  if (data.status == 6)
    {
    alert("RequestID not found, status=6, error=" + data.error + "<br>Try again in a few seconds, may just be not ready to respond");
    ExportReadyOK = 0;
    $("ExportButton").value = "Retry";
    $("ExportButtonMsg").innerHTML = data.error;
    $("RequestIdPlace").innerHTML = "";
    $("ExportStatus").innerHTML = "RecordSet not found";
    $("ExportLocation").innerHTML = "";
    }
  else if (data.status == 5)
    {
    alert("Requested RequestID is too old, data no longer online, error=" + data.error) ;
    ExportReadyOK = 0;
    $("ExportButton").value = "Export timeout";
    $("ExportButtonMsg").innerHTML = data.error;
    $("RequestIdPlace").innerHTML = "";
    $("ExportStatus").innerHTML = "Export timeout";
    $("ExportLocation").innerHTML = "";
    state = 0;
    Cookie.setData("state",state);
    }
  else if (data.status == 4)
    {
    alert("Requested RecordSet not found or specification error, status=4, error=" + data.error +
      "<br>The export program failed.<br>" + "JSOC support see: jsoc/exports/tmp/" + data.requestid + ".runlog");
    ExportReadyOK = 0;
    $("ExportButton").value = "Bad RecordSet";
    $("ExportButtonMsg").innerHTML = data.error;
    $("RequestIdPlace").innerHTML = "";
    $("ExportStatus").innerHTML = "RecordSet not found";
    $("ExportLocation").innerHTML = "";
    state = 0;
    Cookie.setData("state",state);
    }
  else if (data.status == 3)
    {
    alert("Requested RecordSet is too large for chosen export method.  Please contact the JSOC for help.");
    $("ExportButtonMsg").innerHTML = "Export Too Large";
    ExportReadyOK = 0;
    $("ExportButton").value = "FAILURE ...";
    $("ExportButton").style.backgroundColor = "#D8D8D8";
    RequestID = data.requestid;
    $("RequestIdPlace").innerHTML = data.requestid;
    $("ExportStatus").innerHTML = "Needs Intervention, size=" + data.size + "MB, <br>" +
      data.count + " records found, " +
      data.error + ", contact: " + data.contact;
    $("ExportLocation").innerHTML = "";
    state = 0;
    Cookie.setData("state",state);
    }
  else if (data.status == 1 || data.status == 2 || data.status == 12)
    {
    ClearStatus();
    if (data.status == 1)
      $("StatusButtonMsg").innerHTML = "Export request is being processed";
    else  // status==2
      $("StatusButtonMsg").innerHTML = "Export request waiting for processing";
    ExportReadyOK = 1;
    $("ExportButton").value = "Request Export Status";
    $("ExportButton").style.backgroundColor = "#D8D8D8";
    //  XXXX FIX $("ExportStatus").innerHTML = "Processing, size=" + data.size + "MB, estimate " + data.wait + " seconds remaining";
    $("ExportStatus").innerHTML = "Processing, size estimate = " + data.size + " MB";
    RequestID = data.requestid;
    $("RequestIdPlace").innerHTML = data.requestid;
    $("StatusRequestID").value = data.requestid;
    Cookie.setData("requestid",data.requestid);
    $("ExportLocation").innerHTML = "";
    $("FileUploadInfo").innerHTML = "File upload done, " + data.rcount + " records requested.";
    if (ExportFromFileList == 1)
      {
      FinishFileUpload();
      $("FileUploadInfoRow").style.display="table-row";
      }
    }
  else // status == 0 implies url_quick format and all online as-is
    {
    var valuetable = "";
    state = 0;
    Cookie.setData("state",state);
    Cookie.setData("requestid","");
    var count = data.count;
    $("ExportButtonMsg").innerHTML = "Fetch your data at URLs below before starting next request";
    ExportReadyOK = 2;
    $("ExportButton").value = "Submit Export Request";
    $("ExportButton").style.backgroundColor = "#D8D8D8";
    RequestID = data.requestid;
    if (RequestID.length == 0) RequestID = "N.A.";
    $("RequestIdPlace").innerHTML = RequestID;
    $("ExportStatus").innerHTML = "Data Ready, size=" + data.size + "MB";
    valuetable = CreateDataTable(data, valuetable);
    $("ExportLocation").innerHTML =  valuetable + "<br>";
    $("FileUploadInfo").innerHTML = "File upload done, " + data.rcount + " records requested.";
    if (ExportMethodValue == "url_quick")
      {
      if (ExportMethodIsDirect) // was url_direct on call
        {
        if (count > 1)
            $("ExportLocation").innerHTML =  "<b>Multiple files returned, direct fetch not possible. </b><p>" +
              valuetable + "<br>";
        else
            {
            var path = encodeURI("http://jsoc.stanford.edu" + data.dir + "/" + data.data[0].filename);
    //      doucment.write("<link type=\"application/fits\" href="+path+" />");
    //      fetch image
            }
        }
      else // url_quick on call
        $("ExportLocation").innerHTML = valuetable + "<br>";
      }
    else
      $("ExportLocation").innerHTML =  valuetable + "<br>";
    if (ExportFromFileList == 1)
      {
      FinishFileUpload();
      $("FileUploadRow").style.display="none";
      $("FileUploadInfoRow").style.display="table-row";
      }
    }
  return(data.status);
  }

function ClearStatus()
  {
  $("StatusButton").style.backgroundColor = "#D8D8D8";
  $("StatusStatus").innerHTML = "";
  $("StatusValue").innerHTML = "";
  $("StatusOther").innerHTML = "";
  $("StatusButtonMsg").innerHTML = "Waiting new status request...";
  $("StatusButton").value = "Submit Status Request";
  $("StatusRequestID").value = "";
  $("StatusLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("TarFileLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("KeywordFileLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("StatusDataLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  }

function GetStatus()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  if ($("StatusRequestID").value.length == 0)
    {
    alert("You must provide a RequestID");
    return;
    }
  var is_IN = ($("StatusRequestID").value.search("_IN") > 0);
  if (is_IN && Host == "jsoc.stanford.edu")
    {
    alert("RequestID ending with '_IN' belongs to jsoc2.stanford.edu, use proper RequestID or swtich to jsoc2.stanford.edu.");
    return;
    }
  if (!is_IN && Host == "jsoc2.stanford.edu")
    {
    alert("RequestID without '_IN' belongs to jsoc.stanford.edu, use proper RequestID or switch to jsoc.stanford.edu.");
    return;
    }
  $("StatusLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("TarFileLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("KeywordFileLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("StatusDataLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("StatusButton").style.backgroundColor = colorPink;
  $("StatusStatus").innerHTML = "";
  $("StatusValue").innerHTML = "";
  $("StatusOther").innerHTML = "";
  $("StatusButtonMsg").innerHTML = "Processing status request ...";
  $("StatusButton").value = "Processing ...";
  new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_FETCH,
    {
    method: 'get',
    parameters: {"op" : "exp_status", "requestid" : $("StatusRequestID").value }, 

    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no response text";
      var data = response.evalJSON();
      state = 2;
      Cookie.setData("state",state);
      if (data.status == 6)
        {
        alert("RequestID not found, status=6, error=" + data.error + "<br>Try again in a few seconds, may just be not ready to respond");
        StatusReadyOK = 0;
        $("StatusButton").value = "Bad RecordSet";
        $("StatusButtonMsg").innerHTML = data.error + ", processing perhaps not started yet or bad RequestID";
        $("StatusValue").innerHTML = "Requested RecordSet returned error status=6";
        $("StatusOther").innerHTML = $("StatusRequestID").value + " not found,  msg=" + data.error;
        $("ReExportDiv").style.display = "none";
        state = 1;
        Cookie.setData("state",state);
        }
      else if (data.status == 5)
        {
        alert("Requested RequestID is too old, data no longer online, error=" + data.error);
        ExportReadyOK = 0;
        $("ExportButton").value = "Export timeout";
        $("ExportButtonMsg").innerHTML = data.error;
        $("RequestIdPlace").innerHTML = "";
        $("ExportStatus").innerHTML = "Export timeout";
        $("ExportLocation").innerHTML = "";
        $("ReRequestID").value = data.requestid;
        $("ReExportDiv").style.display = "block";
        }
      else if (data.status == 4)
        {
        alert("Requested RecordSet not found or specification error, status=4, error=" + data.error + "<br>The export program failed.<br>" +
		"JSOC support see: jsoc/exports/tmp/" + data.requestid + ".runlog");
        StatusReadyOK = 0;
        $("StatusButton").value = "Bad RecordSet";
        $("StatusButtonMsg").innerHTML = data.error;
        $("StatusValue").innerHTML = "Requested RecordSet returned error status=4";
        $("StatusOther").innerHTML = $("StatusRequestID").value + "msg=" + data.error;
        $("ReExportDiv").style.display = "none";
        }
      else if (data.status == 3)
        {
        alert("Requested RecordSet is too large for chosen export method.  Please contact the JSOC for help.");
        $("StatusButtonMsg").innerHTML = "Export Too Large";
        $("StatusButton").value = "FAILURE ...";
        $("StatusButton").style.backgroundColor = "#D8D8D8";
        $("StatusStatus").innerHTML = "Needs Intervention, size=" + data.size + "MB, contact: " + data.contact;
        $("RequestIdPlace").innerHTML = data.requestid;
        $("StatusValue").innerHTML = "Requested RecordSet returned error status=3";
        $("StatusOther").innerHTML = $("StatusRequestID").value +
           "<br>The requested RecordSet is too large for chosen export method." +
           "<br>" + data.count + " records found, " + data.error +
           "<br>Please contact the JSOC for help." ;
        $("ReExportDiv").style.display = "none";
        }
      else if (data.status == 1 || data.status == 2)
	{
        if (data.status == 1)
          $("StatusButtonMsg").innerHTML = "Export request is being processed";
        else  // status==2
          $("StatusButtonMsg").innerHTML = "Export request waiting for processing";
        $("StatusButton").value = "Submit Status Request";
        $("StatusButton").style.backgroundColor = "#D8D8D8";
        // XXXXX FIX $("StatusStatus").innerHTML = "Processing, size=" + data.size + "MB, estimate " + data.wait + " seconds remaining";
        var waiting = 10 - data.wait;
        $("StatusStatus").innerHTML = "Processing, size estimate = " + data.size + " MB, " + waiting + " seconds since request";
        $("RequestIdPlace").innerHTML = data.requestid;
        $("ReExportDiv").style.display = "none";
        state = 1;
        Cookie.setData("state",state);
        }
      else // status == 0
        {
        var valuetable = "";
        $("StatusButtonMsg").innerHTML = "Please only click once for status request.";
        $("StatusButton").value = "Submit Status Request";
        $("StatusButton").style.backgroundColor = "#D8D8D8";
        $("StatusStatus").innerHTML = "Data Ready, size=" + data.size + "MB";
        $("RequestIdPlace").innerHTML = data.requestid;
        var StatusLoc;
	if (data.method.indexOf("ftp") >= 0)
          StatusLoc = "ftp://pail.stanford.edu/export" + data.dir + "/";
        else
          StatusLoc = "http://jsoc.stanford.edu" + data.dir + "/";
        $("StatusLocation").innerHTML = "<A HREF='" + StatusLoc + "' target='_blank'>" + StatusLoc + "</A>";
        if (data.method.indexOf("-tar") > 0)
          {
          $("TarFileLocation").innerHTML = "<A HREF='" + data.tarfile + "'>" + data.tarfile + "</A>";
          $("TarFileLocationRow").style.display = "table-row";
          }
        else
          $("TarFileLocationRow").style.display = "none";
        if (data.protocol.indexOf("as-is") >= 0)
          {
          $("KeywordFileLocation").innerHTML = "<A HREF='" + data.keywords + "' target='_blank'>" + data.keywords + "</A>";
          $("KeywordFileLocationRow").style.display = "table-row";
          }
        else
          $("KeywordFileLocationRow").style.display = "none";

        $("ExportStatus").innerHTML = "Data Ready, size=" + data.size + "MB";
        valuetable = CreateDataTable(data, valuetable);
        $("StatusDataLocation").innerHTML =  valuetable + "<br>";
        $("StatusValue").innerHTML = "Success";
        $("StatusOther").innerHTML = "List formats are index.html, index.json, and index.txt<br>" +
             "export script file is " + $("StatusRequestID").value +".drmsrun" ;
        if (ExportFromFileList  == 1)
          FinishFileUpload();
        $("ReExportDiv").style.display = "none";
        state = 1;
        Cookie.setData("state",state);
        }
      },
    onFailure: function()
      {
      $("StatusButtonMsg").innerHTML = "Export Failure, Problem at JSOC facility.";
      $("StatusButton").value = "FAILURE ...";
      $("StatusButton").style.backgroundColor = "#FFB0B0";
      alert('Something went wrong...');
      },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  }

</script>

</head>
<body bgcolor="#E0F0FF" onload="OnLoadInit();" >
<div id="header">
<img src="http://hmi.stanford.edu/images/web/JSOC_120.gif"
  style="vertical-align:middle;height:60" alt="JSOC logo">
&nbsp;&nbsp;&nbsp;
<b><big style="vertical-align:middle">&nbsp;&nbsp;JSOC Data Export</big></b>
&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;
<input type="button" value="reset page" onClick="ReInitPage();" >
&nbsp;&nbsp;&nbsp;
<input id="TipsOnOffButton" type="button" value="Turn Help Off" onClick="ToggleHelp();" >
&nbsp;&nbsp;<span id="AjaxBusy">0</span> Requests Pending
<span id='systemWorking'>, Loading...</span>
<!-- <br clear=all> -->
<hr>
</div> <!-- end div header -->
<div id="ExportRequestDiv">
<b>JSOC Data Export Request Generation</b>
<span id="RecordSetExample">
&nbsp; &nbsp;
<a href="ExportDataErrorHelp.html" target="JSOC_Help">Help with Error Messages</a>
</span>
<p>
If the Method is changed from "url_quick" or "url_direct" you will have additional options to specify.
"url-direct" is temporarily disabled.
<p>
After the request is submitted
for Methods of "url", "ftp", "url-tar" or "ftp-tar" you will recieve ON THIS PAGE a "Request_ID" that will be used
to access the data when it is ready.
<p>
If you enter an email address you will be notified when the data is ready.
If you do not provide an email address you must leave this page open or save the Request_ID in order to
access the data.
<p>

<form id='FileUploadFormID' name='FileUploadForm'
  action=''
  target="FileUploadFrame"
  enctype='multipart/form-data' method='post'>

<input type='hidden' id='ExportOpID' name='op'  value='exp_request' >
<input type='hidden' id="ExportProtocolHidden" name='protocol' value='as-is' >
<input type='hidden' id="ExportProcessingHidden" name='process' value='no_op' >

  <table>
    <tr>
      <td>RecordSet from file</td><td><span id="RecordFromFileHelp" class="tip">?</span></td>
      <td colspan="2"><input type="checkbox" name="FileUploadCheckbox" id="FileUploadCheckbox" onChange="FileUploadWanted();">
        Check box to allow upload of RecordSet list file, file will be requested after Submit button click.</td>
    </tr>
  
    <tr id="RecordSetRow">
      <td style="width:10em" >RecordSet</td><td><span id="RecordSetHelp" class="tip">?</span></td><td colspan="2">
        <input id="ExportRecordSet" type="text" name="ds" value="" onChange="ExportRSChanged();" onkeydown="return OnEnterKey(event,ExportNewRS);"> </td>
    </tr>
  
    <tr id="RecordLimitRow">
      <td>Record Limit</td><td><span id="RecordLimitHelp" class="tip">?</span></td>
      <td><input id="ExportRecordLimit" type="text" name="ExportReccordLimit" value="none" style="width:15em" onChange="SetRecordLimit();" ></td>
      <td>Optional manual limit to number of records to export.</td>
    </tr>
  
    <tr id="RecordCountRow">
      <td>Record Count</td><td><span id="RecordCountHelp" class="tip">?</span></td>
      <td><span id="RSCountPlace" style="width:10em;background-color:#FFF8DC"></span></td>
      <td><input id="CountButton" type="button" value="Recount" onClick="ExportNewRS();" >&nbsp;
          Limit for AIA to about 15,000 and for HMI about 30,000 in each request.</td>
    </tr>
  
    <tr id="MethodRow">
      <td>Method</td>
      <td><span id="MethodHelp" class="tip">?</span></td>
      <td><select id="ExportMethod" type="text" name="method" style="width:15em" onChange="SetExportMethod();" >
        <option value="url_direct">url_direct
        <option value="url_quick">url_quick
        <option value="url">url
        <option value="ftp">ftp
        <option value="url-tar">url-tar
        <option value="ftp-tar">ftp-tar
        </select> </td>
      <td>Choose method, url_quick or url for now. url_quick implies protocol of "as-is"</td>
    </tr>
  
    <tr id="FilenameFmtRow">
      <td>Filename Format</td>
      <td><span id="FilenameFmtHelp" class="tip">?</span></td>
      <td colspan="2">
        <input id="ExportFilenameFmt" type="text" name="filenamefmt" value="no_op" style="width:30em" onChange="SetFilenameFmt();" />
        File name template.</td>
      </td>
    </tr>

    <!-- Inserted from old processing.html -->

    <!-- Processing Select -->
    <tr id="ProcessRow">
      <td>
        Processing
      </td>
      <td>
        <span id="ProcessingHelp" class="tip">?</span>
      </td>
      <td colspan="2">
        <span id="ProcessingShowCheckbox">
          <input id="ProcessingCheckbox" type="checkbox" checked="0" onChange="ProcessingEnabled();" >
          &nbsp; Enable Processing
        </span>
        <span id="ExportProcessing" style="display:none" ></span>
      </td>
    </tr>
    <!-- END Processing Select -->
    
    <!-- BEGIN AIA_SCALE -->
    <tr id="ProcessAiaScale">
      <td>&nbsp;&nbsp;&nbsp;&nbsp;AIA_Scale</td> 
      <td><span id="AiaScaleHelp" class="tip">?</span></td> 
      <td colspan="2">
        <table style="border-style:solid" >
        <tr>
        <td>Normalize image scale to AIA standard 0.6 arc-sec per pixel is enabled <b>Only for aia.lev1 for now.</b></td>
        </tr>
        </table>
      </td>
    </tr>
    <!-- END AIA_SCALE -->
    
    <!-- BEGIN RESIZE -->
    <tr id="ProcessResize" style="display:none">
      <td>&nbsp;&nbsp;&nbsp;&nbsp;Resize</td>
      <td><span id="ResizeHelp" class="tip">?</span></td>
      <td colspan="2">
        <table style="border-style:solid">
          <tr>
            <td>Please specify resize options:</td>
          </tr>
          <tr>
            <td colspan="2">
              <form>
              Co-register images to:
              <input value="0" id="ResizeSunCenter" name="ResizeRegisterTo" type="radio" onChange="ResizeSet('register_to')" />Sun center or
              <input value="1" id="ResizeFirstImage" name="ResizeRegisterTo" type="radio" onChange="ResizeSet('register_to')" />First Image
              <input value="2" id="ResizeNoInterp" name="ResizeRegisterTo" type="radio" onChange="ResizeSet('register_to')" />No Change
              </form>
            </td>
          </tr>
          <tr>
            <td colspan="2">
              <form>
              Interpolation method is:
              <input value="bicubic" id="ResizeBicubic" name="ResizeMethod" type="radio"  onChange="ResizeSet('method')" />bicubic or
              <input value="nearest" id="ResizeNearest" name="ResizeMethod" type="radio"  onChange="ResizeSet('method')" />nearest
              </form>
              <input id="ResizeDoScale" type="checkbox" name="ResizeDoScale" onChange="ResizeSet('do_scale')" />
              Do scale change as well as registration.
            </td>
          </tr>
          <tr id="ResizeScaleRow" style="display:table-row">
            <td colspan="2">
              <input id="ResizeCdelt" type="text" name="ResizeCdelt" style="width:12em;background-color:#FFFFFF" value="1.0"
               onChange="ResizeSet('scale')" />
              Target scale in arcsec per pixel. (for AIA lev1p5 use 0.6)
            </td>
          </tr>
          <tr>
            <td colspan="2">
              <input id="ResizeCrop" type="checkbox" name="ResizeCrop" onChange="ResizeSet('crop')" />
              Crop pixels that are located outside the limb.<br>
            </td>
          </tr>
          <tr>
            <td colspan="2">
              <input id="ResizeReplicate" type="checkbox" name="ResizeReplicate" value="0" onChange="ResizeSet('replicate')" />
              Replicate needed pixels, select if HMI and cropped to get NaNs instead of 0.0 for extra pixels.
            </td>
          </tr>
        </table>
	</td>
	</tr>
    <!-- END RESIZE -->

    <!-- BEGIN REBIN -->
    <tr id="ProcessRebin" style="display:none">
      <td>&nbsp;&nbsp;&nbsp;&nbsp;Rebin</td>
      <td><span id="RebinHelp" class="tip">?</span></td>
      <td colspan="2">
        <table style="border-style:solid">
          <tr>
            <td>Please specify rebin options:</td>
          </tr>
          <tr>
            <td>
              <select id="RebinMethod" size=1 name="RebinMethod" style="width:12em;background-color:#FFFFFF"
                onChange="RebinSet('method')">
                 <option value="boxcar">boxcar</option>
                 <option value="gaussian">gaussian</option>
              </select> Re-binning method to use.
            </td>
          </tr>
          <tr>
            <td>
              <input id="RebinScale" type="text" name="RebinScale" style="width:12em;background-color:#FFFFFF" value="1.0"
               onChange="RebinSet('scale')" />
              Scaling factor to apply to image, < 1.0 for smaller images.
            </td>
          </tr>
          <tr id="RebinFWHMRow">
            <td>
              <input id="RebinFWHM" type="text" name="RebinFWHM" style="width:12em;background-color:#D88080" value="-1.0"
                onChange="RebinSet('fwhm')" />
              Width in pixels of smoothing Gaussian function (FWHM).
            </td>
          </tr>
          <tr id="RebinNvectorRow">
            <td>
              <input id="RebinNvector" type="text" name="RebinNvector" style="width:12em;background-color:#D88080" value="-1.0"
                onChange="RebinSet('nvector')" />
              Length in pixels of smoothing Gaussian function.
            </td>
          </tr>
          <tr>
            <td>
              <input id="RebinCrop" type="checkbox" name="RebinCrop" onChange="RebinSet('crop')" />
              Crop pixels that are greater than rsun_obs units from the center of the image.
            </td>
          </tr>
          <tr>
            <td>
              <input id="RebinRotate" type="checkbox" name="RebinRotate" value="roton" onChange="RebinSet('rotate')" />
              Rotate image by 180 degrees if needed for north up.
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <!-- END REBIN -->

    <!-- BEGIN HG_PATCH -->
    <tr id="ProcessHgPatch">
      <td>&nbsp;&nbsp;&nbsp;&nbsp;HG_Patch</td> 
      <td><span id="HgPatchHelp" class="tip">?</span></td> 
      <td colspan="2">
        <table style="border-style:solid" >
        <tr>
        <td colspan="3">
        <b>WARNING - Explicit Record Limit does not work for hg_patch processing</b>
        </td>
        </tr>
        <tr>
        <td colspan="3">
          Specify patch to extract and track.  The default is to track the patch from East limb to West limb. 
          T_START and/or T_STOP can limit the tracking as can a recodrset specification. 
          If only the seriesname is given, the query will be made for the last record only, [$],
          to prevent the export tools from doing a full check on the series. 
          In this special case, the final record of the series will not actually be used unless it is in the bounds of
          T_START and T_STOP and is a time with the patch on the disk.
          <p> 
          The patch icenter locationa(x,y) can be specified in Carrington Rot, Lat, and Longitude or with a reference time and location in arcsec,
          or degrees from CM and equator or in pixels from the lower left of the image (1,1) before any implied rotation or center offset. 
          One of T_REF or CAR_ROT is required to locate the patch in time. 
          Width and Height are used to specify the size of the box.
          The units of width and height must be specified and can be pixels, arcsec, or degrees. 
          The pixel size is computed from these box sizes when they are at disk center.
        </td>
        </tr>
        <tr>
           <td width=20>Series</td>
           <td>
           <select id="HgSerList" type="text" size=1 style="width:20em;background-color:#FFFFFF" onChange="HgSeriesSelect();"></select>
           </td>
           <td>&nbsp;</td>
        </tr> 
        <tr>
           <td>Options</td>
           <td colspan="2">
           Tracking:&nbsp;
           <input id="HgTrack" type="checkbox" name="HgTrack" onChange="HgPatchCheck();">
           &nbsp;
           &nbsp;
           &nbsp;
           &nbsp;
           <span id="HgNoaaTip" class="tip">?</span>
           NOAA AR number:&nbsp;
             <input id="HgNOAA" type="text" style="width:8em;background-color:#FFFFFF" value="NotSpecified" onChange="HgPatchGetNoaa();">
          </td>
        </tr>
        <tr>
           <td>T_START </td>
           <td>
           <input id="HgTStart" type="text" name="HgTStart" style="width:20em;background-color:#FFFFFF" value="NotSpecified" onChange="HgPatchCheck();">
           </td>
           <td rowspan=2>&nbsp;Note - T_START and T_STOP are not used if the RecordSet is specified explicitly above.  Use '[$]' if you
              want to use T_START, T_STOP, and/or CADENCE to specify the coverage you want.</td>
        </tr>
        <tr>
           <td>T_STOP </td>
           <td>
           <input id="HgTStop" type="text" name="HgTStop" style="width:20em;background-color:#FFFFFF" value="NotSpecified" onChange="HgPatchCheck();">
           </td>
        </tr>
        <tr>
           <td>CADENCE</td> 
           <td>
           <input id="HgTDelta" type="text" name="HgTDelta" style="width:12em;background-color:#FFFFFF" value="NotSpecified" onChange="HgPatchCheck();">
           </td>
           <td>&nbsp;Note - CADENCE is not used if the RecordSet is specified explicitly in the '[...]' notation.</td>
        </tr>
        <tr>
           <td>LocUnits</td>
           <td>
           <select id="HgLocType" type="text" name="HgLocType" style="width:20em;background-color:#FFFFFF" value="stony" onChange="HgPatchCheck();">
             <option value="stony">Stonyhurst degrees 
             <option value="arcsec">arcsec from center 
             <option value="pixels">pixels from (1,1) 
    	 <option value="carrlong">Carrington LatLon 
    	 </select>
           </td>
           <td>&nbsp;</td>
        </tr> 
        <tr id="HgTRefLi">
           <td>T_REF</td>
           <td>
           <input id="HgTRef" type="text" name="HgTRef" style="width:20em;background-color:#D88080" value="NotSpecified" onChange="HgPatchCheck();">
           </td>
           <td>&nbsp;</td>
        </tr>
        <tr id="HgCarrLi">
           <td>CAR_ROT </td>
           <td>
           <input id="HgCarrot" type="text" name="HgCarrot" style="width:20em;background-color:#D88080" value="NotSpecified" onChange="HgPatchCheck();">
           </td>
           <td>&nbsp;</td>
        </tr>
        <tr>
           <td>X</td>
           <td>
           <input id="HgX" type="text" name="HgX" style="width:12em;background-color:#D88080" value="NotSpecified" onChange="HgPatchCheck();">
           </td>
           <td>&nbsp;</td>
        </tr>
        <tr>
           <td>Y</td>
           <td>
           <input id="HgY" type="text" name="HgY" style="width:12em;background-color:#D88080" value="NotSpecified" onChange="HgPatchCheck();">
           </td>
           <td>&nbsp;</td>
        </tr>
        <tr>
           <td>BoxUnits</td>
           <td>
           <select id="HgBoxType" type="text" name="HgBoxType" style="width:20em;background-color:#FFFFFF" value="pixels" onChange="HgPatchCheck();">
             <option value="pixels">pixels 
             <option value="degrees">degrees 
             <option value="arcsec">arcsec 
             </select>
           </td>
           <td>&nbsp;</td>
        </tr>
        <tr>
           <td>Width </td>
           <td>
           <input id="HgWide" type="text" name="HgWide" style="width:12em;background-color:#D88080" value="NotSpecified"  onChange="HgPatchCheck();">
           </td>
           <td>&nbsp;</td>
        </tr>
        <tr>
          <td>Height </td>
          <td>
          <input id="HgHigh" type="text" name="HgHigh" style="width:12em;background-color:#D88080" value="NotSpecified"  onChange="HgPatchCheck();">
          </td>
           <td>&nbsp;</td>
        </tr>
        </table>
      </td> 
    </tr>
    <!-- END HG_PATCH -->

    <!-- BEGIN IM_PATCH -->
    <tr id="ProcessImPatch">
      <td>&nbsp;&nbsp;&nbsp;&nbsp;IM_Patch</td> 
      <td><span id="ImPatchHelp" class="tip">?</span></td> 
      <td colspan="2">
        <table style="border-style:solid" >
        <tr>
        <td colspan="3">
          Image Patch Extract - used to export rectangular sub-frames from a sequence of images.
          The patch may be stationary or tracked at the Carrington rate.
          <br>
          If only the seriesname is given, the query will be made for the last record only, [$], unless tracking
          a from the east limb is requested.
          <br>
          If the limb checkboxes are checked, tracking will begin or end at the indicated limb(s).
          If the "register" checkbox is checked, the patch will be interpolated to the desired location.
          If "register" is not-checked the patch will be exact pixel cutout from the input image.
        </td>
        </tr>
        <tr>
        <td colspan="3">
        RecordSet:&nbsp;
        <span id="ImRecordSet"></span>
        </td>
        </tr>
        <tr>
           <td>Options</td>
           <td colspan="2">
           <input id="ImTrack" type="checkbox" name="ImTrack" onChange="ImPatchCheck();">
           &nbsp;Tracking,
           &nbsp;
           &nbsp;
           <input id="ImRegister" type="checkbox" name="ImRegister" onChange="ImPatchCheck();">
           &nbsp;Register,
           &nbsp;
           &nbsp;
           <input id="ImCrop" type="checkbox" name="ImCrop" onChange="ImPatchCheck();">
           &nbsp;Crop,
           &nbsp;
           &nbsp;
           NOAA AR number:&nbsp;
           <span id="ImNoaaTip" class="tip">?</span>
           <input id="ImNOAA" type="text" style="width:8em;background-color:#FFFFFF" 
              value="NotSpecified" onChange="ImPatchGetNoaa();">
          </td>
        </tr>
        <tr>
           <td>T_START </td>
           <td colspan="2">
           <span id="ImTStartHelp" class="tip">?</span>
           <input id="ImTStart" type="text" name="ImTStart" style="width:20em;background-color:#FFFFFF" value="NotSpecified" onChange="ImPatchSet(1);">
           &nbsp; <input id="ImEastLimb" type="checkbox" onChange="ImPatchCheck();"> &nbsp; Check for start at east limb.
           </td>
        </tr>
        <tr>
           <td>T_STOP </td>
           <td colspan="2">
           <span id="ImTStopHelp" class="tip">?</span>
           <input id="ImTStop" type="text" name="ImTStop" style="width:20em;background-color:#FFFFFF" value="NotSpecified" onChange="ImPatchSet(2);">
           &nbsp; <input id="ImWestLimb" type="checkbox" onChange="ImPatchCheck();"> &nbsp; Check for start at west limb.
           </td>
        </tr>
        <tr>
           <td>CADENCE</td> 
           <td colspan="2">
           &nbsp;<span id="ImCadenceHelp" class="tip">?</span>
           <input id="ImTDelta" type="text" name="ImTDelta" style="width:12em;background-color:#FFFFFF" value="NotSpecified" onChange="ImPatchCheck();">
           </td>
        </tr>
        <tr>
           <td>LocUnits</td>
           <td colspan="2">
           &nbsp;<span id="ImLocUnitsHelp" class="tip">?</span>
           <select id="ImLocType" type="text" name="ImLocType" style="width:20em;background-color:#FFFFFF" value="stony" onChange="ImPatchSet(3);">
             <option value="stony">Stonyhurst degrees 
             <option value="arcsec">arcsec from center 
             <option value="pixels">pixels from (1,1) 
    	 <option value="carrlong">Carrington LatLon 
    	 </select>
           &nbsp; Units for X and Y to select center of extracted patch
           </td>
        </tr> 
        <tr id="ImTRefLi">
           <td>T_REF</td>
           <td colspan="2">
           &nbsp;<span id="ImTRefHelp" class="tip">?</span>
           <input id="ImTRef" type="text" name="ImTRef" style="width:20em;background-color:#D88080" value="NotSpecified" onChange="ImPatchCheck();">
           &nbsp; Reference time for X,Y to define center of extract patch.
           </td>
        </tr>
        <tr id="ImCarrLi">
           <td>CAR_ROT </td>
           <td colspan="2">
           &nbsp;<span id="ImCARROTHelp" class="tip">?</span>
           <input id="ImCarrot" type="text" name="ImCarrot" style="width:20em;background-color:#D88080" value="NotSpecified" onChange="ImPatchCheck();">
           &nbsp; Carrington rotation number for X and Y, latitude and longitude.
           </td>
        </tr>
        <tr>
           <td>X</td>
           <td colspan="2">
           &nbsp;<span id="ImXHelp" class="tip">?</span>
           <input id="ImX" type="text" name="ImX" style="width:12em;background-color:#D88080" value="NotSpecified" onChange="ImPatchCheck();">
           &nbsp; East-West location of patch center.
           </td>
        </tr>
        <tr>
           <td>Y</td>
           <td colspan="2">
           &nbsp;<span id="ImYHelp" class="tip">?</span>
           <input id="ImY" type="text" name="ImY" style="width:12em;background-color:#D88080" value="NotSpecified" onChange="ImPatchCheck();">
           &nbsp; North-South location of patch center.
           </td>
        </tr>
        <tr>
           <td>BoxUnits</td>
           <td colspan="2">
	   &nbsp;<span id="ImBoxUnitsHelp" class="tip">?</span>
           <select id="ImBoxType" type="text" name="ImBoxType" style="width:20em;background-color:#FFFFFF" value="pixels" onChange="ImPatchCheck();">
             <option value="pixels">pixels 
             <option value="degrees">degrees 
             <option value="arcsec">arcsec 
             </select>
           &nbsp; Width of extracted patch, Units determined be BoxUnits.
           </td>
        </tr>
        <tr>
           <td>Width </td>
           <td colspan="2">
           &nbsp;<span id="ImWideHelp" class="tip">?</span>
           <input id="ImWide" type="text" name="ImWide" style="width:12em;background-color:#D88080" value="NotSpecified"  onChange="ImPatchCheck();">
           &nbsp; Width of extracted patch, Units determined be BoxUnits.
           </td>
        </tr>
        <tr>
          <td>Height </td>
          <td colspan="2">
           &nbsp;<span id="ImHighHelp" class="tip">?</span>
          <input id="ImHigh" type="text" name="ImHigh" style="width:12em;background-color:#D88080" value="NotSpecified"  onChange="ImPatchCheck();">
           &nbsp; Height of extracted patch, Units determined be BoxUnits.
          </td>
        </tr>
        <tr>
          <td>Verify </td>
          <td colspan="2">
           &nbsp;<span id="ImVerifyHelp" class="tip">?</span>
          <input type="button" style="width:12em" value="Check params" onClick="ImPatchCheck();">
          &nbsp;
          <span id="ImVerify" style="width:12em;background-color:#D88080">Not Ready</span>
          </td>
        </tr>
        </table>
      </td> 
    </tr>
    <!-- END IM_PATCH -->

<tr><td colspan="4"><span id="ProcArgsDisplay"></span></td></tr>
    <!-- End of processing  special code -->

    <!-- Insert from protocols.html -->
    <tr id="ProtocolRow">
      <td>Protocol</td>
      <td><span id="ProtocolHelp" class="tip">?</span></td>
      <td><select id="ExportProtocol" name="rawprotocol" style="width:15em"  onChange="SetExportProtocol();">
          <option value="as-is">as-is
          <option value="FITS">FITS
          <option value="JPEG">JPEG
          <option value="MPEG">MPEG
          <option value="MP4">MP4
        </select> </td>
      <td>Choose protocol, "FITS", "JPEG", "MPG", "MP4", or "as-is". Note AIA lev1 FITS,compressed is same as "as-is".</td>
    </tr>
    <tr id="ImagingOptions">
      <td>Images</td>
      <td><span id="ImagesHelp" class="tip">?</span></td>
      <td colspan="2">
        <table>
        <tr>
          <td>
            For:&nbsp;
            <span id="ImageSer" name="ImageSer" ></span>
          </td>
          <td>
            ,&nbsp;ColorTable:&nbsp;
            <select id="ImageCT" type="text" size=1 name="ImageCT" onChange="ProtocolSetColorTable();" ></select>
          </td>
          <td>
            &nbsp;&nbsp;Min:&nbsp;
            <input id="ImageMin" type="text" name="ImageMin" value="" onChange="ProtocolSetMinMax();" >
          </td>
          <td>
            &nbsp;&nbsp;Max:&nbsp;
            <input id="ImageMax" type="text" name="ImageMax" value="" onChange="ProtocolSetMinMax();" >
            <b>&nbsp;NOTE changes to colortable are not seen yet.</b>
          </td>
        </tr>
        </table>
      </td>
    </tr>
    <!-- End of insert from protocols.html -->

    <tr id="CompressRow">
      <td>Compression</td>
      <td><span id="CompressHelp" class="tip">?</span></td>
      <td><select id="ExportCompress" name="compress" style="width:15em"  onChange="SetExportCompress();">
        <option value="compress Rice" selected="selected" >compress Rice
        <option value="**NONE**">**NONE** </select> </td>
      <td>Choose compression parameters for each segment., **NONE** for no compression.</td>
    </tr>
  
    <tr id="RequestorRow">
      <td>Requestor</td>
      <td><span id="RequestorHelp" class="tip">?</span></td>
      <td><input id="ExportRequestor" type="text" name="requestor" value="" onChange="ExportNop();" ></td>
      <td><span id="RequestorMessage">Provide an identifier for you, e.g. your SolarMail name. May be omitted for online delivery.</span></td>
    </tr>
  
    <tr id="NotifyRow">
      <td>Notify</td>
      <td><span id="NotifyHelp" class="tip">?</span></td>
      <td><input id="ExportNotify" type="text" name="notify" value="" onChange="ExportNop();" ></td>
      <td>Provide your email address for notification.  May be omitted for online delivery.</td>
    </tr>
  
    <tr><td colspan="4"><input id="ExportCheckButton" type="button" value="Check Params for Export" onClick="CheckExportParams();"></td></tr>
    <tr id="AjaxExportRequestRow">
      <td colspan="4">
        <input id="ExportButton" type="button" value="Submit Export Request" style="background-color:#D8D8D8" onClick="GetExport();" >
      <span id="ExportButtonMsg">Please only click once for export request.</span >
      </td>
    </tr>
  
    <tr id="FileUploadRow" style="display:none;">
      <td >Select File</td>
      <td><span id="SendFileHelp" class="tip">?</span></td>
      <td colspan="2">
      <input type='file' id='newFile' name='file' >
      <input type='button' value='Submit Export Request' class='button' onClick="MakeFileUploadRequest();">
      </td>
    </tr>

    <tr id="FileUploadInfoRow" style="display:none;">
      <td>Uploaded File:</td>
      <td>&nbsp;</td>
      <td><span id="FileUploadInfo"></span></td>
      <td></td>
    </tr>
  </table>
</form>

<div id="iframeHideDiv" style="display:none;">
  <iframe id="FileUploadFrame" onload="uploadDone();" name="FileUploadFrame" src="" style="height:0px;width:0px;border:0px solid #fff;"></iframe>
</div>


<div id="SubmitResponseDiv">
<table>
  <tr>
    <td>RequestID</td>
    <td colspan="2"><span id="RequestIdPlace" style="width:12em;background-color:#FFF8DC;">&nbsp;</span></td>
    <td>This is the ID tag for your export request.  Use the Status Request button below to retrieve the links to the data.</td>
  </tr>

  <tr>
    <td>Status</td>
    <td colspan="3"> <span id="ExportStatus" style="background-color:#FFF8DC;"> </span ></td>
  </tr>

  <tr>
    <td>Data Location</td>
    <td colspan="3"><span id="ExportLocation" style="background-color:#FFF8DC;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span ></td>
  </tr>

</table>
</div>
<hr>
<div ExportDataDiv  style="background-color:#C0E0FF;">
<b>JSOC Data Export Status and Retrieval</b>
<p>
<table>
  <tr>
    <td style="width:10em" >RequestID</td>
    <td><input type="text" id="StatusRequestID" name="StatusRequestID" style="width:12em;background-color:#FFF8DC;" value="" onChange="GetStatus();"></td>
    <td>This is the ID tag for your export request.</td>
    <td><span id="StatusValue">&nbsp;</td>
  </tr>

  <tr>
    <td colspan="2" align="center" >
      <input id="StatusButton" type="button" value="Submit Status Request" style="background-color:#D8D8D8" onClick="GetStatus();" ></td>
    <td><span id="StatusButtonMsg">Please only click once for status request.</span ></td>
    <td rowspan="3"><span id="StatusOther">&nbsp;</td>
  </tr>

  <tr>
    <td colspan="2" align="center" >
      <input id="ClearButton" type="button" value="Clear Request" style="background-color:#D8D8D8" onClick="ClearStatus();" ></td>
    <td>Clear old status RequestID</td>
  </tr>

  <tr>
    <td>Status</td>
    <td colspan="2"> <span id="StatusStatus" :tyle="background-color:#FFF8DC;"> </span ></td>
  </tr>

  <tr>
    <td>Data Location</td>
    <td colspan="3"><span id="StatusLocation" style="background-color:#FFF8DC;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span ></td>
  </tr>

  <tr id="TarFileLocationRow" style="display:none;">
    <td>Tar File Location</td>
    <td colspan="3"><span id="TarFileLocation"  style="background-color:#FFF8DC;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span ></td>
  </tr>

  <tr id="KeywordFileLocationRow" style="display:none;">
    <td>Keyword File Location</td>
    <td colspan="3"><span id="KeywordFileLocation"  style="background-color:#FFF8DC;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span ></td>
  </tr>

  <tr>
  <td colspan="4"><span id="StatusDataLocation" style="background-color:#FFF8DC;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span ></td>
  </tr>

</table>
</div> <!-- id="ExportRequestDiv" -->

<div id="ReExportDiv" style="display:none">
<HR>
Use this section to request a renewal/repeat of a prior export for which the data online-retention time has expired.
<table>

  <tr>
    <td style="width:10em" >RequestID</td>
    <td><input type="text" id="ReRequestID" name="ReRequestID" style="background-color:#FFF8DC;" value="" onChange="ExportNop();"></td>
    <td>Enter RequestID for repeat or prior export</td>
    <td><span id="ReStatusValue">&nbsp;</td>
  </tr>

  <tr id="ReNotifyRow">
    <td>Notify</td>
    <td><input id="ReExportNotify" type="text" name="Renotify" value="" onChange="ExportNop();" ></td>
    <td colspan="2">Provide your email address for notification.  May be omitted for online delivery.</td>
  </tr>
  
  <tr id="AjaxReExportRequestRow">
    <td colspan="4">
      re-<input id="ReExportButton" type="button" value="Submit Export Request" style="background-color:#D8D8D8" onClick="GetReExport();" >
    <span id="ReExportButtonMsg">Please only click once for re-export request.</span >
    </td>
  </tr>
  
</table>
</div> <!-- id="ReExportDiv" -->

<HR>
<P style="height:1px">
<div id="footer" style="vertical-align:bottom;text-align:center;">
<I>Home page for:</I>
<A HREF = "http://jsoc.stanford.edu/"><b>SDO-JSOC</b></A>
</div>
</body>
</html>
