<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; CHARSET=iso-8859-1">
<title>JSOC Lookdata</title>

<script type="text/javascript" src="js/prototype.js"></script>
<script type="text/javascript" src="js/cookies.js"></script>
<script type="text/javascript" src="js/prototip.js"></script>
<script type="text/javascript" src="js/amCharts_2.2/amcharts_2.2.1/amcharts/javascript/amcharts.js"></script>
<script type="text/javascript" src="js/amCharts_2.2/amcharts_2.2.1/amcharts/javascript/raphael.js"></script>

<!-- activewidgets fix box model in firefox/safari/opera -->
<style type="text/css">
        .aw-quirks * {
                box-sizing: border-box;
                -moz-box-sizing: border-box;
                -webkit-box-sizing: border-box;
        }

</style>

<script type="text/javascript" src="js/ActiveWidgets/runtime/lib/aw.js"></script>
<link href="js/ActiveWidgets/runtime/styles/system/aw.css" rel="stylesheet">
<!-- add activewidgets image libraries -->
<link href="js/ActiveWidgets/mini.css" rel="stylesheet"></link>

<!-- activewidgets change default styles, set control size and position -->
<style type="text/css">

#LookdataTabs {width: 100%}
#LookdataTabs-item-0 {font-size: medium}
#LookdataTabs-item-1 {font-size: medium}
#LookdataTabs-item-2 {font-size: medium}
#LookdataTabs-item-3 {font-size: medium}
#LookdataTabs-item-4 {font-size: medium}
#LookdataTabs-item-5 {font-size: medium}

#ValueGrid { width: 400px}
#ValueGrid .aw-grid-row {height:24px; border-bottom:1px solid #bbb}
#ValueGrid .aw-alternate-even {background: #fcf4fc;}
#ValueGrid .aw-alternate-odd {background: #f8fcf8;}
#ValueGrid .aw-mouseover-row {background: #f0f0f0;} 
#ValueGrid .aw-rows-selected {background: #d3d3d3;}
#ValueGrid .aw-cells-selected {background: #e3e3e3;}
#ValueGrid .aw-cells-selected {color: #000000;}
#ValueGrid .aw-column-0 {width: 50px; border-right: 1px dotted #bbb;}
#ValueGrid .aw-grid-cell {font-family: "DejaVu Sans Mono",monospace; font-size: 12;}
#ValueGrid .aw-grid-header {font-family: "DejaVu Sans Mono",monospace; font-size: 12;}
#ValueGrid .aw-grid-header .aw-column-1 {font-weight: bold}
#ValueGrid .aw-grid-header {border-right: 1px solid threedlightshadow;}
#ValueGrid .aw-grid-cell {border-right: 1px solid threedlightshadow;}
#ValueGrid .aw-grid-row {border-bottom: 1px solid threedlightshadow;}
/* #ValueGrid .aw-grid-row, .active-grid-row.active-list-item, .active-scroll-left.active-list-item {height:auto;} */

</style>

<link rel="stylesheet" type="text/css" href="css/prototip.css" ></link>

<style type="text/css">

#body { margin:0; padding:0; background:#ddf;}
#header { position:relative; top:0; left:0; width:100%; background:#eee; }
#footer { position:fixed; bottom:0; left:0; width:100%; background:#eee; }

#SeriesDiv { position:relative; margin:5px; }
#SeriesInfoDiv { position:relative; margin:5px; }
#MySeriesDiv { position:relative; margin:5px; }
#QueryDiv { position:relative; margin:5px; }
#FullInfoDiv { position:relative; margin:5px; }
#FullDisplayInfoDiv { position:relative; margin:5px; }

#SeriesSelect { width:40em; }
#KeysSelect { width:20em; }
#GraphKeysSelect { width:20em; }
#SegsSelect { width:20em; }
#LinksSelect { width:20em; }
#SeriesFilter { width:20em; }
#RecordSet { width:35em; font-size:100%; }
#SeriesButton { width:15em; }

#InfoTable { border-spacing:1px; white-space:nowrap; }
td {padding:2px; }

span.tip { background-color:yellow }

</style>
 
<script type="text/javascript">

// 
// Documents for the server side tools can be found at
// "http://jsoc.stanford.edu/jsocwiki/AjaxJsocConnect"
//

// Global variables and initialize page locations

// Set CGI-BIN targets

// var SHOW_SERIES = "show_series_test";
// var JSOC_INFO = "jsoc_info_test";
// var SHOW_INFO = "show_info_test";
// var EXPORTDATA = "exportdata2";
// var USER_KILL = "jsoc_userkill_test";

var SHOW_SERIES = "show_series";
var JSOC_INFO = "jsoc_info";
var SHOW_INFO = "show_info";
var EXPORTDATA = "exportdata";
var USER_KILL = "jsoc_userkill";

// Protect page from accidental BACK button
window.onbeforeunload = function ()
   {
   if (NannyEnabled)
     return "Did you really mean to leave lookdata? Use CANCEL to stay here";
   }

// var SeriesList = "";
var SeriesInfo;
var RecnumQueryLimit = 250000;
var Host = location.host;
var CurrentSeries = 0;
var SeriesName = "";
var SeriesKeySegInfo = "";
var nprimes = 0;
var KeyList = "";
var SegList = "";
var keySortOrder;
var nkeysselected = 0;
var nsegsselected = 0;
var RecordCount = 0;
var askedCount = 0;
var KeyValsFetched = 0;
var TipsEnabled=1;
var TabsEnabled=1;
var NannyEnabled=1;
var TipsCreated = 0;
var MaxRecs = 0;
var FirstLoad = 1;

var GetSeriesObject;
var GetRSCountObject;
var GetValuesObject;
var FirstTimePrime;
var RecordSetGiven="";
var valuegrid;
var valuegridlabel;
var gridmade = 0;
var CWide;
var CHeight;
var amChartOK = 0;
var swfo;
var graphcols;
var datecol = -1;
var RequestHandle = "";
var SessionHandle = "";
var LPINK = "#FFD8D8";
var PINK = "#FFC8C8";
var YELLOW = "#FFFF80";
var GREY = "#D8D8D8";
var GREEN = "#A9F5A9";

// ActiveWidgets Tab setup
var tabnames = ["Series Select", "Series Content", "RecordSet Select", "Values Display", "Export Data", "Graph"];
var tabvalues = ["TabSeriesSelectDiv",  "TabSeriesStructDiv", "TabRecSetDiv", "TabDisplayDiv", "TabExportDiv", "TabPlotDiv"];
var tabs = new AW.UI.Tabs;
var tabseries = 0;
var tabkeytable = 1;
var tabrecset = 2;
var tabdisplay = 3;
var tabexport = 4;
var tabplot = 5;

function definetabs()
        {
        tabs.setId("LookdataTabs");
        tabs.setItemText(tabnames);
        tabs.setItemValue(tabvalues); // store ids of content div
        tabs.setItemCount(6);
        tabs.refresh();

        tabs.setSelectedItems([tabseries]); // load the first page.
        }

tabs.onSelectedItemsChanged = function(selected)
  {
  if (!TabsEnabled) return;
  var i, divs = $("JsocLookdata").childNodes;
  for(i=0; i < divs.length; i++)
    {
    if (divs[i].style)
      {
      divs[i].style.display = "none"; // hide all elements
      }
    }

  var index = selected[0];
  var value = this.getItemValue(index);
  // document.getElementById(value).style.display = "block"; // show selected
  $(value).style.display = "block"; // show selected
  }

function ToggleTabs()
  {
  if (TabsEnabled)
    {
    var i, divs = $("JsocLookdata").childNodes;
    for(i=0; i < divs.length; i++)
      {
      if (divs[i].style)
        {
        divs[i].style.display = "block"; // hide all elements
        }
      }
    $("TabsOnOffButton").value = "Enable Tabs";
    $("LookdataTabs").innerHTML = "";
    TabsEnabled = 0;
    }
  else
    {
    $("TabsOnOffButton").value = "Disable Tabs";
    TabsEnabled = 1;
    definetabs();
    }
  }

// the Nanny function controls the onbeforeunload event action
function ToggleNanny()
  {
  if (NannyEnabled)
    {
    $("NannyOnOffButton").value = "Enable Nanny";
    NannyEnabled = 0;
    }
  else
    {
    $("NannyOnOffButton").value = "Disable Nanny";
    NannyEnabled = 1;
    }
  }

function InitPage()
  {
  CleanSeriesSelect();
  // $("RequestID").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  // $("StatusLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  // $("StatusDataLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("QueryDivCheck").checked = 0;
  $("QueryDiv").style.display="none";
  // $("WhereClausesHelpDiv").style.display="none";
  // AbortGetKeyValues(); ---- do not do this here!!
  // GetSeriesAbort(); ---- do not do this here!!
  CleanSeriesSelect();
  // ClearStatus();
  }

function CleanSeriesSelect()
  {
  for (var i=$("SeriesSelect").length; i > 0; i--)
    {
    $("SeriesSelect").remove(i-1);
    }
  CleanSeriesInfo();
  }

function CleanSeriesInfo()
  {
  MaxRecs = 0;
  $("RecordLimit").value = "none";
  SeriesName = "";
  $("RecordSet").value = "";
  RecordSetGiven = "";
  $("RecordSetComment").innerHTML = "";
  $("SeriesButton").disabled = false;
  $("FetchKeyValsButton").disabled = true;
  $("FetchKeyValsButton").value = "Fetch Keyword Values for RecordSet";
  $("FetchKeyValsButton").style.backgroundColor = GREY;
  $("Series_Info_Place").innerHTML = "";
  $("Series_Name_Place").innerHTML = "";
  $("FirstLastPlace").innerHTML = "";
  $("SeriesCountPlace").innerHTML = "<i>TBD</i>";
  CleanSeriesPick();
  }

function CleanSeriesPick()
  {
  $("KeyListPlace").innerHTML = "All Keywords";
  $("SegListPlace").innerHTML = "All Segments";
  $("LinkListPlace").innerHTML = "All Links";
  $("DisplayPlace").innerHTML = "";
  KeyList = "";
  SegList = "";
  $("SSKeysPlace").innerHTML = "";
  $("SSPlace").innerHTML = "";
  $("RSCount_Place").innerHTML = "";
  RecordCount = 0;
  FirstTimePrime = -1;
  nkeysselected = 0;
  nsegsselected = 0;
  nlinksselected = 0;
  askedCount = 0;
  $("WantRecInfo").checked = 1;
  $("WantFullSegInfo").checked = 0;
  $("AllowBigQueries").checked = 0;
  $("RecSetPlace").innerHTML = "";
  $("MakeLocalFileLinks").checked = 0;
  $("UseShowInfo").checked = 0;
  $("wantTruncate").checked = 1;
  $("SIFi").value = "0";
  $("SIFn").value = "0";
  $("SIFa").value = "0";
  $("SIFA").value = "0";
  $("SIFP").value = "0";
  $("SIFkey").value = '';
  $("SIFseg").value = '';
  $("SIFK").value = "0";
  CleanDropDownLists();
  CleanOnLoad();
  }

function CleanOnLoad()
  {
  var args_given = 0;
  var lookdata_args;
  var args;
  Host = location.host;
  if (FirstLoad == 1)
    {
    if (Host == 'jsoc.stanford.edu')
      {
      $("JSOC2DIV").style.display="block";
      $("SeriesSelectMessage").innerHTML = 'Enter a dataseries match pattern to search for seriesnames, ' +
	      ' or leave blank to select from all series.';
      $("SeriesFilter").value = "";
      }
    else
      {
      $("SeriesFilter").value = "NOT ^dsds\\.";
      $("JSOC2DIV").style.display="none";
      }

    // preload seriesname and recordset if given
    lookdata_args = location.search;
    lookdata_args = decodeURIComponent(lookdata_args);
    lookdata_args = lookdata_args.substr(1);
    args = lookdata_args.toQueryParams();
    if (args.ds != undefined)
       args_given = 1;

    // Get SessionHandle to allow user aborts
    new Ajax.Request('http://' + Host + '/cgi-bin/ajax/jsoc_WebRequestID',
      {
      method: 'get',
      onSuccess: function(transport, json)
        {
        var response = transport.responseText || "no response text";
        var result = response.evalJSON();
        SessionHandle = result.handle;
// $("HandleDiv").innerHTML = SessionHandle;
        }
      });
    FirstLoad = 0;
    }

  // UserKill(RequestHandle);
  RequestHandle = "";

  definetabs();
  Element.hide('systemWorking');
  $("AbortGetSeriesButton").hide();
  $("AbortRSCountButton").hide();
  $("AbortKeyValsButton").hide();
  $("FetchKeyValsButton").style.backgroundColor = YELLOW;
  $("SeriesButton").style.backgroundColor = YELLOW;
  // $("SeriesDiv").style.display="block";
  // $("FullInfoDiv").style.display="block";
  // $("FullInfoDivButton").style.backgroundColor = LPINK;
  CreateTips();
  $("TipsOnOffButton").value = "Disable Help";
  $("TabsOnOffButton").value = "Disable Tabs";
  $("NannyOnOffButton").value = "Disable Nanny";
  newwide();

  // take action if args in URL
  if (args_given > 0)
    {
    $("SeriesFilter").value = args.ds;
    if (args.rs == undefined)
      {
      SeriesName = $("SeriesFilter").value;
      PickSeries(1);
      }
    else
      {
      $("RecordSet").value = args.ds + args.rs;
      if (args.n != undefined)
        $("RecordLimit").value = args.n;
      GetRSCount();
      }
    }
  }

function UserKill(userhandle)
  {
  if (userhandle == "")
    return;
  new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + USER_KILL,
    {
    method: 'get',
    parameters: {"userhandle" : userhandle },
    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no response text";
      var result = response.evalJSON();
// if (result.status > 0) $("HandleDiv").innerHTML = $("HandleDiv").innerHTML + " kill failed, status="+result.status;
// else $("HandleDiv").innerHTML = $("HandleDiv").innerHTML + " kill Ok";
      }
    , onFailure: function() { alert('Something went wrong with user kill handle...'); }
    });
  }

function CreateTips()
  {
  var tipstyle =
    {
    style:'darkgrey',
    hook:{target:'topRight',tip:'bottomLeft'},
    stem:'bottomLeft',
    closeButton:false,
    hideAfter:5,
    hideOn:'click',
    showOn:'click',
    border:3,
    radius:3,
    };
  if (TipsCreated == 0)
    {
    // The following sample line goes in html code
    //    <span id="SampleHelp" class="tip">?</span>
    // the following line goes here
    //    new Tip("SampleHelp","Help text here.",tipstyle);
    // XXXX HELP XXXX
    new Tip("AboutHelp","The yellow '?'s are links to help messages.  The messages will disapear a " +
        "few seconds after the mouse leaves the message or if the '?' is clicked again.  " +
        "Remove all '?' with the Disable Help button.",tipstyle);

    new Tip("PickSeriesHelp","This section is used to identify the JSOC data series you want to explore.  " +
        "If you already know the series you may go to step 3 and enter the seriesname there.",tipstyle);

    new Tip("SeriesFilterHelp", "filter is regular expression to select series names. " +
        "If the filter begins with the word NOT it will exclude the patterns following the 'NOT '.  " +
        "While the filter may be a complex regular expression, a simple text string is usually sufficient " +
        "to limit the number of seriesnames found to a short list.  Case is ignored. Example: 'mdi\\.' " +
        "will find SOHO/MDI specific dataseries.",tipstyle);

    new Tip("SeriesContentHelp","This section contains the DRMS data series basic structure information " +
        "for this dataseries.  It shows the full set of Keywords, Segments, and Links.  " +
        "See the JSOC Wiki page 'Overview of JSOC Data Series, DRMS, and SUMS' to learn about the JSOC " +
        "use of these terms.",tipstyle);

    new Tip("SeriesPickHelp", "After pressing the <b>Fetch seriesname list</b> on the left, the " +
        "selection list here will contain all available data series matching your filter.  " +
        "Simply click on the series that contains the data you are looking for.  The text after the " +
        "seriesname is the series Note provided when the series was first created and should help you " +
        "decide which series you need.  After clicking on the desired seriesname, lookdata will fetch " +
        "more information about the series and jump to the <b>RecordSet Select</b> tab where you can select " +
        "which subset of records to examine and select which keyword or file contents to examine.",tipstyle);

    new Tip("QueryBuilderHelp","This checkbox enables input boxes for recordset query clauses.  " +
        "You may enter the desired recordset query in the text box below or with the QueryBuilder " +
        "enabled just enter the seriesname in the main box and record selection clauses in the subsequent boxes.  " +
        "There will be one box for each Prime-Key and one SQL where-clause box that keeps the Prime-Key version " +
        "logic enabled '[?...?]', and one SQL where-clause box that will disable the Prime-Key version logic " +
        "if the box is not empty '[!...!]'.  The punctuation is filled-in for you, i.e. the '[,?,!,]' as needed.",tipstyle);

    new Tip("RecordSetHelp","This text box is used to specify the Recordset you wish to examine or export.  " +
        "You may start with just the seriesname to get a count of all the records in the series, then add " +
        "filter clauses to limit the selected records to just the ones you want to examine or export.",tipstyle);
    }
  TipsCreated = 1;
  $$("span.tip").each(function(showspan){showspan.show();}); 
  }

function HideTips()
  {
  $$("span.tip").each(function(hidespan){hidespan.hide();}); 
  Tips.hideAll();
  }

function ToggleHelp()
  {
  if (TipsEnabled)
    {
    HideTips();
    $("TipsOnOffButton").value = "Enable Help";
    TipsEnabled = 0;
    }
  else
    {
    CreateTips();
    $("TipsOnOffButton").value = "Disable Help";
    TipsEnabled = 1;
    }
  }

 function QueryDivCheckToggle()
  {
  if ($("QueryDivCheck").checked == 0)
    {
    $("QueryDiv").style.display="none";
    }
  else
    {
    $("QueryDiv").style.display="block";
    }
  }

function insertOption(list,text,note)
  {
  var y=document.createElement('option');
  y.value=text;
  if (note.length)
    y.text = text + "  --- " + note;
  else
    y.text = text;
  var x = $(list);
  try
    {
    x.add(y,null); // standards compliant
    }
  catch(ex)
    {
    x.add(y); // IE only
    }
  }

var myGlobalHandlers = {
	onCreate: function()
	  {
          $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
          Element.show('systemWorking');
          },
	onComplete: function()
          {
          if(Ajax.activeRequestCount == 0)
            {
            $("AjaxBusy").innerHTML = "0";
	    Element.hide('systemWorking');
            }
          }
};

Ajax.Responders.register(myGlobalHandlers);

// Section 1.0 support, Get list of series and build select list for 2.0

function GetSeriesAbort()
  {
  if (GetSeriesObject == undefined)
    {
    return;
    }
  else if (GetSeriesObject.transport.readyState != 4)
    {
    GetSeriesObject.transport.abort();
    $("SeriesButton").style.backgroundColor = YELLOW;
    $("SeriesButton").value = "Fetch seriesname list";
    $("SeriesButton").disabled = false;
    $("AbortGetSeriesButton").hide();
    }
  }

function OnEnterKey(evt,action)
  {
  var keynum;
  var keychar;
  if(window.event) // IE
    keynum = evt.keyCode;
  else if(evt.which) // Netscape/Firefox/Opera
    keynum = evt.which;
  if(keynum == 13)
    action(); 
  keychar = String.fromCharCode(keynum);
  return keychar;
  }

function GetSeries()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  CleanSeriesInfo();
  $("SeriesButton").value = "Processing...";
  $("SeriesButton").style.backgroundColor = PINK;
  $("SeriesButton").disabled = true;
  $("AbortGetSeriesButton").show();
  $("SeriesCountPlace").innerHTML = "<i>wait...</i>";
  GetSeriesObject = new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + SHOW_SERIES,
    {
    method: 'get',
    parameters: {"filter" : $("SeriesFilter").value },
    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no response text";
      var SeriesList = response.evalJSON();
      CleanSeriesSelect();
      var n = SeriesList.n;
      for (var i = 0; i < n; i++)
        {
	insertOption("SeriesSelect",SeriesList.names[i].name,SeriesList.names[i].note);
        }
      $("SeriesCountPlace").innerHTML = SeriesList.n ;
      $("SeriesButton").style.backgroundColor = YELLOW;
      $("SeriesButton").value = "Fetch seriesname list";
      $("SeriesButton").disabled = false;
      $("AbortGetSeriesButton").hide();
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      },
    onFailure: function() { alert('Something went wrong with GetSeries from '+Host+' ...'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  }

// Section 2.0 support Select seriesfrom select list made in section 1.0
// Uses jsoc_info op=series_struct
// Get list of all keywords and segments with supporting info
// Fetches full list of keywords and segments for display in section 4 and
// build select lists used in section 4 and 5.
// If mode==0 then use the SeriesSelect box for the chosen series.
// else if mode==1 then use the SeriesName variable as is and fetch
// info and reset all associated references.
// If mode==2 then the section 3 series name becomes the new SeriesName
// and info for it will be found and displayed.
// If mode==3 then the section 3 series name becomes the new SeriesName
// and info for it will be found and displayed and RSCount will be started.
// If mode==4, only update the first and last record information

function PickSeries(mode)
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  if (mode < 4) CleanSeriesPick();
  if (mode == 0)
    {
    CurrentSeries = $("SeriesSelect").selectedIndex;
    SeriesName = $("SeriesSelect").options[CurrentSeries].value;
    }
  if (mode == 0 || mode == 1)
    {
    $("RecordSet").value = SeriesName;
    RecordSetGiven = $("RecordSet").value;
    $("QueryPlace").innerHTML = "";
    }
  $("Series_Name_Place").innerHTML = SeriesName;
  $("RecSetPlace").innerHTML = SeriesName;
  // Get link to release notes
  ProjectName = SeriesName.match(/[a-zA-Z_]*/);
  $("ReleaseNotes").innerHTML = "<a href='http://jsoc.stanford.edu/doc/data/" + ProjectName +
                                "/' target='_blank'>" + ProjectName + "</a>";
  $("FirstLastPlace").innerHTML = "... Fetching Series Information ...";
  new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_INFO,
    {
    method: 'get',
    // parameters: {"ds" : SeriesName, "op" : "series_struct" },
    parameters: {"ds" : SeriesName, "op" : "series_struct", "o" : "1" },

    onSuccess: function(transport, json)
      {
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      var response = transport.responseText || "no response text";
      SeriesInfo = response.evalJSON();
      if (SeriesInfo.status == 1)
        {
        $("FirstLastPlace").innerHTML = "No Matching Series Found";
        $("SSPlace").innerHTML = "No Series Struct Found";
        $("SSKeysPlace").innerHTML = "";
        CleanDropDownLists();
        CleanOnLoad();
        }
      else
        {
        var i;
        // Get series descriptive note and display
        if (mode < 4)
          {
          $("Series_Info_Place").innerHTML = SeriesInfo.note;
  
          // Get list of prime keys and index keys and display info
          // Get prime key special info from primekeys array, but
          // get prime keyword type and units, defaults, from matching keywords array element
          var QueryBoxes = "<table>";
  	  nprimes = SeriesInfo.primekeysinfo.length;
  	  var primes = "No PrimeKeys";
          FirstTimePrime = -1;
          if (nprimes == 1 && SeriesInfo.primekeysinfo[0] == null)
            nprimes = 0;
  	  if (nprimes > 0)
            {
  	    for (i=0; i<nprimes; i++)
              {
              if (i==0)
  	        primes = SeriesInfo.primekeysinfo[0].name;
              else
  	        primes = primes + ", " + SeriesInfo.primekeysinfo[i].name;
              var k;
              for (k=0; k<SeriesInfo.keywords.length; k++)
                 if (SeriesInfo.keywords[k].name === SeriesInfo.primekeysinfo[i].name)
                    break;
              var isslotted = SeriesInfo.primekeysinfo[i].slotted;
              QueryBoxes = QueryBoxes + 
                  "<tr><td>" + SeriesInfo.primekeysinfo[i].name + "</td>" + 
                  "<td align='right'>" + "[&nbsp;&nbsp;<input id='Prime" + i +
                  "' type='text' value='' onChange='QueryBuild();' >&nbsp;&nbsp;]</td>" +
                  "<td> (" + SeriesInfo.keywords[k].type + (isslotted ? "-slotted, " + 
                  SeriesInfo.primekeysinfo[i].step : "") + ")</td>";
              if (SeriesInfo.keywords[k].type === "time")
                  {
                  QueryBoxes = QueryBoxes + "<td> expects " + SeriesInfo.keywords[k].units + "</td>";
                  if (FirstTimePrime < 0)
                    FirstTimePrime = (isslotted ? i : -1);  // SeriesInfo.keywords[k] contains info of first slotted time prime key.
                  }
              else
                  QueryBoxes = QueryBoxes + "<td></td>";
  
              QueryBoxes = QueryBoxes +  "</tr>";
              }
            }
          QueryBoxes = QueryBoxes +  "<tr><td>where clause</td>" + 
            "<td align='right'>" + "[?&nbsp;<input id='WhereClause0' type='text' value='' onChange='QueryBuild();' >&nbsp;?]</td>" +
            "<td colspan=2>Use to get only most recent version of selected records.</td></tr>";
          QueryBoxes = QueryBoxes +  "<tr><td>where clause</td>" + 
            "<td align='right'>" + "[!&nbsp;<input id='WhereClause1' type='text' value='' onChange='QueryBuild();' >&nbsp;!]</td>" +
            "<td colspan=2> Use for all versions of selected records.</td></tr>";
          QueryBoxes = QueryBoxes + "</table>";
          $("QueryPlace").innerHTML = QueryBoxes;
          if ($("QueryDivCheck").checked == 1)
            {
	    $("QueryDiv").style.display="block";
            }
          else
            {
	    $("QueryDiv").style.display="none";
            }
	  var n = SeriesInfo.dbindex.length;
	  var dbindex = "No DBindex";
	  if (n > 0) dbindex = SeriesInfo.dbindex[0];
	    for (i=1; i<n; i++)
	      dbindex = dbindex + ", " + SeriesInfo.dbindex[i];
          $("SSKeysPlace").innerHTML = "PrimeKeys: " + primes + "<br>" +
                                       "DBindex: " + dbindex + "<br>";
          // Add segment information if present
          if (SeriesInfo.segments.length > 0)
	    {
            if (SeriesInfo.archive > 0)
              {
              $("SSKeysPlace").innerHTML = $("SSKeysPlace").innerHTML +
	        "Data is archived, online retention " + SeriesInfo.retention + " days<br>";
              }
	    else
              {
              $("SSKeysPlace").innerHTML = $("SSKeysPlace").innerHTML +
	        "Data NOT archived, online retention " + SeriesInfo.retention + " days<br>";
              }
            $("SSKeysPlace").innerHTML = $("SSKeysPlace").innerHTML + "Unitsize: " + SeriesInfo.unitsize + " record" +
              (SeriesInfo.unitsize > 1 ? "s" : "") + "<br>";
	    }
	  else
            {
            $("SSKeysPlace").innerHTML = $("SSKeysPlace").innerHTML + "No SUMS storage for this series<br>";
            }
          $("SSKeysPlace").innerHTML = $("SSKeysPlace").innerHTML + "Owner: " + SeriesInfo.owner + "<br>"; 

          // build and display keyword selection scroll box and keyword part of full table
	  makeSeriesContent(0);   // use SeriesInfo order for initial keyword list.
          // cleanup pending count place
          $("RSCount_Place").innerHTML = "";
          }

	// Place first and last record info on screen
	if (SeriesInfo.Interval.MaxRecnum > 0)
          $("FirstLastPlace").innerHTML = "First Record = " + SeriesInfo.Interval.FirstRecord + 
              "<br>Last Record = " + SeriesInfo.Interval.LastRecord +
	      "<br>First Rec., Last Rec. and largest used recnums: " + SeriesInfo.Interval.FirstRecnum + ", " +
              SeriesInfo.Interval.LastRecnum + ", " +  SeriesInfo.Interval.MaxRecnum + " resp." ;
	else
	  $("FirstLastPlace").innerHTML = "This series contains no records";

        // Done displaying detailed information for this series
        }
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      if (mode==3) 
        GetRSCount();
      else
        {
        $("GetRSCountButton").disabled = false;
        $("GetRSCountButton").style.backgroundColor = GREEN;
        }
      },
    onFailure: function() { alert('Something went wrong with series structure request'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  // Now jump to the RecordSet tab
  tabs.setSelectedItems([tabrecset]); // load the first page.
  }

function SortSeriesContent()
  {
  if ($("SeriesContentSort").value == "Sort")
    {
    makeSeriesContent(1);
    $("SeriesContentSort").value = "Restore Original Order";
    }
  else 
    {
    makeSeriesContent(0);
    $("SeriesContentSort").value = "Sort";
    }
  }

// build and display keyword Series Content table
function makeSeriesContent(doSort)
  {
  var n, i, keywords, segments, links;
  keywords = "No keywords";
  n = SeriesInfo.keywords.length;
  if (n > 0)
    {
    var some_links = 0;
    for (i=0; i<n; i++)
      {
      if (SeriesInfo.keywords[i].linkinfo)
        some_links += 1;
      }
    if (some_links)
      keywords = "<table border=1><tr><th>Use</th><th>keyword</th><th>linked</th><th>type</th><th>scope</th><th>default</th><th>unit</th><th>note</th>"; 
    else
      keywords = "<table border=1><tr><th>Use</th><th>keyword</th><th>type</th><th>scope</th><th>default</th><th>unit</th><th>note</th>"; 
    // make order table for sorting
    keySortOrder = new Array();
    for (i=0; i<n; i++)
      keySortOrder[i] = {Num:i, Name:SeriesInfo.keywords[i].name};
    if (doSort)
      {
      tmpsort = keySortOrder.sortBy(function(key) {return key.Name;});
      keySortOrder = tmpsort;
      }

    for (i=0; i<n; i++)
      {
      var I = keySortOrder[i].Num;
      keywords = keywords + "<tr>" + 
        '<td><input type="checkbox" id="k'+I+'" checked="checked" onChange="updateDropDownLists('+"'k',"+I+');"></td>' +
        "<td>" + SeriesInfo.keywords[I].name + "</td><td>"; 
      if (some_links)
        {
        if (SeriesInfo.keywords[I].linkinfo)
          keywords += SeriesInfo.keywords[I].linkinfo + "</td><td>";
        else
          keywords += "&nbsp;</td><td>";
        }
      keywords += SeriesInfo.keywords[I].type + "</td><td>" +
      SeriesInfo.keywords[I].recscope + "</td><td>" +
      SeriesInfo.keywords[I].defval + "&nbsp;</td><td>" +
      SeriesInfo.keywords[I].units + "&nbsp;</td><td>" +
      SeriesInfo.keywords[I].note + "&nbsp;</td></tr>";
      }
    }
  
  // build and display segment selection scroll box and segment part of full table
  segments = "No segments";
  n = SeriesInfo.segments.length;
  if (n > 0)
    {
    segments = "<table border=1><tr><td>use for per-<br>segment keywords</td><td>segment num.</td><td>name</td><td>type</td><td>units</td><td>dims</td><td>protocol</td><td>note</td>";
    for (i=0; i<n; i++)
      {
      segments = segments + "<tr>" + 
        '<td><input type="checkbox" id="s'+i+'" checked="checked" onChange="updateDropDownLists('+"'s',"+i+');"></td>' +
        "<td>" + i + "</td><td>" + SeriesInfo.segments[i].name + "</td><td>" + 
      SeriesInfo.segments[i].type + "&nbsp;</td><td>" +
      SeriesInfo.segments[i].units + "&nbsp;</td><td>" +
      SeriesInfo.segments[i].dims + "&nbsp;</td><td>" + SeriesInfo.segments[i].protocol +
      "</td><td>" + SeriesInfo.segments[i].note + "&nbsp;</td></tr>";
      }
    segments = segments + "</table><p>";
    }
  
  // build and display link selection scroll box and segment part of full table
  links = "No links";
  n = SeriesInfo.links.length;
  if (n > 0)
    {
    links = "<table border=1><tr><td>link</td><td>name</td><td>target </td><td>kind</td><td>note</td>";
    for (i=0; i<n; i++)
      {
      links = links + "<tr>" + 
        "<td>" + SeriesInfo.links[i].name + "</td><td>" + SeriesInfo.links[i].target + "</td><td>" +
        SeriesInfo.links[i].kind + "</td><td>" + SeriesInfo.links[i].note + "&nbsp;</td></tr>";
      }
    links = links + "</table><p>";
    }
  
  // Place structure table on screen
  $("SSPlace").innerHTML =  keywords + "<br>" + segments + "<br>" + links;
  $("AllKeysSelect").checked = true;
  makeDropDownLists();
  }

// Choose which keywords, segments, links will be included in DropDownLists.
// AllKeysSelectChange is called by change of checkbox at top of Series Content table.

function AllKeysSelectChange()
  {
  var nk = SeriesInfo.keywords.length;
  var ns = SeriesInfo.segments.length;
  var nl = SeriesInfo.links.length;
  var i;

  if ($("AllKeysSelect").checked)
    {
    for (i=0; i<nk; i++)
      $("k"+i).checked = true;
    for (i=0; i<ns; i++)
      $("s"+i).checked = true;
    // for (i=0; i<nl; i++)
      // $("l"+i).checked = true;
    }
  else
    {
    for (i=0; i<nk; i++)
      $("k"+i).checked = false;
    for (i=0; i<ns; i++)
      $("s"+i).checked = false;
    // for (i=0; i<nl; i++)
      // $("l"+i).checked = false;
    }
  makeDropDownLists();
  }

// updateDropDownLists is called by change of a checkbox in the Series Content table.
function updateDropDownLists(list,n)
  {
  // for now just rebuild the entire list each change
  makeDropDownLists();
  }

function makeDropDownLists()
  {
  CleanDropDownLists();
  var n = SeriesInfo.keywords.length;
  var i;
  if (n > 0)
    {
    insertOption("KeysSelect","**NONE**", "");
    insertOption("KeysSelect","**ALL**", "");
    for (i=0; i<n; i++)
      {
      var I = keySortOrder[i].Num;
      if ($("k"+I).checked == false)
        continue;
      if (SeriesInfo.keywords[I].recscope === "segment")
        {
        var j;
        for (j=0; j< SeriesInfo.segments.length; j++)
          {
          if ($("s"+j).checked == false)
            continue;
          var snow = "" + j;
          while (snow.length < 3) { snow = "0" + snow;}
            insertOption("KeysSelect",SeriesInfo.keywords[I].name+"_"+snow, "");
          }
        }
      else
        insertOption("KeysSelect",SeriesInfo.keywords[I].name, "");
      }
    }
  insertOption("KeysSelect","*recdir*", "");
  insertOption("KeysSelect","*dirmtime*", "");
  insertOption("KeysSelect","*logdir*", "");
  insertOption("KeysSelect","*recnum*", "");
  insertOption("KeysSelect","*sunum*", "");
  insertOption("KeysSelect","*size*", "");
  insertOption("KeysSelect","*online*", "");
  insertOption("KeysSelect","*retain*", "");
  insertOption("KeysSelect","*archive*", "");

  n = SeriesInfo.segments.length;
  if (n > 0)
    {
    insertOption("SegsSelect","**NONE**", "");
    insertOption("SegsSelect","**ALL**", "");
    for (i=0; i<n; i++)
      {
      if ($("s"+i).checked == false)
        continue;
      insertOption("SegsSelect",SeriesInfo.segments[i].name, "");
      }
    }

  n = SeriesInfo.links.length;
  if (n > 0)
    {
    links = "<table border=1><tr><td>link</td><td>target </td><td>kind</td><td>note</td>";
    insertOption("LinksSelect","**NONE**", "");
    insertOption("LinksSelect","**ALL**", "");
    for (i=0; i<n; i++)
      insertOption("LinksSelect",SeriesInfo.links[i].name, "");
    }
  }

function CleanDropDownLists()
  {
  KeyValsFetched = 0;
  for (var i=$("KeysSelect").length; i > 0; i--)
    $("KeysSelect").remove(i-1);
  for (var i=$("SegsSelect").length; i > 0; i--)
    $("SegsSelect").remove(i-1);
  for (var i=$("LinksSelect").length; i > 0; i--)
    $("LinksSelect").remove(i-1);
  for (var i=$("GraphKeysSelect").length; i > 0; i--)
    $("GraphKeysSelect").remove(i-1);
  $("DisplayPlace").innerHTML = "";
  $("SegListPlace").innerHTML = "";
  $("LinkListPlace").innerHTML = "";
  $("KeyListPlace").innerHTML = "";
  KeyList =  "";
  SegList =  "";
  LinkList =  "";
  gridmade = 0;
  }

// Section 3.0 support - Get record count
// Uses jsoc_info op=rs_summary which may take a while but
// also validates recordset query that will be used in section 6.

function SetRSLimit()
  {
  $("RecordSet").value = RecordSetGiven;
  GetRSCount();
  }

function AbortRSCount()
  {
  $("AbortRSCountButton").hide();
  $("GetRSCountButton").disabled = false;
  $("GetRSCountButton").style.backgroundColor = GREEN;
  $("RSCount_Place").innerHTML = "Count aborted";
  tabs.setSelectedItems([tabrecset]); // stay on record set select page
  if (GetRSCountObject == undefined)
    {
    return;
    }
  else if (GetRSCountObject.transport.readyState != 4)
    {
    UserKill(RequestHandle);
    GetRSCountObject.transport.abort();
    $("RSCount_Place").innerHTML = "Count aborted with "+RequestHandle;
    }
  }

function time_convert(direction, val)
  {
  // NOTE this does not deal with TAI correctly so the returned time will be c. 30 seconds wrong
  // DO NOT USE WHEN TIME MUST BE ACCURATE
  if (direction === 's')
    { // seconds to ascii time, seconds since 1977.01.01_TAI
    var yyyy, mo, dd, hh, mm, ss;
    var epoch = Date.parse("1976/12/31 23:59:45");
    var d = new Date();
    d.setTime(val*1000 + epoch);
    yyyy = d.getFullYear() + '';
    mo = d.getMonth() + 1;  mo = mo + ''; if (mo.length == 1) mo = '0' + mo;
    dd = d.getDate();       dd = dd + ''; if (dd.length == 1) dd = '0' + dd;
    hh = d.getHours();      hh = hh + ''; if (hh.length == 1) hh = '0' + hh;
    mm = d.getMinutes();    mm = mm + ''; if (mm.length == 1) mm = '0' + mm;
    ss = d.getUTCSeconds(); ss = ss + ''; if (ss.length == 1) ss = '0' + ss;
    return(yyyy+'.'+mo+'.'+dd+'_'+hh+':'+mm+':'+ss+'_UTC');
    }
  else
    { // ascii time to seconds, JSOC or ISO
    // example 2008.06.23_00:58:42.95_TAI or 2008
    var t0, t1, tms, epoch;
    t0 = new String(val);
    t1 = t0.replace(/\./g,"/");
    t0 = t1.replace(/-/g,"/");
    t1 = t0.replace(/_/," ");
    t0 = t1.replace(/T/," ");
    t1 = t0.substring(0,19);
    tms = Date.parse(t1);
    epoch = Date.parse("1976/12/31 23:59:45");
    return((tms - epoch)/1000);
    }
  }

function GetRSCount()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  RecordSetGiven = $("RecordSet").value;
  $("RecordSetComment").innerHTML = "";
  var posbracket = $("RecordSet").value.indexOf("[");
  var posRbracket = $("RecordSet").value.indexOf("]");
  var thisSeriesName;
  if (posbracket == -1)
    {
    thisSeriesName = $("RecordSet").value;
    }
  else
    {
    if (posRbracket == -1)
      {
      $("RSCount_Place").innerHTML = "ERROR - missing right bracket - ]";
      return;
      }
    thisSeriesName = $("RecordSet").value.substr(0,posbracket);
    }
  if (thisSeriesName != SeriesName)
    {
    SeriesName = thisSeriesName;
    PickSeries(3);
    $("RSCount_Place").innerHTML = "Getting series information - wait";
    return;
    }
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  if ($("RecordLimit").value === "none")
    MaxRecs = 0;
  else if (Number($("RecordLimit").value)) 
    MaxRecs = Number($("RecordLimit").value);
  else
    {
    $("RecordLimit").value = "none";
    MaxRecs = 0;
    }
  if (SeriesInfo.Interval.MaxRecnum > RecnumQueryLimit && MaxRecs == 0)
    {
    posbracket = $("RecordSet").value.indexOf("[");
    posRbracket = $("RecordSet").value.lastIndexOf("]");
    if ((posRbracket == posbracket+1 || (posbracket == -1 && posRbracket == -1)) && MaxRecs == 0)
      {
      alert("This series, "+thisSeriesName+", has many records, you must specify an explicit " +
            "clause or clauses in [...] to limit the number of records. Defaulting to [$]");
      $("RecordSet").value = thisSeriesName + '[$]';
     // return; 
      }
    }
  // check for count only and add time range to support the counting 
  // do not bother if used recnums < 500,000.
  $("RecordSetComment").innerHTML = "";
  if (SeriesInfo.Interval.MaxRecnum > 500000 && MaxRecs != 0 && 
    (posRbracket == posbracket+1 || (posbracket == -1 && posRbracket == -1))) 
    {
    if (FirstTimePrime == 0 && Math.abs(MaxRecs) < 10000)
      {
      var t_step = 1.0 * SeriesInfo.primekeysinfo[FirstTimePrime].step;
      var t_span = 100 * Math.abs(MaxRecs) * t_step;
      var t_base = (MaxRecs > 0 ? SeriesInfo.Interval.FirstRecord : SeriesInfo.Interval.LastRecord) + "";
      var rBracket =  t_base.indexOf("]");
      var lBracket =  t_base.indexOf("[");
      var t_base_prefix = t_base.substring(0,lBracket+1);
      var t_base_time = t_base.substring(lBracket+1,rBracket);
      var t_base_suffix = t_base.substr(rBracket);
      t_base_suffix = ']';
      if (MaxRecs < 0)
        {
        var t_time_t, t_time;
        t_time_t = time_convert("t",t_base_time);
        t_time_t = t_time_t - t_span;
        t_time = time_convert("s",t_time_t);
        }
      else
        {
        t_time = t_base_time;
        }
      $("RecordSet").value = t_base_prefix + t_time + '/' + t_span + 's' + t_base_suffix;
      $("RecordSetComment").innerHTML = "<B>For large series with no limiting clause, the RecordSet spec has been<br>modified for quick count from either end.</B><br>";
      }
    }
// $("GetRSCountButton").value = "Kill Count?";
  $("GetRSCountButton").style.backgroundColor = GREY;
  $("GetRSCountButton").disabled = true;
  $("AbortRSCountButton").show();
  $("RSCount_Place").innerHTML = "Getting count - wait...";
  RecordCount = -1;
  askedCount = 1;
  var StartTime = new Date()
  RequestHandle = SessionHandle + "_" + StartTime.getTime();
// $("HandleDiv").innerHTML = RequestHandle;
  GetRSCountObject = new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_INFO,
    {
    method: 'get',
    parameters: {"ds" : $("RecordSet").value, "op" : "rs_summary", "n" : MaxRecs, "userhandle" : RequestHandle },

    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no response text";
      var SummaryData = response.evalJSON();
      if (SummaryData.status != 0)
        {
	RecordCount = 0;
        $("RSCount_Place").innerHTML = "No RecordSet Count Found";
        }
      else
	{ 
	RecordCount = SummaryData.count;
	$("RSCount_Place").innerHTML = SummaryData.count;
	}
      $("ExportRecordSetLimit").innerHTML = $("RecordLimit").value;
      $("ExportRecordSet").innerHTML = $("RecordSet").value;
      if (nsegsselected > 0)
        $("ExportRecordSet").innerHTML = $("ExportRecordSet").innerHTML + "{" + SegList + "}";
      $("RecSetPlace").innerHTML = $("RecordSet").value;
      if (KeyValsFetched == 1)
        {
        $("FetchKeyValsButton").value = "Update Keyword Values for RecordSet";
        $("FetchKeyValsButton").style.backgroundColor = GREEN;
        }
      $("GetRSCountButton").disabled = false;
      $("GetRSCountButton").style.backgroundColor = YELLOW;
      $("AbortRSCountButton").hide();
      $("FetchKeyValsButton").style.backgroundColor = GREEN;
      $("FetchKeyValsButton").disabled = false;
      },
    onFailure: function() { alert('Something went wrong with series summary request'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  }

// QueryBuild is called when where clause specs are added to build a recordset spec
function QueryBuild()
  { 
  var QueryString = SeriesName;
  for (var i=0; i<nprimes; i++)
    {
    QueryString = QueryString + "[" + $("Prime"+i).value + "]";
    }
  if ($("WhereClause0").value.length > 0)
    QueryString = QueryString + "[? " + $("WhereClause0").value + " ?]";
  if ($("WhereClause1").value.length > 0)
    QueryString = QueryString + "[! " + $("WhereClause1").value + " !]";
  $("RecordSet").value = QueryString;
  }

// Section 4, Select keys for fetching values
// Uses select list of keyword names made in section 4.
// Places result in list to be used in section 6.

function PickKeys()
  {
  var ikey = 0;
  nkeysselected = 0;
  var nkeys = $("KeysSelect").length;
  var selkeys = "";
  $("KeyListPlace").innerHTML = "";
  $("DisplayPlace").innerHTML = "";
  for (var i=$("GraphKeysSelect").length; i > 0; i--)
    $("GraphKeysSelect").remove(i-1);
  for (var i=$("GraphXKeysSelect").length; i > 0; i--)
    $("GraphXKeysSelect").remove(i-1);
  // $("WantRecInfo").checked = 0;
  KeyList = "";
  selkeys = "";
  // check for **NONE**
  if ($("KeysSelect")[0].selected)
    {
    nkeysselected = 0;
    selkeys = "**NONE**";
    KeyList = "**NONE**";
    for (ikey=1; ikey < nkeys; ikey++)
      $("KeysSelect")[ikey].selected = false;
    }
  // check for **ALL**
  if ($("KeysSelect")[1].selected)
    {
    nkeysselected = 1;
    selkeys = "**ALL**";
    KeyList = "**ALL**";
    $("KeysSelect")[0].selected = false;
    }
  else for (ikey=2; ikey < nkeys; ikey++)
    {
    if ($("KeysSelect")[ikey].selected)
      {
      if (nkeysselected)
        {
        selkeys = selkeys + ", ";
        KeyList = KeyList + ",";
        }
      nkeysselected = nkeysselected + 1;
      selkeys = selkeys + $("KeysSelect")[ikey].text;
      KeyList = KeyList + $("KeysSelect")[ikey].text;
      }
    }
  $("KeyListPlace").innerHTML = nkeysselected + " Keys Chosen:&nbsp;" + selkeys;
  }

// Section 5., Select segments for fetching pathnames
// Uses select list of segment names made in section 4.
// Places result in list to be used in section 6.

function PickSegs()
  {
  var iseg = 0;
  nsegsselected = 0;
  var nsegs = $("SegsSelect").length;
  var selsegs =  "";
  $("SegListPlace").innerHTML = "";
  $("DisplayPlace").innerHTML = "";
  // $("WantRecInfo").checked = 0;
  SegList = "";
  selsegs = "";
  // check for **NONE**
  if ($("SegsSelect")[0].selected)
    {
    nsegsselected = 0;
    selsegs = "**NONE**";
    SegList = "**NONE**";
    }
  // check for **ALL**
  else if ($("SegsSelect")[1].selected)
    {
    nsegsselected = nsegs - 2;
    selsegs = "**ALL**";
    SegList = "**ALL**";
    }
  else
   for (iseg=0; iseg < nsegs; iseg++)
    if ($("SegsSelect")[iseg].selected)
      {
      if (nsegsselected)
	{
	selsegs = selsegs + ", ";
        SegList = SegList + ",";
	}
      nsegsselected = nsegsselected + 1;
      selsegs = selsegs +  $("SegsSelect")[iseg].text;
      SegList = SegList +  $("SegsSelect")[iseg].text;
      }
  $("SegListPlace").innerHTML = nsegsselected + " Segs Chosen:&nbsp;" + selsegs;
  }

// Section 5++., Select links for fetching pathnames
// Uses select list of link names made in section 5.5.
// Places result in list to be used in section 6.

function PickLinks()
  {
  var ilink = 0;
  nlinksselected = 0;
  var nlinks = $("LinksSelect").length;
  var sellinks =  "";
  $("LinkListPlace").innerHTML = "";
  $("DisplayPlace").innerHTML = ""; 
  // $("WantRecInfo").checked = 0;
  LinkList =  "";
  sellinks = "";
  // check for **NONE**
  if ($("LinksSelect")[0].selected)
    {
    nlinksselected = 0;
    sellinks = "**NONE**";
    LinkList = "**NONE**";
    }
  // check for **ALL**
  else if ($("LinksSelect")[1].selected)
    {
    nlinksselected = nlinks - 2;
    sellinks = "**ALL**";
    LinkList = "**ALL**";
    }
  else
   for (ilink=0; ilink < nlinks; ilink++)
    if ($("LinksSelect")[ilink].selected)
      {
      if (nlinksselected)
	{
	sellinks = sellinks + ", ";
        LinkList = LinkList + ",";
	}
      nlinksselected = nlinksselected + 1;
      sellinks = sellinks +  $("LinksSelect")[ilink].text;
      LinkList = LinkList +  $("LinksSelect")[ilink].text;
      }
  $("LinkListPlace").innerHTML = nlinksselected + " Links Chosen:&nbsp;" + sellinks;
  }

// Section 6.0 - Get record values for selected keywords and segments
// Uses jsoc_info op=rs_list
// Places result in table.

function AbortGetKeyValues()
  {
  if (GetValuesObject == undefined)
    {
    return;
    }
  else if (GetValuesObject.transport.readyState != 4)
    {
    UserKill(RequestHandle);
    GetValuesObject.transport.abort();
    $("FetchKeyValsButton").value = "Fetch Keyword Values for RecordSet";
    $("FetchKeyValsButton").style.backgroundColor = YELLOW;
    $("FetchKeyValsButton").disabled = false;
    $("AbortKeyValsButton").hide();
    $("AbortRSCountButton").hide();
    $("DisplayPlace").innerHTML = "Request aborted";
    tabs.setSelectedItems([tabrecset]); // stay on record set select page
    }
  }

var griddata;
var gridcolwidth;

function setgriddata(i,val)
  {
  var thisval = (val != null && val.length > 0 ? val : "&nbsp");
  griddata[i] = thisval;
  gridcolwidth[i] = Math.max(gridcolwidth[i], thisval.length);
  return i+1;
  }

var RecordData;

function GetKeyValues()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  if ($("UseShowInfo").checked)
    {
    GetShowInfo();
    return;
    }
  var getparameters = new Hash( {"ds" : $("RecordSet").value, "op" : "rs_list" });
  $("DisplayPlace").innerHTML = "Requesting Recordset Key Values ...";
  if (nkeysselected < 1 && nsegsselected < 1 && nlinksselected < 1 && $("WantRecInfo").checked == 0)
    {
    $("DisplayPlace").innerHTML = "No keywords and NO segments requested.<br>Please fo back to steps 4 and 5."; 
    tabs.setSelectedItems([tabdisplay]); // show the display page.
    return;
    }
  if (MaxRecs != 0)
    getparameters.update({"n": MaxRecs});
  if (nkeysselected)
    getparameters.update({"key": KeyList});
  else
    getparameters.update({"key":"**NONE**"});
  if (nsegsselected)
    getparameters.update({"seg": SegList});
  else
    getparameters.update({"seg":"**NONE**"});
  if (nlinksselected)
    getparameters.update({"link": LinkList});
  else
    getparameters.update({"link":"**NONE**"});
  if ($("WantRecInfo").checked)
    getparameters.update({"R":1});
  if (RecordCount == 0 && askedCount == 0)
      GetRSCount();
  if (RecordCount < 0)
    {
// XXXXXX change this to a while, change message, do sleep 2 sec.
      $("DisplayPlace").innerHTML = "RecordSet count underway (step 3), please wait for it to complete before retrying";
    tabs.setSelectedItems([tabdisplay]); // show the display page.
      return;
    }
  if (RecordCount == 0)
    {
    $("DisplayPlace").innerHTML = "There are no records in the chosen RecordSet";
    tabs.setSelectedItems([tabdisplay]); // show the display page.
    return;
    }
  if (RecordCount > 10000 && !$("AllowBigQueries").checked)
    {
    $("DisplayPlace").innerHTML = "Requested Recordset is too large for this function, " + RecordCount + 
	" records.<br>Please go back to step 3 and choose a smaller recordset.";
    tabs.setSelectedItems([tabdisplay]); // show the display page.
    return;
    }
  $("FetchKeyValsButton").value = "Processing ...";
  $("FetchKeyValsButton").style.backgroundColor = GREY;
  $("FetchKeyValsButton").disabled = true;
  $("AbortKeyValsButton").show();
  var StartTime = new Date()
  RequestHandle = SessionHandle + "_" + StartTime.getTime();
// $("HandleDiv").innerHTML = RequestHandle;
  getparameters.update({"userhandle": RequestHandle});
  $("requestTime").innerHTML = "";
  GetValuesObject = new Ajax.Request('http://' + Host + '/cgi-bin/ajax/' + JSOC_INFO,
    {
    method: 'get',
    parameters: getparameters.toObject(),

    onSuccess: function(transport, json)
      {
      RequestHandle = "";
      var DoneTime = new Date()
      $("DisplayPlace").innerHTML = "Data received, processing ...";
      tabs.setSelectedItems([tabdisplay]); // show the display page.
      var response = transport.responseText || "no response text";
      RecordData = response.evalJSON();
      // var RecordData = JSON.parse(response);
      if (RecordData.status == 1)
        {
        $("DisplayPlace").innerHTML = RecordData.error;
	AbortGetKeyValues();
        }
      else
        {
         //  valuegrid = new AW.UI.Grid; 
        valuegrid = new AW.Grid.Extended; 
        valuegrid.setId("ValueGrid");

        $("FetchKeyValsButton").value = "Fetch Keyword Values for RecordSet";
        $("FetchKeyValsButton").style.backgroundColor = YELLOW;
        $("FetchKeyValsButton").disabled = false;
        $("AbortKeyValsButton").hide();
        KeyValsFetched = 1;
	wantLocalLinks = $("MakeLocalFileLinks").checked;
	var thissegdata = "";
	var nkeys = RecordData.keywords.length;
	var nsegs = RecordData.segments.length;
	var nlinks = RecordData.links.length;
	var nrecs = RecordData.count;
        var gridcols = nkeys + 2*nsegs + nlinks;
        var segcols = new Array(nsegs);
        wantrecinfo = $("WantRecInfo").checked;
	if (wantrecinfo) gridcols += 1;
	if ($("WantFullSegInfo").checked == 1) gridcols += 3*nsegs;
        var gridrows = nrecs;
        var irow, icol;

        $("DisplayPlace").innerHTML = "Status = " + RecordData.status + ", Recordset Key Values for " +
                                      nrecs + " records returned, preparing page ...";

        var gridcells = new Array(gridrows);

        // Build header row
        var gridhead = new Array(gridcols);
        var ihead = 0
	if (wantrecinfo)
           gridhead[ihead++] = "RecordName";
	for (var ikey=0; ikey < nkeys; ++ikey)
           gridhead[ihead++] = RecordData.keywords[ikey].name;
	for (var iseg=0; iseg < nsegs; ++iseg)
           {
           segcols[iseg] = ihead;
           gridhead[ihead++] = RecordData.segments[iseg].name;
           gridhead[ihead++] = "seg_dims: " + RecordData.segments[iseg].name;
	   if ($("WantFullSegInfo").checked == 1)
	       {
               gridhead[ihead++] = "seg_cparms: " + RecordData.segments[iseg].name;
               gridhead[ihead++] = "seg_bzero: " + RecordData.segments[iseg].name;
               gridhead[ihead++] = "seg_bscale: " + RecordData.segments[iseg].name;
               }
            }
	  for (var ilink=0; ilink < nlinks; ++ilink)
            gridhead[ihead++] = "Link: " + RecordData.links[ilink].name;
        gridcolwidth = new Array(gridcols);

        for (icol=0; icol<gridcols; icol++)
	  gridcolwidth[icol] = gridhead[icol].length;

          // build data rows
	  for (var irec=0; irec < nrecs; irec++)
	     {
             griddata = new Array(gridcols);
             var idata = 0;
	     if (wantrecinfo)
		idata = setgriddata(idata, RecordData.recinfo[irec].name);
	     for (ikey=0; ikey<nkeys; ikey++)
	       {
	       var this_keystr =  RecordData.keywords[ikey].values[irec] + "";
               var this_keyval = this_keystr.replace(/\n/g,"<b>NL</b>>");
               if ($("wantTruncate").checked && this_keyval.length > 60) this_keyval = this_keyval.slice(0,47) + "...TRUNCATED";
	       idata = setgriddata(idata, this_keyval);
	       }
	     for (iseg=0; iseg<nsegs; iseg++)
	        {
	        thissegdata = RecordData.segments[iseg].values[irec];
		griddata[idata] = thissegdata;
		gridcolwidth[idata] = Math.max(gridcolwidth[idata], RecordData.segments[iseg].values[irec].length);
                idata++;
	        idata = setgriddata(idata, RecordData.segments[iseg].dims[irec]);
	        if ($("WantFullSegInfo").checked == 1)
	           {
	           idata = setgriddata(idata, RecordData.segments[iseg].cparms[irec]);
	           idata = setgriddata(idata, RecordData.segments[iseg].bzeros[irec]);
	           idata = setgriddata(idata, RecordData.segments[iseg].bscales[irec]);
	           }
	        }
	     for (ilink=0; ilink<nlinks; ilink++)
	        idata = setgriddata(idata, RecordData.links[ilink].values[irec]);
	     gridcells[irec] = griddata;
	     valuegrid.addRow(irec);
	     }

	// valuegridlabel = new AW.UI.Label;
	// valuegridlabel.setId("myLabel");
	// valuegridlabel.refresh();

        valuegrid.setSelectionMode("single-cell"); // set selection mode to single row
        valuegrid.setColumnCount(gridcols);
        valuegrid.setFixedLeft(1);	// number of fixed columns on the left side
        valuegrid.setRowCount(gridrows);
        valuegrid.setHeaderText(gridhead);
        valuegrid.setCellData(gridcells);
        valuegrid.setVirtualMode(true);
	// valuegrid.setSelectorVisible(true);
	// valuegrid.setSelectorWidth(28);
	// valuegrid.setSelectorText(function(i){return this.getRowPosition(i)+1});
        
        // fix data links
        icol = 0;
	if (wantrecinfo)
           icol=1;
	for (ikey=0; ikey<nkeys; ikey++)
	   {
	   if (RecordData.keywords[ikey].name == "*logdir*")
	    for (var irec=0; irec < nrecs; irec++)
	      {
	      var this_keyval =  RecordData.keywords[ikey].values[irec];
              valuegrid.setCellText(this_keyval, icol+ikey, irec);
              valuegrid.setCellLink("http://jsoc.stanford.edu" + this_keyval, icol+ikey, irec);
              valuegrid.setCellTemplate(new AW.Templates.Link, icol+ikey, irec);
	      valuegrid.getCellTemplate(icol, irec).setAttribute("target","_blank");
              }
	   }
	for (iseg=0; iseg<nsegs; iseg++)
	  {
          icol = segcols[iseg];
	  for (var irec=0; irec < nrecs; irec++)
            {
	    thissegdata = RecordData.segments[iseg].values[irec];
            if (RecordData.recinfo[irec].online)
	       {
               valuegrid.setCellText(thissegdata, icol, irec);
	       if (wantLocalLinks)
                 valuegrid.setCellLink("file://" + thissegdata, icol, irec);
               else
                 valuegrid.setCellLink("http://jsoc.stanford.edu" + thissegdata, icol, irec);
               valuegrid.setCellTemplate(new AW.Templates.Link, icol, irec);
	       valuegrid.getCellTemplate(icol, irec).setAttribute("target","_blank");
	       }
            }
	  }
        for (icol=0; icol<gridcols; icol++)
           {
	   valuegrid.setColumnWidth(Math.round(8.0*gridcolwidth[icol]), icol);
           }
	valuegrid.refresh();

        $("DisplayPlace").innerHTML = valuegrid;
	gridmade = 1;
        newwide();
        tabs.setSelectedItems([tabdisplay]); // show the display page.

        // initialize graph select table
        GraphDelete();
        insertOption("GraphXKeysSelect","index", "");
        for (ikey=0; ikey < nkeys; ikey++)
          {
          insertOption("GraphKeysSelect",RecordData.keywords[ikey].name, "");
          var jkey; for (jkey=0; jkey < SeriesInfo.keywords.length; jkey++)
            if (RecordData.keywords[ikey].name == SeriesInfo.keywords[jkey].name)
               { // now have access to SeriesInfo for this keyword
               if (SeriesInfo.keywords[jkey].type == "time")
                 insertOption("GraphXKeysSelect",RecordData.keywords[ikey].name, "");
               break;
               }
          }
        $("requestTime").innerHTML = ", Query time = " + RecordData.runtime + "s";
        }
      },
    onFailure: function() { alert('Something went wrong with series data request'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  }

function GetShowInfo()
  {
  // The UseShowInfo box is checked, so do a show_info request with the results in a new page
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  $("DisplayPlace").innerHTML = "Requesting Recordset Key Values ...";
  tabs.setSelectedItems([tabdisplay]); // show the display page.
  if (nkeysselected < 1 && nsegsselected < 1 && nlinksselected < 1 && $("WantRecInfo").checked == 0)
    {
    $("DisplayPlace").innerHTML = "No keywords and NO segments requested.<br>Please go back to steps 4 and 5."; 
    return;
    }

  $("SIFi").value = "0";
  $("SIFn").value = "0";
  $("SIFa").value = "0";
  $("SIFA").value = "0";
  $("SIFP").value = "0";
  $("SIFkey").value = '';
  $("SIFseg").value = '';
  $("SIFK").value = "0";
  $("SIFds").value = $("RecordSet").value;
  // $("SIFds").value = encodeURIComponent($("RecordSet").value);

  if ($("WantRecInfo").checked) $("SIFi").value = "1";
  if (MaxRecs != 0) $("SIFn").value = MaxRecs;
  if ($("RecordSet").value.indexOf("[") == -1 && MaxRecs == 0)
    {
    alert("Please set Record Limit or provide RecordSet query");
    return;
    }
  if ($("KeysSelect")[1].selected)
      $("SIFa").value = 1;
  else if (nkeysselected) 
      $("SIFkey").value = KeyList;
  if (nsegsselected)
    {
    if ($("SegsSelect")[1].selected)
      $("SIFA").value = 1;
    else
      $("SIFseg").value = SegList;
    $("SIFP").value = 1;
    }
  if (nlinksselected) $("SIFK").value = "1";

  if (RecordCount == 0 && askedCount == 0)
      GetRSCount();
  // if (RecordCount < 0)
    // {
      // $("DisplayPlace").innerHTML = "RecordSet count underway (step 3), please wait for it to complete before retrying";
      // return;
    // }
  if (RecordCount == 0)
    {
    $("DisplayPlace").innerHTML = "There are no records in the chosen RecordSet";
    tabs.setSelectedItems([tabdisplay]); // show the display page.
    return;
    }
  if (RecordCount > 10000 && !$("AllowBigQueries").checked)
    {
    $("DisplayPlace").innerHTML = "Requested Recordset is too large for this function, " + RecordCount + 
	" records.<br>Please go back to step 3 and choose a smaller recordset.";
    tabs.setSelectedItems([tabdisplay]); // show the display page.
    return;
    }
  $("FetchKeyValsButton").value = "Processing ...";
  $("FetchKeyValsButton").style.backgroundColor = GREY;
  $("FetchKeyValsButton").disabled = true;
  $("AbortKeyValsButton").show();
// XXXXXXXXXXXXXXXXXX ACK - this of course does not work, FORM wants args in its own structures.
// if cant use prototype to specifty target, then need to make a hidden div to hold
// the args.
// YES, will do it that way.
// urlencode the param list and concatenate to next line into showargs
   $("ShowInfoForm").action = 'http://' + Host + '/cgi-bin/ajax/' + SHOW_INFO;
   $("ShowInfoForm").submit();

  $("FetchKeyValsButton").value = "Fetch Keyword Values for RecordSet";
  $("FetchKeyValsButton").style.backgroundColor = YELLOW;
  $("FetchKeyValsButton").disabled = false;
  $("AbortKeyValsButton").hide();
  $("DisplayPlace").innerHTML = "Key values will be returned in a new window.";
  tabs.setSelectedItems([tabdisplay]); // show the display page.
  }

function newwide(thisevent)
  {
  if (gridmade)
        {
        CWidth = self.innerWidth;
        CHeight = self.innerHeight;
        valuegrid.setSize(CWidth - 35 ,CHeight - 310);
        $("DisplayPlace").innerHTML = valuegrid;
        }
  else
        {
        // CHeight = self.innerHeight;
        // $("SeriesInfoDiv").style.height = (1*CHeight - 200);
        }
  return true;
  }

// Graph making code
//
// code to get the list of keywords to be graphed
// this should be called only after the data is fetched for ValueTable
//
  // <form id="GraphSelectForm">
  // <select id="GraphKeysSelect" size=8 multiple="multiple" onChange="GraphPickKeys();" > </select>

function GraphPickKeys()
  {
  var igraphkey = 0;
  var ngraphkeys = $("GraphKeysSelect").length;
  var ikey = 0;
  var nkeys = RecordData.keywords.length;
  var graphKeysSelected = 0;
  var yDesc = "<table id='graphYTable' border=1><tr><td>Keyword</td><td>Type</td></tr>";
  graphcols = new Array();
  
  for (igraphkey=0; igraphkey < ngraphkeys; igraphkey++)
    if ($("GraphKeysSelect")[igraphkey].selected)
      {
      for (ikey=0; ikey < nkeys; ikey++)
        {
        if ($("GraphKeysSelect")[igraphkey].text == RecordData.keywords[ikey].name)
          {
          var ntype = "unk";
          var jkey; for (jkey=0; jkey < SeriesInfo.keywords.length; jkey++)
            if (RecordData.keywords[ikey].name == SeriesInfo.keywords[jkey].name)
               { // now have access to SeriesInfo for this keyword
               ntype = SeriesInfo.keywords[jkey].type;
               break;
               }
          yDesc = yDesc + "<td>" + RecordData.keywords[ikey].name + "</td><td>"+ntype+"</td></tr>";
          graphAddCol(RecordData.keywords[ikey].name, ikey);
          }
        }
      }
  $("graphYAxis").innerHTML = yDesc + "</table>";
  }

function GraphPickXKey()
  {
  var ngraphkeys = $("GraphXKeysSelect").length;
  var ikey = 0;
  var nkeys = RecordData.keywords.length;
  var igraphkey = $("GraphXKeysSelect").selectedIndex;
  if ($("GraphXKeysSelect")[igraphkey].text == "index")
     datecol = -1;
  else
    for (ikey=0; ikey < nkeys; ikey++)
      {
      if ($("GraphXKeysSelect")[igraphkey].text == RecordData.keywords[ikey].name)
        {
        datecol = ikey;
        }
      }
  $("graphXAxis").innerHTML = (datecol == -1 ? "index" : RecordData.keywords[datecol].name);
  }

function graphAddCol(name, column)
  {
  var ncols = graphcols.length;
  var colinfo = new Object();
  colinfo["col"] = column;
  colinfo["name"] = name;
  graphcols[ncols] = colinfo;
  }

// RecordData.recinfo[irec].name

function GraphDelete()
  {
  graphcols = new Array();
  var ngraphkeys = $("GraphKeysSelect").length;
  var ikey = 0;
  for (ikey=0; ikey < ngraphkeys; ikey++)
    $("GraphKeysSelect")[ikey].selected = 0;
  $("graphYAxis").innerHTML = "No keywords selected";
  GraphCreate();
  }

var timeZone = "";
function strToDate(timestr)
  {
  var t1;
  var t0 = new String(timestr);
  if (t0.indexOf("_") >= 0)
    {
    // JSOC format, example 2008.06.23_00:58:42.95_TAI
    t1 = t0.replace(/\./g,"/");
    t0 = t1.replace(/_/," ");
    timeZone = t0.substr(20,3);
    }
  else
    {
    //  ISO format, example 2008/06/22 21:45:32
    t1 = t0.replace(/-/g,"/");
    t0 = t1.replace(/T/," ");
    timeZone = "ISO";
    }
  t1 = t0.substr(0,19);
  return(new Date(t1));
  }

function saveGraph(node)
  {
//alert(node.localName);
  var dataURL = node.toDataURL();
  $("graphImage").src = dataURL;
  }

function GraphCreate()
  {
  var n=RecordData.count;
  var graphDesc = "<table><tr><td>Graph for:</td><td>" + $("RecordSet").value;
  if ($("RecordLimit").value != "none")
    graphDesc = graphDesc + ", limit=" + $("RecordLimit").value;
  graphDesc = graphDesc + "</td></tr>";
  graphDesc = graphDesc + "<tr><td>From:</td><td>" + RecordData.recinfo[0].name + "</td></tr></tr>";
  graphDesc = graphDesc + "<tr><td>To:</td><td>" + RecordData.recinfo[n-1].name + "</td></tr></tr>";
  graphDesc = graphDesc + "</table>";
  $("graphDescription").innerHTML = graphDesc;

  var gcols = graphcols.length;
  var ncols = RecordData.keywords.length;
  if (gcols > 0)
    {
    var chartData = new Array();
    GraphPickXKey();
    var xname, yname;
    if (datecol == -1)
      xname = "index";
    else
      xname = RecordData.keywords[datecol].name;
    var i; for (i=0; i<n; i++)
      {
      var lineObj = new Object();
      var val, x, y;
      if (datecol == -1)
        x = i;
      else
        { // convert time string to Date object
        var timestr = RecordData.keywords[datecol].values[i];
        if (timestr === "MISSING")
          continue;
        else
          x = strToDate(timestr);
        }
      lineObj[xname] = x;

      var yvals = 0;
      var icol; for (icol=0; icol<gcols; icol++)
        {
        var pcol = graphcols[icol].col;
        val = RecordData.keywords[pcol].values[i];
        if (val === "MISSING")
{
//          y = 0.0;
// continue;
y = NaN;
}
        else
          y = val;
        lineObj[graphcols[icol].name] = y;
        yvals++;
        }
      if (yvals) chartData.push(lineObj);
      }
  
    var ndata = chartData.length;
    var chart = new AmCharts.AmSerialChart();
    chart.pathToImages = "js/amCharts_2.2/amcharts_2.2.1/amcharts/javascript/images/";
    chart.dataProvider = chartData;
    chart.categoryField = xname;
    chart.marginTop = 20;
    chart.marginLeft = 80;
    chart.marginRight = gcols*50;

    var legend = new AmCharts.AmLegend();
    chart.addLegend(legend);
  
    var catAxis = chart.categoryAxis;
    catAxis.axisColor = "#FF0000";
    catAxis.gridColor = "#FF00FF";
    catAxis.gridAlpha = 0.5;
    catAxis.dashLength = 5;
    catAxis.autoGridCount = true;
    catAxis.title = xname;
    if (datecol >= 0)
      {
      catAxis.parseDates = true;
      catAxis.minPeriod = "ss";
      catAxis.equalSpacing = true;
      catAxis.dateFormats [{period:"ss",format:"YYYY.MM.DD_JJ:NN:SS"},
			   {period:"mm",format:"YYYY.MM.DD_JJ:NN:SS"},
			   {period:"hh",format:"YYYY.MM.DD_JJ:NN:SS"},
			   {period:"DD",format:"YYYY.MM.DD_JJ:NN:SS"},
			   {period:"MM",format:"YYYY.MM.DD_JJ:NN:SS"}];
      }
    else
      {
      //catAxis.minPeriod = 5;
      }
    
    graphs = new Array();
    valAxes = new Array();
    for (icol=0; icol<gcols; icol++)
      {
      var valAxis = new AmCharts.ValueAxis();
      valAxis.axisColor = "#FF0000";
      valAxis.gridColor = "#FF00FF";
      valAxis.gridAlpha = "0.5";
      valAxis.dashLength = 5;
      valAxis.useScientificNotation = true;
      valAxis.title = graphcols[icol].name;
      valAxis.titleTextColor = "#000000";
      // chart.addLabel(50,50,graphcols[icol].name);
      if (icol > 0)
        {
        valAxis.position = "right";
        valAxis.offset = (icol-1)*50;
        }
      chart.addValueAxis(valAxis);
      valAxes[icol] = valAxis;
  
      var graph = new AmCharts.AmGraph();
      graph.valueAxis = valAxes[icol];
      graph.valueField = graphcols[icol].name;
      graph.title = graphcols[icol].name;
      graph.type = "line";
      chart.addGraph(graph);
      graphs[icol] = graph;
      }
  
    var chartCursor = new AmCharts.ChartCursor();
    chartCursor.cursorAlpha = 0;
    chartCursor.cursorPosition = "mouse";
    chartCursor.categoryBalloonDateFormat = "YYYY.MM.DD_JJ:NN:SS" + (timeZone=="TAI" ? "_tai" : "");
    chart.addChartCursor(chartCursor);
  
    var chartScrollbar = new AmCharts.ChartScrollbar();
    // chartScrollbar.graph = graphs[0];
    chartScrollbar.backgroundAlpha = 0.1;
    chartScrollbar.backgroundColor = "#000000";
    // chartScrollbar.scrollbarHeight = 40;
    chartScrollbar.scrollbarHeight = 20;
  
    chartScrollbar.selectedBackgroundColor = "#FFCC32";
    chart.addChartScrollbar(chartScrollbar);
  
    $("graphPlace").innerHTML = "";
    $("amChartDiv").innerHTML = "";
    $("amChartDiv").style.display = "block";
    
    chart.write($("amChartDiv"));
    for (icol=0; icol<gcols; icol++)
      {
      $("graphYTable").rows[icol+1].cells[0].style.backgroundColor = chart.graphs[icol].lineColor;
      }
saveGraph($("amChartDiv").childNodes[0].childNodes[0]);
    }
  else
    {
    $("amChartDiv").innerHTML = "Graph removed or no keywords selected.";
    }
  }

function Export_Recordset()
  {
  Cookie.init({name:EXPORTDATA});
  Cookie.setData("state",0);
  if (nsegsselected > 0 && $("ExportRecordSet").innerHTML.indexOf("}") == -1)
    $("ExportRecordSet").innerHTML = $("ExportRecordSet").innerHTML + "{" + SegList + "}";
  $("ExportRecordSetLimit").innerHTML = $("RecordLimit").value;
  var exportargs="ds="+$("ExportRecordSet").innerHTML  + "&limit=" + $("RecordLimit").value
  Cookie.setData("search",encodeURIComponent(exportargs));
  ExportWindow=window.open("http://" + Host + "/ajax/" + EXPORTDATA + ".html?" + encodeURIComponent(exportargs), "JSOC_Export");
  ExportWindow.window.focus();
  }

function StartExportRequest()
  {
  if (nsegsselected > 0 && $("ExportRecordSet").innerHTML.indexOf("}") == -1)
    $("ExportRecordSet").innerHTML = $("ExportRecordSet").innerHTML + "{" + SegList + "}";
    $("ExportRecordSetLimit").innerHTML = $("RecordLimit").value;
  $("ExportRequestFrame").src = "http://" + Host + "/ajax/" + EXPORTDATA + ".html?ds="+$("ExportRecordSet").innerHTML  +
      "&limit=" + $("RecordLimit").value;
  }

function ExportRequestStarted()
  {
  // $("ExportRequestFrame").style ="display:block";
  }

</script>

</HEAD>

<body BGCOLOR="#E0F0FF" onLoad="CleanOnLoad();" onresize="newwide(event);" > 

<div id="header">
  <a href = http://jsoc.stanford.edu><img src="http://hmi.stanford.edu/images/web/JSOC_120.gif"
    style="vertical-align:middle;height:60px;border:0" alt="JSOC logo"></a>
  &nbsp;&nbsp;&nbsp;
  <b><big style="vertical-align:middle">&nbsp;&nbsp;JSOC Data Explore Info and Export</big></b>
  &nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;
  <input type="button" value="Reset Page" onClick="InitPage();" >
  &nbsp;&nbsp;
  <input id="TabsOnOffButton" type="button" value="Disable Tabs" onClick="ToggleTabs();" >
  &nbsp;&nbsp;
  <input id="NannyOnOffButton" type="button" value="Disable Nanny" onClick="ToggleNanny();" >
  &nbsp;&nbsp;
  <input id="TipsOnOffButton" type="button" value="Disable Help" onClick="ToggleHelp();" >
  &nbsp;&nbsp;<span id="AjaxBusy">0</span> Requests Pending
  <span id='systemWorking'>, Loading...</span>
  <span id='requestTime'></span>
  <!-- <hr> -->
  <p>
</div> <!-- end div header -->
<div id="HandleDiv" style="display:none" >
RequestID
</div>
<div id="JSOC2DIV">
<p>
<b>
<span id="AboutHelp" class="tip">? About Help</span> 
&nbsp;
&nbsp;
&nbsp;
jsoc.stanford.edu gives access to export series. Consult JSOC staff for access to internal series. 
</b>
<p>
<hr>
</div> <! -- end div JSOC2DIV -->
<span id="LookdataTabs"></span>
<div id="JsocLookdata" style="border: 1px solid #aaa;">
<div id="TabSeriesSelectDiv" style="display:block">
  <div id="SeriesDiv">
    <table style="width:98%">
    <tr> <td  style="width:50%;vertical-align:top;"></td><td style="width:50%;vertical-align:top;"></td></tr>
    <tr> <td colspan==2>
    <span id="PickSeriesHelp" class="tip">?</span>
    You may go directly to Step 3 on the above <b>RecordSet Select</b> tab if you know which series you want.
    </td></tr>
    <tr> <td><b>1. Find list of dataseries</b></td><td><b>2. Pick series to use</b></td></tr>
    <tr>
    <td>
    <span id="SeriesSelectMessage">
    Enter a dataseries match pattern to search for seriesnames, or leave blank to select from all series.
    (A very bad idea now that we have about 45,000 seriesnames.)
    A leading "NOT " means exclude names matching the subsequent pattern.
    The default filter excludes namespace "dsds."
    </span>
    <p>
    <input id="SeriesFilter" type="text" name="filter" value="NOT ^dsds\." onkeydown="return OnEnterKey(event,GetSeries);" >
    <span id="SeriesFilterHelp" class="tip">?</span> Seriesname filter
    <br>
    <input id="SeriesButton" type="button" value="Fetch seriesname list" style="background-color:#FFFF80" onClick="GetSeries();" > 
    <input id="AbortGetSeriesButton" type="button" value="Abort" style="background-color:#FFD0D0" onClick="GetSeriesAbort();" > 
    <br>
    <span id="SeriesCountPlace" style="background-color:#FFFFFF;width:2em"><i>TBD</i></span>
    Series match this selection filter.
    </td>
    <td>
    <span id="SeriesPickHelp" class="tip">?</span> 
    Select data series here.
    <br>
    <select id="SeriesSelect" size=8 onclick="PickSeries(0)"> </select>
    </td>
    </tr>
    </table>
  </div> <!-- /div SeriesDiv -->
</div> <!-- /div TabSeriesSelectDiv -->
<div id="TabRecSetDiv" style="display:block">
  <div id="MySeriesDiv" >
    <table style="width:98%">
      <tr><td style="width:33%"></td><td style="width:33%;"></td><td style="width:33%;"></td></tr>
      <tr>
        <td rowspan=2 style="vertical-align:top;height:60px">
        <b>Information about selected series</b><br>
        <b>Current Series is:</b>
        <span id="Series_Name_Place" style="background-color:#FFFFFF"></span>
        <br>
        <span id="SSKeysPlace" style="background-color:#FFFFFF;"></span>
        </td>
        <td colspan=2 style="vertical-align:top">
        <b>Series Description</b> &nbsp;
        <input type="button" value="(Refresh)"  onClick="PickSeries(3);" >
        <span id="Series_Info_Place" style="background-color:#FFFFFF"></span>
        <br>
        <b>Release Notes</b> for<b>&nbsp;<a href="http://jsoc.stanford.edu/doc/exports/exportdata_lookdata_release_notes.txt"
             target="_blank">Lookdata</a></b>, and for 
        <b><span id="ReleaseNotes"></span></b>
        <br>
        <b><a target="JSOC Keywords" href="http://jsoc.stanford.edu/doc/keywords/JSOC_Keywords_for_metadata.pdf">Keyword Notes</a> (pdf)
        </td>
      </tr>
      <tr>
        <td colspan=2>
        <span id="FirstLastPlace" style="vertical-align:top;background-color:#FFFFFF"></span>
        </td>
      </tr>
      <tr>
        <td colspan=2  style="vertical-align:top;">
        <b>3. Select Records and Get Record Count</b><br>
        Enter RecordSet Specification here for keyword listings and for export.
        <span id="RecordSetExample">
        &nbsp; &nbsp;
        <a href=RecordSetHelp.html target="JSOC_Help">Examples</a>
        </span>
        <br>
        <span id="QueryBuilderHelp" class="tip">?</span>
        <input type="checkbox" name="" id="QueryDivCheck" onChange="QueryDivCheckToggle();">
        Check box  to show the QueryBuilder.
        <br>
        Request may take a while if the recordset is large (more than a few thousand records).
        <p>
        <span id="RecordSetHelp" class="tip">?</span>
        <input id="RecordSet" type="text" value="" onkeydown="return OnEnterKey(event,GetRSCount);" > 
        <br>
        <span id="RecordSetComment"></span>
        <div id="QueryDiv">
          <span id="QueryPlace" style="width:10em;background-color:#FFFFFF;"></span></span>
        </div>
        <p>
        &nbsp;&nbsp;
        Record Limit &nbsp;
        <input type="text" value="none" name="" id="RecordLimit" onChange="SetRSLimit();" >
        &nbsp;  Optional, + for from start, - for from end.
        <p>
        <input type="button" id="GetRSCountButton" value="GetRecordCount"  style="background-color:#FFFF80" onClick="GetRSCount();" >
        <input type="button" id="AbortRSCountButton" value="Abort" style="background-color:#FFD0D0" onClick="AbortRSCount();" >
        Record Count:&nbsp;&nbsp;
        <span id="RSCount_Place" style="width:10em;background-color:#FFFFFF"></span>
        <p>
        <input type="checkbox" name="Get Record Query" id="WantRecInfo"> Check to Get Record Query.  <br>
        <input type="checkbox" name="AllowBigQueries" id="AllowBigQueries"> Check to Allow Huge Record Queries.  <br>
        <input type="checkbox" name="WantFullSegInfo" id="WantFullSegInfo"> Check to show full segment info.<br>
        <input type="checkbox" name="MakeLocalFileLinks" id="MakeLocalFileLinks"> Check to make local file links (only at JSOC).  <br>
        <input type="checkbox" name="wantTruncate" id="wantTruncate"> Check to truncate long strings in values display.  <br>
        <input type="checkbox" name="UseShowInfo" id="UseShowInfo"> Prepare keyword table in plain text format, e.g. as show_info output, in new window. (No *psuedo* keywords) <br>
        <input type="button" id="FetchKeyValsButton" value="Fetch Keyword Values for RecordSet" style="background-color:#FFFF80" onClick="GetKeyValues();" >
        <input type="button" id="AbortKeyValsButton" value="Abort" style="background-color:#FFD0D0" onClick="AbortGetKeyValues();" >
        </td>
        <td>
        Select Keywords, Segments, and Links for table of values.
        <br>
        <b>4. Select Keywords</b><br>
        Use Series Content to choose which keywords are visible here.
        <form id="KeysSelectForm" >
          <select id="KeysSelect" size=8 multiple="multiple" onChange="PickKeys();" > </select>
        </form>
        <b>5. Select Segments</b><br>
        <form id="SegsSelectForm">
          <select id="SegsSelect" size=8 multiple="multiple" onChange="PickSegs();"> </select>
        </form>
        <b>6. Select Links</b><br>
        <form id="LinksSelectForm">
          <select id="LinksSelect" size=8 multiple="multiple" onChange="PickLinks();" > </select>
        </form>
        </td>
      </tr>
    </table>
  </div> <!-- id="MySeriesDiv" -->
</div> <!-- /div TabRecSetDiv -->
<div id='ShowInfoFormDiv' style="display:none">
<form id='ShowInfoForm' name='ShowInfoForm'
  action=''
  target="_blank"
  method='get'>
  <input type='hidden' id='SIFds' name='ds'  value='' >
  <input type='hidden' id='SIFkey' name='key'  value='' >
  <input type='hidden' id='SIFseg' name='seg'  value='' >
  <input type='hidden' id='SIFt' name='t'  value='1' >
  <input type='hidden' id='SIFi' name='i'  value='0' >
  <input type='hidden' id='SIFK' name='K'  value='0' >
  <input type='hidden' id='SIFn' name='n'  value='0' >
  <input type='hidden' id='SIFa' name='a'  value='0' >
  <input type='hidden' id='SIFA' name='A'  value='0' >
  <input type='hidden' id='SIFP' name='P'  value='0' >
</form>
</div>

<div id="TabSeriesStructDiv" style="display:block">
  <div id="SeriesInfoDiv"  style="background-color:#FFFFFF;border:solid;border-width:thin;overflow:scroll;height:75%">
    <h3><span id="SeriesContentHelp" class="tip">?</span> Series Content: List of All Keywords, Links, and Segments</h3>
    <input type="checkbox" checked="checked" id="AllKeysSelect" onChange="AllKeysSelectChange()">
      Select or de-select all keywords, and segments for inclusion in drop down final select lists. Per-segment
      keywords are only included for checked segments.<br> 
    <input id="SeriesContentSort" type="button" value="Sort" onClick="SortSeriesContent();" > 
    <span id="SSPlace" style="background-color:#FFFFFF;"></span>
  </div>
</div> <!-- /div TabSeriesStructDiv -->
<div id="TabDisplayDiv" style="display:block">
  <div id="FullInfoDiv">
    <b>7. Get Keyword and Segment Values Here</b><br>
    <table>
    <tr><td> RecordSet Query:</td><td> <span id="RecSetPlace" style="background-color:#FFFFFF;"></span></td></tr>
    <tr><td> Keywords to Fetch:</td><td><span id="KeyListPlace" style="background-color:#FFFFFF;"></span></td></tr>
    <tr><td> Segments to Fetch:</td><td><span id="SegListPlace" style="background-color:#FFFFFF;"></span></td></tr>
    <tr><td> Links to Fetch:</td><td> <span id="LinkListPlace" style="background-color:#FFFFFF;"></span></td></tr>
    </table>
	    <p>
	    <div id="FullDisplayInfoDiv" style="background-color:#FFFFFF ;width:98%;">
      <span id="DisplayPlace" style="background-color:#FFFFFF;"></span>
    </div> <!-- /div FullDisplayInfoDiv -->
  </div> <!-- /div FullInfoDiv -->
</div> <!-- /div TabDisplayDiv -->
<div id="TabExportDiv" style="display:block">
  <div> <!-- Section 7, Export link -->
    <b>8. RecordSet to export:</b>
    <span id="ExportRecordSet" style="background-color:#FFFFFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span >
    <b> Record Limit:</b>
    <span id="ExportRecordSetLimit" style="background-color:#FFFFFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span >
    <input id="ExportRequestButton" type="button" value="Export" onClick="Export_Recordset();" > 
    <!-- <input id="ExportRequestButton" type="button" value="Export" onClick="StartExportRequest();" > -->
    Click to jump to new export page.
    <p>
    <div id=iframeHideDiv style="display:block;">
      <iframe id="ExportRequestFrame" onload="ExportRequestStarted();" name="ExportRequestFrame" src="" style="height:0px;width:0px;border:0px solid #fff;">helloiframe</iframe>
    </div>

  </div> <!-- /div Section 7, Export link -->
</div> <!-- /div TabExportDiv -->
<div id="TabPlotDiv">
  <p>
  <span id="graphDescription">
  Graph Selected Data
  </span>
  <p>
  <table>
  <tr>
    <td>
    <b>Select X axis</b><br>
    </td>
    <td>
    <form id="GraphXSelectForm">
      <select id="GraphXKeysSelect" value="index" onChange="GraphPickXKey();" > </select>
    </form>
    </td>
    <td>
    X-axis will be: <span id="graphXAxis">index</span>
    </td>
  </tr>
  <tr>
    <td>
    <b>Select Keywords</b><br>
    </td>
    <td>
    <form id="GraphSelectForm">
      <select id="GraphKeysSelect" size=8 multiple="multiple" onChange="GraphPickKeys();" > </select>
    </form>
    </td>
    <td>
    <span id="graphYAxis"></span>
    </td>
  </tr>
  </table>
  <input type="button" value="Create Graph"  style="background-color:#FFFF80" onClick="GraphCreate();" >
  <input type="button" value="Delete Graph"  style="background-color:#FFFF80" onClick="GraphDelete();" >
  <br>
  <span id="graphPlace"> <strong>No graph created yet</strong> </span>
  <div id="amChartDiv" style="display:none; height:600px; background-color:#FFFFFF">
  </div> <!-- amChartDiv -->
</div> <!-- /div TabPlotDiv -->
</div> <!-- /div Main including all tab divs -->
<div>
<img id="graphImage" alt="Right click to save me!">
</div>
<P style="height:1px">
<div id="footer" style="vertical-align:bottom;text-align:center;">
<hr>
  <i>Home pages for:</i>
  <a href = "http://jsoc.stanford.edu/"><b>SDO-JSOC</b></a>
  <b>|</b>
  <a href = "http://sha.stanford.edu/"><b>SHA</b></a>
</div>
</body>
</html>

