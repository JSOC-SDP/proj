<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; CHARSET=iso-8859-1">
<TITLE>JSOC Lookdata</TITLE>
<SCRIPT TYPE="text/javascript" SRC="js/prototype-1.6.1_rc3.js"></SCRIPT>
<SCRIPT TYPE="text/javascript" SRC="js/cookies.js"></SCRIPT>
<SCRIPT TYPE="text/javascript" SRC="js/prototip.js"></SCRIPT>
<link rel="stylesheet" type="text/css" href="css/prototip.css" ></link>

<style type="text/css">

#body { margin:0; padding:0; background:#ddf;}
#header { position:relative; top:0; left:0; width:100%; background:#eee; }
#footer { position:fixed; bottom:0; left:0; width:100%; background:#eee; }

#SeriesDiv { position:relative; margin:5px; }
#SeriesInfoDiv { position:relative; margin:5px; }
#MySeriesDiv { position:relative; margin:5px; }
#QueryDiv { position:relative; margin:5px; }
#FullInfoDiv { position:relative; margin:5px; }
#FullDisplayInfoDiv { position:relative; margin:5px; }

#SeriesSelect { width:40em; }
#KeysSelect { width:20em; }
#SegsSelect { width:20em; }
#SeriesFilter { width:20em; }
#RecordSet { width:35em; font-size:100%; }
#SeriesButton { width:15em; }

#InfoTable { border-spacing:1px; white-space:nowrap; }
td {padding:2px; }

span.tip { background-color:yellow }

</style>
 
<script type="text/javascript">

// 
// Documents for the server side tools can be found at
// "http://jsoc.stanford.edu/jsocwiki/AjaxJsocConnect"
//

// Global variables and initialize page locations

// var SeriesList = "";
// var SeriesInfo = "";
var CurrentSeries = 0;
var SeriesName = "";
var SeriesKeySegInfo = "";
var nprimes = 0;
var KeyList = "";
var SegList = "";
var nkeysselected = 0;
var nsegsselected = 0;
var RecordCount = 0;
var askedCount = 0;
var KeyValsFetched = 0;
var TipsEnabled;
var TipsCreated = 0;

var GetSeriesObject;
var GetValuesObject;


function InitPage()
  {
  $("SeriesFilter").value = "NOT ^dsds\\.";
  CleanSeriesSelect();
  $("RequestID").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("StatusLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("StatusDataLocation").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
  $("QueryDivCheck").checked = 0;
  $("QueryDiv").style.display="none";
  $("WhereClausesHelpDiv").style.display="none";
  // AbortGetKeyValues(); ---- do not do this here!!
  // GetSeriesAbort(); ---- do not do this here!!
  ClearStatus();
  }


function CleanSeriesSelect()
  {
  for (var i=$("SeriesSelect").length; i > 0; i--)
    {
    $("SeriesSelect").remove(i-1);
    }
  CleanSeriesInfo();
  }

function CleanSeriesInfo()
  {
  SeriesName = "";
  $("RecordSet").value = "";
  $("SeriesButton").disabled = false;
  $("FetchKeyValsButton").disabled = false;
  $("FetchKeyValsButton").value = "Fetch Keyword Values for RecordSet";
  $("FetchKeyValsButton").style.backgroundColor = "#FFFF80";
  $("Series_Info_Place").innerHTML = "";
  $("Series_Name_Place").innerHTML = "";
  $("FirstLastPlace").innerHTML = "";
  $("SeriesCountPlace").innerHTML = "<I>TBD</I>";
  CleanSeriesPick();
  }

function CleanSeriesPick()
  {
  $("KeyListPlace").innerHTML = "All Keywords";
  $("SegListPlace").innerHTML = "All Segments";
  $("LinkListPlace").innerHTML = "";
  $("DisplayPlace").innerHTML = "";
  KeyList = "";
  SegList = "";
  $("SSKeysPlace").innerHTML = "";
  $("SSPlace").innerHTML = "";
  $("RSCount_Place").innerHTML = "";
  RecordCount = 0;
  nkeysselected = 0;
  nsegsselected = 0;
  nlinksselected = 0;
  askedCount = 0;
  $("WantRecInfo").checked = 1;
  $("WantLinkInfo").checked = 0;
  $("WantFullSegInfo").checked = 0;
  $("WantLinkDiv").style.display="none";
  $("AllowBigQueries").checked = 0;
  $("RecSetPlace").innerHTML = "";
  $("MakeLocalFileLinks").checked = 0;
  CleanKeysSelect();
  }

function CleanKeysSelect()
  {
  KeyValsFetched = 0;
  for (var i=$("KeysSelect").length; i > 0; i--)
    $("KeysSelect").remove(i-1);
  for (var i=$("SegsSelect").length; i > 0; i--)
    $("SegsSelect").remove(i-1);
  $("DisplayPlace").innerHTML = "";
  $("SegListPlace").innerHTML = "";
  $("LinkListPlace").innerHTML = "";
  $("KeyListPlace").innerHTML = "";
  KeyList =  "";
  SegList =  "";
  CleanOnLoad();
  }

function CleanOnLoad()
  {
  $("AbortGetSeriesButton").hide();
  $("AbortKeyValsButton").hide();
  $("FetchKeyValsButton").style.backgroundColor = "#FFFF80";
  $("SeriesButton").style.backgroundColor = "#FFFF80";
  $("SeriesDiv").style.display="block";
  $("SeriesDivButton").style.backgroundColor = "FFD8D8";
  $("FullInfoDiv").style.display="block";
  // $("FullInfoDivButton").style.backgroundColor = "FFD8D8";
  CreateTips();
  $("TipsOnOffButton").value = "Turn Help Off";
  }

function CreateTips()
  {
  var tipstyle =
    {
    style:'protogrey',
    hook:{target:'topRight',tip:'bottomLeft'},
    stem:'bottomLeft',
    closeButton:false,
    hideAfter:5,
    hideOn:'click',
    showOn:'click',
    border:3,
    radius:3,
    };
  if (TipsCreated == 0)
    {
    // The following sample line goes in html code
       // <SPAN ID="SampleHelp" class="tip">?</SPAN>
    // the following line goes here
       // new Tip("SampleHelp","Help text here.",tipstyle);
    // XXXX HELP XXXX
    new Tip("PickSeriesHelp","This section is used to identify the JSOC data series you want to explore.  If you already know the series you may go to step 3 and enter the seriesname there.",tipstyle);
    new Tip("QueryBuilderHelp","This checkbox enables input boxes for recordset query clauses.  You may enter the desired recordset query in the text box below or with the QueryBuilder enabled just enter the seriesname in the main box and record selection clauses in the subsequent boxes.  There will be one box for each Prime-Key and one SQL where-clause box that keeps the Prime-Key version logic enabled '[?...?]', and one SQL where-clause box that will disable the Prime-Key version logic if the box is not empty '[!...!]'.  The punctuation is filled-in for you, i.e. the '[,?,!,]' as needed.",tipstyle);
    new Tip("RecordSetHelp","This text box is used to specify the Recordset you wish to examine or export.  You may start with just the seriesname to get a count of all the records in the series, then add filter clauses to limit the selected records to just the ones you want to examine or export.",tipstyle);
    }
  TipsCreated = 1;
  $$("span.tip").each(function(showspan){showspan.show();}); 
  }

function HideTips()
  {
  $$("span.tip").each(function(hidespan){hidespan.hide();}); 
  Tips.hideAll();
  }

function ToggleHelp()
  {
  if (TipsEnabled)
    {
    HideTips();
    $("TipsOnOffButton").value = "Turn Help On";
    TipsEnabled = 0;
    }
  else
    {
    CreateTips();
    $("TipsOnOffButton").value = "Turn Help Off";
    TipsEnabled = 1;
    }
  }

// Hide and show DIVs on button click.
// Arg is div id.
// Button id should be div id with suffix of "Button"

function ToggleSectionDiv(divname)
{
  var button = $(divname + "Button");
  var div = $(divname);
  if (div.style.display == "block")
    {
    button.style.backgroundColor = "D8FFD8";
    button.value = "Show Section";
    div.style.display="none";
    }
  else
    {
    button.style.backgroundColor = "FFD8D8";
    button.value = "Hide Section";
    div.style.display="block";
    }
  }

// Hide and show DIVS on checkbox change.
// Checkbox id should be div id with suffix of "ChecK"

function CheckBoxChangeDiv(divname)
  {
  var chbox = $(divname + "Check");
  var div = $(divname);
  if (chbox.checked == 0)
    div.style.display="none";
  else
    div.style.display="block";
  }

 function QueryDivCheckToggle()
  {
  if ($("QueryDivCheck").checked == 0)
    {
    $("QueryDiv").style.display="none";
    }
  else
    {
    $("QueryDiv").style.display="block";
    }
  }

function insertOption(list,text,note)
  {
  var y=document.createElement('option');
  y.value=text;
  if (note.length)
    y.text = text + "  --- " + note;
  else
    y.text = text;
  var x = $(list);
  try
    {
    x.add(y,null); // standards compliant
    }
  catch(ex)
    {
    x.add(y); // IE only
    }
  }

var myGlobalHandlers = {
	onCreate: function()
	  {
          $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
          Element.show('systemWorking');
          },
	onComplete: function()
          {
          if(Ajax.activeRequestCount == 0)
            {
            $("AjaxBusy").innerHTML = "0";
	    Element.hide('systemWorking');
            }
          }
};

Ajax.Responders.register(myGlobalHandlers);

// Section 1.0 support, Get list of series and build select list for 2.0

function GetSeriesAbort()
  {
  if (GetSeriesObject == undefined)
    {
    return;
    }
  else if (GetSeriesObject.transport.readyState != 4)
    {
    GetSeriesObject.transport.abort();
    $("SeriesButton").style.backgroundColor = "#FFFF80";
    $("SeriesButton").value = "Fetch seriesname list";
    $("SeriesButton").disabled = false;
    $("AbortGetSeriesButton").hide();
    }
  }

function GetSeries()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  CleanSeriesInfo();
  $("SeriesButton").value = "Processing...";
  $("SeriesButton").style.backgroundColor = "#FFC8C8";
  $("SeriesButton").disabled = true;
  $("AbortGetSeriesButton").show();
  $("SeriesCountPlace").innerHTML = "<I>wait...</I>";
  GetSeriesObject = new Ajax.Request('http://jsoc.stanford.edu/cgi-bin/ajax/show_series',
    {
    method: 'get',
    parameters: {"filter" : $("SeriesFilter").value },
    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no response text";
      var SeriesList = response.evalJSON();
      CleanSeriesSelect();
      var n = SeriesList.n;
      for (var i = 0; i < n; i++)
        {
	insertOption("SeriesSelect",SeriesList.names[i].name,SeriesList.names[i].note);
        }
      $("SeriesCountPlace").innerHTML = SeriesList.n ;
      $("SeriesButton").style.backgroundColor = "#FFFF80";
      $("SeriesButton").value = "Fetch seriesname list";
      $("SeriesButton").disabled = false;
      $("AbortGetSeriesButton").hide();
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      },
    onFailure: function() { alert('Something went wrong...'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  }

// Section 2.0 support Select seriesfrom select list made in section 1.0
// Uses jsoc_info op=series_struct
// Get list of all keywords and segments with supporting info
// Fetches full list of keywords and segments for display in section 4 and
// build select lists used in section 4 and 5.
// If mode==0 then use the SeriesSelect box for the chosen series.
// else if mode==1 then use the SeriesName variable as is and fetch
// info and reset all associated references.
// If mode==2 then the section 3 series name becomes the new SeriesName
// and info for it will be found and displayed.

function PickSeries(mode)
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  CleanSeriesPick();
  if (mode == 0)
    {
    CurrentSeries = $("SeriesSelect").selectedIndex;
    SeriesName = $("SeriesSelect").options[CurrentSeries].value;
    }
  if (mode != 2)
    {
    $("RecordSet").value = SeriesName;
    $("QueryPlace").innerHTML = "";
    }
  $("Series_Name_Place").innerHTML = SeriesName;
  $("RecSetPlace").innerHTML = SeriesName;
  $("FirstLastPlace").innerHTML = "... Fetching Series Information ...";
  new Ajax.Request('http://jsoc.stanford.edu/cgi-bin/ajax/jsoc_info',
    {
    method: 'get',
    parameters: {"ds" : SeriesName, "op" : "series_struct" },

    onSuccess: function(transport, json)
      {
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      var response = transport.responseText || "no response text";
      var SeriesInfo = response.evalJSON();
      if (SeriesInfo.status == 1)
        {
        $("FirstLastPlace").innerHTML = "No Matching Series Found";
        $("SSPlace").innerHTML = "No Series Struct Found";
        $("SSKeysPlace").innerHTML = "";
        CleanKeysSelect();
        }
      else
        {
        var i;
        // Get series descriptive note and display
        $("Series_Info_Place").innerHTML = "Series Description: " + SeriesInfo.note;

        // Get list of prime keys and index keys and display info
        var QueryBoxes = "<TABLE>";
	nprimes = SeriesInfo.primekeys.length;
	var primes = "No PrimeKeys";
        if (nprimes == 1 && SeriesInfo.primekeys[0] == null)
          nprimes = 0;
	if (nprimes > 0)
	  for (i=0; i<nprimes; i++)
            {
            if (i==0)
	        primes = SeriesInfo.primekeys[0];
            else
	        primes = primes + ", " + SeriesInfo.primekeys[i];
            var s, k;
            for (k=0; k<SeriesInfo.keywords.length; k++)
               if (SeriesInfo.keywords[k].name === SeriesInfo.primekeys[i])
                  break;
            for (s=0; s<SeriesInfo.keywords.length; s++)
               if (SeriesInfo.keywords[s].name === SeriesInfo.primekeys[i]+"_index")
                  break;
            var isslotted = s < SeriesInfo.keywords.length;
            QueryBoxes = QueryBoxes + 
                "<TR><TD>" + SeriesInfo.primekeys[i] + "</TD>" + 
                "<TD align='right'>" + "[&nbsp;&nbsp;<input id='Prime" + i +
                "' type='text' value='' onChange='QueryBuild();' >&nbsp;&nbsp;]</TD>" +
                "<TD> (" + SeriesInfo.keywords[k].type + (isslotted ? "-slotted" : "") + ")</TD>";
            if (SeriesInfo.keywords[k].type === "time")
                QueryBoxes = QueryBoxes + "<TD> expects " + SeriesInfo.keywords[k].units + "</TD>";
            else
                QueryBoxes = QueryBoxes + "<TD></TD>";

            QueryBoxes = QueryBoxes +  "</TR>";
            }
        QueryBoxes = QueryBoxes +  "<TR><TD>where clause</TD>" + 
            "<TD align='right'>" + "[?&nbsp;<input id='WhereClause0' type='text' value='' onChange='QueryBuild();' >&nbsp;?]</TD>" +
            "<TD colspan=2>Uses prime key logic</TD></TR>";
        QueryBoxes = QueryBoxes +  "<TR><TD>where clause</TD>" + 
            "<TD align='right'>" + "[!&nbsp;<input id='WhereClause1' type='text' value='' onChange='QueryBuild();' >&nbsp;!]</TD>" +
            "<TD colspan=2> use disables prime key logic</TD></TR>";
        QueryBoxes = QueryBoxes + "</TABLE>";
        $("QueryPlace").innerHTML = QueryBoxes;
        if ($("QueryDivCheck").checked == 1)
            {
	    $("QueryDiv").style.display="block";
            }
        else
            {
	    $("QueryDiv").style.display="none";
            }
	var n = SeriesInfo.dbindex.length;
	var dbindex = "No DBindex";
	if (n > 0) dbindex = SeriesInfo.dbindex[0];
	for (i=1; i<n; i++)
	    dbindex = dbindex + ", " + SeriesInfo.dbindex[i];
        $("SSKeysPlace").innerHTML = "PrimeKeys: " + primes + "<BR>" +
                                     "DBindex: " + dbindex + "<BR>";
        // Add segment information if present
        if (SeriesInfo.segments.length > 0)
	  {
          if (SeriesInfo.archive > 0)
            $("SSKeysPlace").innerHTML = $("SSKeysPlace").innerHTML +
		"Data is archived, online retention " + SeriesInfo.retention + " days<BR>";
	  else
            $("SSKeysPlace").innerHTML = $("SSKeysPlace").innerHTML +
		"Data NOT archived, online retention " + SeriesInfo.retention + " days<BR>";
          $("SSKeysPlace").innerHTML = $("SSKeysPlace").innerHTML + "Unitsize: " + SeriesInfo.unitsize + " record" +
	    (SeriesInfo.unitsize > 1 ? "s" : "") + "<P>";
	  }
	else
          $("SSKeysPlace").innerHTML = $("SSKeysPlace").innerHTML + "No SUMS storage for this series<P>";

        // build and display keyword selection scroll box and keyword part of full table
	var keywords = "No keywords";
	n = SeriesInfo.keywords.length;
	if (n > 0)
	   {
	   insertOption("KeysSelect","**NONE**", "");
	   insertOption("KeysSelect","**ALL**", "");
	   insertOption("KeysSelect","*logdir*", "");
	   insertOption("KeysSelect","*recnum*", "");
	   insertOption("KeysSelect","*sunum*", "");
	   insertOption("KeysSelect","*size*", "");
	   insertOption("KeysSelect","*online*", "");
	   insertOption("KeysSelect","*retain*", "");
	   insertOption("KeysSelect","*archive*", "");
	   keywords = "<table BORDER=1><TR><TH>keyword</TH><TH>type</TH><TH>unit</TH><TH>note</TH>"; 
	   for (i=0; i<n; i++)
	      {
	      insertOption("KeysSelect",SeriesInfo.keywords[i].name, "");
	      keywords = keywords + "<TR><TD>" +
		SeriesInfo.keywords[i].name + "</TD><TD>" +
		SeriesInfo.keywords[i].type + "</TD><TD>" +
		SeriesInfo.keywords[i].units + "&nbsp;</TD><TD>" +
		SeriesInfo.keywords[i].note + "&nbsp;</TD>";
	      }
	   keywords = keywords + "</table><P>";
	   }

        // build and display segment selection scroll box and segment part of full table
	var segments = "No segments";
	n = SeriesInfo.segments.length;
	if (n > 0)
	   {
	   segments = "<table BORDER=1><TR><TD>segment</TD><TD>units</TD><TD>dims</TD><TD>protocol</TD><TD>note</TD>";
	   insertOption("SegsSelect","**NONE**", "");
	   insertOption("SegsSelect","**ALL**", "");
	   for (i=0; i<n; i++)
	      {
	      insertOption("SegsSelect",SeriesInfo.segments[i].name, "");
	      segments = segments + "<TR><TD>" + SeriesInfo.segments[i].name + "</TD><TD>" + SeriesInfo.segments[i].units + "&nbsp;</TD><TD>" +
		SeriesInfo.segments[i].dims + "&nbsp;</TD><TD>" + SeriesInfo.segments[i].protocol + "</TD><TD>" + SeriesInfo.segments[i].note + "&nbsp;</TD>";
	      }
	   segments = segments + "</table><P>";
	   }

        // Add checkbox if there are links and link part of full table
	var links = "No links";
	n = SeriesInfo.links.length;
	if (n > 0)
	   {
	   links = "<table BORDER=1><TR><TD>link</TD><TD>target </TD><TD>kind</TD><TD>note</TD>";
	   for (i=0; i<n; i++)
	      links = links + "<TR><TD>" + SeriesInfo.links[i].name + "</TD><TD>" + SeriesInfo.links[i].target + "</TD><TD>" +
		      SeriesInfo.links[i].kind + "</TD><TD>" + SeriesInfo.links[i].note + "&nbsp;</TD>";
	   links = links + "</table><P>";
           // If links present allow for showing them in listings
           $("WantLinkInfo").checked = 0;
           $("WantFullSegInfo").checked = 0;
           $("WantLinkDiv").style.display="block";
	   }

	// Place structure table on screen
        $("SSPlace").innerHTML =  keywords + "<BR>" + segments + "<BR>" + links;

	// Place first and last record info on screen
	if (SeriesInfo.Interval.MaxRecnum > 0)
          $("FirstLastPlace").innerHTML = "First Record = " + SeriesInfo.Interval.FirstRecord + 
              "<BR>Last Record = " + SeriesInfo.Interval.LastRecord +
	      "<BR>First Rec., Last Rec. and largest used recnums: " + SeriesInfo.Interval.FirstRecnum + ", " +
              SeriesInfo.Interval.LastRecnum + ", " +  SeriesInfo.Interval.MaxRecnum + " resp." ;
	else
	  $("FirstLastPlace").innerHTML = "This series contains no records";
        // Done displaying detailed information for this series
        }
      $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
      },
    onFailure: function() { alert('Something went wrong...'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  }

// Section 3.0 support - Get record count
// Uses jsoc_info op=rs_summary which may take a while but
// also validates recordset query that will be used in section 6.

function GetRSCount()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
// concatenate parts here, display in fixed string
  var posbracket = $("RecordSet").value.indexOf("[");
  var posRbracket = $("RecordSet").value.indexOf("]");
  var thisSeriesName;
  if (posbracket == -1)
    {
    thisSeriesName = $("RecordSet").value;
    }
  else
    {
    if (posRbracket == -1)
      {
      $("RSCount_Place").innerHTML = "ERROR - missing right bracket - ]";
      return;
      }
    thisSeriesName = $("RecordSet").value.substr(0,posbracket);
    }
  if (thisSeriesName != SeriesName)
    {
    $("RSCount_Place").innerHTML = "Getting series information - wait...";
    SeriesName = thisSeriesName;
    PickSeries(2);
    }
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  $("RSCount_Place").innerHTML = "Getting count - wait...";
  RecordCount = -1;
  askedCount = 1;
  new Ajax.Request('http://jsoc.stanford.edu/cgi-bin/ajax/jsoc_info',
    {
    method: 'get',
    parameters: {"ds" : $("RecordSet").value, "op" : "rs_summary" },

    onSuccess: function(transport, json)
      {
      var response = transport.responseText || "no response text";
      var SummaryData = response.evalJSON();
      if (SummaryData.status != 0)
        {
	RecordCount = 0;
        $("RSCount_Place").innerHTML = "No RecordSet Count Found";
        }
      else
	{ 
	RecordCount = SummaryData.count;
	$("RSCount_Place").innerHTML = SummaryData.count;
	}
      $("ExportRecordSet").innerHTML = $("RecordSet").value;
      if (nsegsselected > 0)
        $("ExportRecordSet").innerHTML = $("ExportRecordSet").innerHTML + "{" + SegList + "}";
      $("RecSetPlace").innerHTML = $("RecordSet").value;
      if (KeyValsFetched == 1)
        {
        $("FetchKeyValsButton").value = "Update Keyword Values for RecordSet";
        $("FetchKeyValsButton").style.backgroundColor = "#FFD8D8";
        }
      },
    onFailure: function() { alert('Something went wrong...'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  }

// QueryBuild is called when where clause specs are added to build a recordset spec
function QueryBuild()
  { 
  var QueryString = SeriesName;
  for (var i=0; i<nprimes; i++)
    {
    QueryString = QueryString + "[" + $("Prime"+i).value + "]";
    }
  if ($("WhereClause0").value.length > 0)
    QueryString = QueryString + "[? " + $("WhereClause0").value + " ?]";
  if ($("WhereClause1").value.length > 0)
    QueryString = QueryString + "[! " + $("WhereClause1").value + " !]";
  $("RecordSet").value = QueryString;
  }

// Section 4, Select keys for fetching values
// Uses select list of keyword names made in section 4.
// Places result in list to be used in section 6.

function PickKeys()
  {
  var ikey = 0;
  nkeysselected = 0;
  var nkeys = $("KeysSelect").length;
  var selkeys =  "";
  $("KeyListPlace").innerHTML = "";
  $("DisplayPlace").innerHTML = "";
  // $("WantRecInfo").checked = 0;
  KeyList =  "";
  selkeys = "";
  // check for **NONE**
  if ($("KeysSelect")[0].selected)
    {
    nkeysselected = 0;
    selkeys = "**NONE**";
    KeyList = "**NONE**";
    }
  // check for **ALL**
  // else if ($("KeysSelect")[1].selected)
    // {
    // nkeysselected = nkeys - 2;
    // selkeys = "**ALL**";
    // KeyList = "**ALL**";
    // }
  else
   for (ikey=0; ikey < nkeys; ikey++)
    if ($("KeysSelect")[ikey].selected)
      {
      if (nkeysselected)
	{
	selkeys = selkeys + ", ";
        KeyList = KeyList + ",";
	}
      nkeysselected = nkeysselected + 1;
      selkeys = selkeys + $("KeysSelect")[ikey].text;
      KeyList = KeyList + $("KeysSelect")[ikey].text;
      }
  $("KeyListPlace").innerHTML = nkeysselected + " Keys Chosen:&nbsp;" + selkeys;
  }

// Section 5., Select segments for fetching pathnames
// Uses select list of segment names made in section 4.
// Places result in list to be used in section 6.

function PickSegs()
  {
  var iseg = 0;
  nsegsselected = 0;
  var nsegs = $("SegsSelect").length;
  var selsegs =  "";
  $("SegListPlace").innerHTML = "";
  $("DisplayPlace").innerHTML = "";
  // $("WantRecInfo").checked = 0;
  SegList =  "";
  selsegs = "";
  // check for **NONE**
  if ($("SegsSelect")[0].selected)
    {
    nsegsselected = 0;
    selsegs = "**NONE**";
    SegList = "**NONE**";
    }
  // check for **ALL**
  else if ($("SegsSelect")[1].selected)
    {
    nsegsselected = nsegs - 2;
    selsegs = "**ALL**";
    SegList = "**ALL**";
    }
  else
   for (iseg=0; iseg < nsegs; iseg++)
    if ($("SegsSelect")[iseg].selected)
      {
      if (nsegsselected)
	{
	selsegs = selsegs + ", ";
        SegList = SegList + ",";
	}
      nsegsselected = nsegsselected + 1;
      selsegs = selsegs +  $("SegsSelect")[iseg].text;
      SegList = SegList +  $("SegsSelect")[iseg].text;
      }
  $("SegListPlace").innerHTML = nsegsselected + " Segs Chosen:&nbsp;" + selsegs;
  }

// Section 6.0 - Get record values for selected keywords and segments
// Uses jsoc_info op=rs_list
// Places result in table.

function AbortGetKeyValues()
  {
  if (GetValuesObject == undefined)
    {
    return;
    }
  else if (GetValuesObject.transport.readyState != 4)
    {
    GetValuesObject.transport.abort();
    $("FetchKeyValsButton").value = "Fetch Keyword Values for RecordSet";
    $("FetchKeyValsButton").style.backgroundColor = "#FFFF80";
    $("FetchKeyValsButton").disabled = false;
    $("AbortKeyValsButton").hide();
    $("DisplayPlace").innerHTML = "Request aborted";
    }
  }

function GetKeyValues()
  {
  $("AjaxBusy").innerHTML = Ajax.activeRequestCount;
  var getparameters = new Hash( {"ds" : $("RecordSet").value, "op" : "rs_list" });
  $("DisplayPlace").innerHTML = "Requesting Recordset Key Values ...";
  // do the link checkbox work here since no section 5.5...
  if ($("WantLinkInfo").checked)
    {
    nlinksselected = 1;
    $("LinkListPlace").innerHTML = " ALL Links Chosen";
    }
  else
    {
    nlinksselected = 0;
    $("LinkListPlace").innerHTML = "";
    }
  if (nkeysselected < 1 && nsegsselected < 1 && nlinksselected < 1 && $("WantRecInfo").checked == 0)
    {
    $("DisplayPlace").innerHTML = "No keywords and NO segments requested.<BR>Please fo back to steps 4 and 5."; 
    return;
    }
  if (nkeysselected)
    getparameters = getparameters.merge({"key": KeyList});
  else
    getparameters = getparameters.merge({"key":"**NONE**"});
  if (nsegsselected)
    getparameters = getparameters.merge({"seg": SegList});
  else
    getparameters = getparameters.merge({"seg":"**NONE**"});
  if (nlinksselected)
    getparameters = getparameters.merge({"link":"**ALL**"});
  if ($("WantRecInfo").checked) getparameters = getparameters.merge({"R":1});
  if (RecordCount == 0 && askedCount == 0)
      GetRSCount();
  if (RecordCount < 0)
    {
      $("DisplayPlace").innerHTML = "RecordSet count underway (step 3), please wait for it to complete before retrying";
      return;
    }
  if (RecordCount == 0)
    {
    $("DisplayPlace").innerHTML = "There are no records in the chosen RecordSet";
    return;
    }
  if (RecordCount > 10000 && !$("AllowBigQueries").checked)
    {
    $("DisplayPlace").innerHTML = "Requested Recordset is too large for this function, " + RecordCount + 
	" records.<BR>Please go back to step 3 and choose a smaller recordset.";
    return;
    }
  $("FetchKeyValsButton").value = "Processing ...";
  $("FetchKeyValsButton").style.backgroundColor = "#FFD8D8";
  $("FetchKeyValsButton").disabled = true;
  $("AbortKeyValsButton").show();
  GetValuesObject = new Ajax.Request('http://jsoc.stanford.edu/cgi-bin/ajax/jsoc_info',
    {
    method: 'get',
    parameters: getparameters.toObject(),

    onSuccess: function(transport, json)
      {
      $("DisplayPlace").innerHTML = "Data received, processing ...";
      var response = transport.responseText || "no response text";
      var RecordData = response.evalJSON();
      // var RecordData = JSON.parse(response);
      var valuetable = "";
      if (RecordData.status == 1)
        {
        $("DisplayPlace").innerHTML = RecordData.error;
	AbortGetKeyValues();
        }
      else
        {
        $("FetchKeyValsButton").value = "Fetch Keyword Values for RecordSet";
        $("FetchKeyValsButton").style.backgroundColor = "#FFFF80";
        $("FetchKeyValsButton").disabled = false;
        $("AbortKeyValsButton").hide();
        KeyValsFetched = 1;
	var thissegdata = "";
	var nkeys = RecordData.keywords.length;
	var nsegs = RecordData.segments.length;
	var nlinks = RecordData.links.length;
	var nrecs = RecordData.count;
	wantLocalLinks = $("MakeLocalFileLinks").checked;
        $("DisplayPlace").innerHTML = "Status = " + RecordData.status + ", Recordset Key Values for " + nrecs + " records returned, preparing page ...";
        wantrecinfo = $("WantRecInfo").checked;
	valuetable = "<TABLE border=1 id='InfoTable' ><TR>"
	if (wantrecinfo)
	  valuetable = valuetable +  "<TH>RecordName</TH>"
	for (var ikey=0; ikey < nkeys; ++ikey)
           valuetable = valuetable + "<TH>" + RecordData.keywords[ikey].name + "</TH>";
	for (var iseg=0; iseg < nsegs; ++iseg)
           {
           valuetable = valuetable + "<TH>segment: " + RecordData.segments[iseg].name + "</TH>";
	   valuetable = valuetable + "<TH>seg_dims: " + RecordData.segments[iseg].name + "</TH>";
	   if ($("WantFullSegInfo").checked == 1)
	       {
	       valuetable = valuetable + "<TH>seg_cparms: " + RecordData.segments[iseg].name + "</TH>";
	       valuetable = valuetable + "<TH>seg_bzero: " + RecordData.segments[iseg].name + "</TH>";
	       valuetable = valuetable + "<TH>seg_bscale: " + RecordData.segments[iseg].name + "</TH>";
               }
            }
	  for (var ilink=0; ilink < nlinks; ++ilink)
             valuetable = valuetable + "<TH>" + "Link: " + RecordData.links[ilink].name + "</TH>";
	  valuetable = valuetable + "</TR>";

	  for (var irec=0; irec < nrecs; irec++)
	    {
	    valuetable = valuetable + "<TR>";
	    if (wantrecinfo)
	      valuetable = valuetable +  "<TD>" + RecordData.recinfo[irec].name + "</TD>";
	    for (ikey=0; ikey<nkeys; ikey++)
	     {
	     var this_keyval =  RecordData.keywords[ikey].values[irec];
	     if (RecordData.keywords[ikey].name == "*logdir*")
	       {
	       if (this_keyval.charAt(0) == '/')
	         {
	         tmp = "<A HREF=http://jsoc.stanford.edu" + this_keyval + ">" + this_keyval + "</A>";
	         this_keyval = tmp;
	         }
               }
             if (this_keyval.length == 0) this_keyval = "&nbsp;";
                valuetable = valuetable + "<TD>" + this_keyval + "</TD>";
	     }
	    for (iseg=0; iseg<nsegs; iseg++)
	      {
	      var thissegdims = RecordData.segments[iseg].dims[irec];
	      var thissegdata = RecordData.segments[iseg].values[irec];
	      if ($("WantFullSegInfo").checked == 1)
	         {
                 var thissegcparms = RecordData.segments[iseg].cparms[irec];
                 var thissegbzero = RecordData.segments[iseg].bzeros[irec];
                 var thissegbscale = RecordData.segments[iseg].bscales[irec];
	         }
              if (wantrecinfo && RecordData.recinfo[irec].online)
	        {
	        if (wantLocalLinks)
                   tmp = "<A HREF=file://" + thissegdata + ">" + thissegdata + "</A>";
                else
	           tmp = "<A HREF=http://jsoc.stanford.edu" + thissegdata + ">" + thissegdata + "</A>";
	        thissegdata = tmp;
	        }
              if (thissegdata == null || thissegdata.length == 0) thissegdata = "&nbsp;";
	        valuetable = valuetable + "<TD>" + thissegdata + "</TD>";
	      if (thissegdims == null || thissegdims.length == 0) thissegdims = "&nbsp;";
                valuetable = valuetable + "<TD>" + thissegdims + "</TD>";
	      if ($("WantFullSegInfo").checked == 1)
	        {
                if (thissegcparms == null || thissegcparms.length == 0) thissegcparms = "&nbsp;";
                    valuetable = valuetable + "<TD>" + thissegcparms + "</TD>";       
                if (thissegbzero == null || thissegbzero.length == 0) thissegbzero = "&nbsp;";
                    valuetable = valuetable + "<TD>" + thissegbzero + "</TD>";
                if (thissegbscale == null || thissegbscale.length == 0) thissegbscale = "&nbsp;";
                    valuetable = valuetable + "<TD>" + thissegbscale + "</TD>";
	        }
	      }
	    for (ilink=0; ilink<nlinks; ilink++)
	      {
	      var this_linkval =  RecordData.links[ilink].values[irec];
              if (this_linkval == null || this_linkval.length == 0) this_linkval = "&nbsp;";
                valuetable = valuetable + "<TD>" + this_linkval + "</TD>";
	      }
	    valuetable = valuetable + "</TR>";
	    }
	valuetable = valuetable + "</TABLE>";
        $("DisplayPlace").innerHTML =  valuetable + "<BR>";
        }
      },
    onFailure: function() { alert('Something went wrong...'); },
    onComplete: function() { $("AjaxBusy").innerHTML = Ajax.activeRequestCount; }
    });
  }

function Export_Recordset()
  {
  Cookie.init({name:"exportdata"});
  Cookie.setData("state",0);
  if (nsegsselected > 0 && $("ExportRecordSet").innerHTML.indexOf("}") == -1)
    $("ExportRecordSet").innerHTML = $("ExportRecordSet").innerHTML + "{" + SegList + "}";
  ExportWindow=window.open("http://jsoc.stanford.edu/ajax/exportdata.html?ds="+$("ExportRecordSet").innerHTML,
             "JSOC_Export");
  ExportWindow.window.focus();
  }

</script>

</HEAD>

<BODY BGCOLOR="#E0F0FF" onLoad="CleanOnLoad();" >

<DIV ID="header">
<IMG src="http://hmi.stanford.edu/images/web/JSOC_120.gif"
  style="vertical-align:middle;height:60" alt="JSOC logo">
&nbsp;&nbsp;&nbsp;
<B><big style="vertical-align:middle">&nbsp;&nbsp;JSOC Data Explore Info and Export</big></B>
&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;
<input type="button" value="reset page" onClick="InitPage();" >
&nbsp;&nbsp;&nbsp;
<input id="TipsOnOffButton" type="button" value="Turn Help Off" onClick="ToggleHelp();" >
&nbsp;&nbsp;<span id="AjaxBusy">0</span> Requests Pending
<span id='systemWorking'>, Loading...</span>
<!-- <br clear=all> -->
<HR>
</DIV> <!-- end DIV header -->
<B>1. Find list of dataseries, and 2. Pick series to use</B>
<SPAN ID="PickSeriesHelp" class="tip">?</SPAN>
<input id="SeriesDivButton" type="button" value="Hide Section" style="background-color:#FFD8D8" onClick="ToggleSectionDiv('SeriesDiv');" >
<DIV id="SeriesDiv">
<TABLE style="width:98%">
<TR>
<TD  style="width:50%;vertical-align:top;">
Enter a dataseries match pattern to search for seriesnames, or leave blank to select from all series.
(A very bad idea now that we have about 34,000 seriesnames.)
A leading "NOT " means exclude names matching the subsequent pattern.
The default filter excludes namespace "dsds."
<P>
<input id="SeriesFilter" type="text" name="filter" value="NOT ^dsds\." onChange="GetSeries();" >
<BR>
<input id="SeriesButton" type="button" value="Fetch seriesname list" style="background-color:#FFFF80" onClick="GetSeries();" > 
<input id="AbortGetSeriesButton" type="button" value="Abort" style="background-color:#FFD0D0" onClick="GetSeriesAbort();" > 
<br>
<span id="SeriesCountPlace" style="background-color:#FFFFFF;width:2em"><I>TBD</I></span>
Series match this selection filter.
</TD>
<TD  style="width:40%;vertical-align:top;">
Select data series here.
<BR>
<select id="SeriesSelect" size=8 onclick="PickSeries(0)"> </select>
</TD>
<TD style="width:60%;vertical-align:top;">
</TR>
</TABLE>
</DIV> <!-- /DIV SeriesDiv -->
<HR>
<DIV id="MySeriesDiv" >

<TABLE style="width:98%">
<TR><TD style="width:40%"></TD><TD style="width:60%;"></TD></TR>

<TR>
<TD rowspan=2 style="vertical-align:top;height:60pt">
<B>Information about selected series</B><BR>
Current Series is:
<span id="Series_Name_Place" style="background-color:#FFFFFF"></span>
<BR>
<span id="SSKeysPlace" style="background-color:#FFFFFF;"></span>
</TD>
<TD style="vertical-align:top">
&nbsp;<BR>
<span id="Series_Info_Place" style="background-color:#FFFFFF"></span>
</TD>
</TR>

<TR>
<TD >
<span id="FirstLastPlace" style="vertical-align:top;background-color:#FFFFFF"></span>
</TD>
</TR>
</TABLE>

<TABLE>
<TR><TD style="width:25%"></TD><TD style="width:25%;"></TD><TD  style="width:50%"></TR>

<TR>
<TD colspan=2  style="vertical-align:top;">
<H3>Select Records and Get Record Count</H3>
Enter RecordSet Specification here for keyword listings and for export.
<BR>
<SPAN ID="QueryBuilderHelp" class="tip">?</SPAN>
<input type="checkbox" name="" id="QueryDivCheck" onChange="QueryDivCheckToggle();">
Check box  to show the QueryBuilder.
<BR>
Request may take a while if the recordset is large (more than a few thousand records).
<P>
<SPAN ID="RecordSetHelp" class="tip">?</SPAN>
<input id="RecordSet" type="text" value="" onChange="GetRSCount();" > 
<BR>
</TD>

<TD rowspan=4 style="vertical-align:top;">
<H3>List of All Keywords and Segments</H3>
<DIV id="SeriesInfoDiv"  style="background-color:#FFFFFF;border:solid;border-width:thin;height:360;overflow:scroll">
<span id="SSPlace" style="background-color:#FFFFFF;"></span>
</DIV>
</TD>
</TR>

<TR>
<TD colspan=2  style="vertical-align:top;">
<DIV id="QueryDiv">
<span id="QueryPlace" style="width:10em;background-color:#FFFFFF"></SPAN></span>
</DIV>
</TD>
</TR>

<TR>
<TD colspan=2  style="vertical-align:top;">
<input type="button" value="GetRecordCount"  style="background-color:#FFFF80" onClick="GetRSCount();" >
Record Count:&nbsp;&nbsp;
<span id="RSCount_Place" style="width:10em;background-color:#FFFFFF"></span>
<BR>
<DIV id="WantLinkDiv">
<input type="checkbox" name="Show Links" id="WantLinkInfo"> Check to select all links
</DIV>
</TD>
</TR>

<TR>
<TD >
<H3>4. Select Keywords</H3>
Select Keywords for Detailed Lists
<BR>
<form id="KeysSelectForm">
<select id="KeysSelect" size=8 multiple=true onChange="PickKeys();" > </select>
</form>
</TD><TD>
<H3>5. Select Segments</H3>
Select Segments for Detailed Lists
<BR>
<form id="SegsSelectForm">
<select id="SegsSelect" size=8 multiple=true onChange="PickSegs();"> </select>
</form>
</TD>
</TR>
</TABLE>
</DIV> <!-- id="MySeriesDiv" -->
<HR>

<H3> Get Keyword and Segment Values Here</H3>
<!--
<input id="FullInfoDivButton" type="button" value="Hide Section" style="background-color:#FFD8D8" onClick="ToggleSectionDiv('FullInfoDiv');" >
<BR>
-->
<DIV id="FullInfoDiv">
RecordSet Query:&nbsp;
<span id="RecSetPlace" style="background-color:#FFFFFF;"></span>
&nbsp; Keywords to Fetch:&nbsp;
<span id="KeyListPlace" style="background-color:#FFFFFF;"></span>
&nbsp; Segments to Fetch:&nbsp;
<span id="SegListPlace" style="background-color:#FFFFFF;"></span>
&nbsp;
<span id="LinkListPlace" style="background-color:#FFFFFF;"></span>

<BR>
<input type="checkbox" name="Get Record Query" id="WantRecInfo">
Check to Get Record Query.
&nbsp; &nbsp;
<input type="checkbox" name="AllowBigQueries" id="AllowBigQueries"> Check to Allow Huge Record Queries.
&nbsp; &nbsp;
<input type="checkbox" name="WantFullSegInfo" id="WantFullSegInfo"> Check to show full segment info 
&nbsp; &nbsp;
<input type="checkbox" name="MakeLocalFileLinks" id="MakeLocalFileLinks"> Check to make local file links (only at JSOC).
<BR>
<input type="button" id="FetchKeyValsButton" value="Fetch Keyword Values for RecordSet" style="background-color:#FFFF80" onClick="GetKeyValues();" >
<input type="button" id="AbortKeyValsButton" value="Abort" style="background-color:#FFD0D0" onClick="AbortGetKeyValues();" >
<P>
<DIV id="FullDisplayInfoDiv" style="background-color:#FFFFFF;border:solid;border-width:thin;height:190;width:98%;overflow:scroll">
<span id="DisplayPlace" style="background-color:#FFFFFF;"></span>
</DIV> <!-- /DIV FullDisplayInfoDiv -->
</DIV> <!-- /DIV FullInfoDiv -->
<HR>
<DIV>
RecordSet to export:
<span id="ExportRecordSet" style="background-color:#FFFFFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span >
<input id="ExportRequestButton" type="button" value="Export" onClick="Export_Recordset();" >
Click to jump to new export page.
<p>
</DIV>
<HR>
<P style="height:1px">
<DIV id="footer" style="vertical-align:bottom;text-align:center;">
<I>Home pages for:</I>
<A HREF = "http://jsoc.stanford.edu/"><B>SDO-JSOC</B></A>
<B>|</B>
<A HREF = "http://sha.stanford.edu/"><B>SHA</B></A>
</DIV>
</BODY>
</HTML>

